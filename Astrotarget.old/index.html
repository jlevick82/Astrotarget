<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Astro Target Planner (Single-File)</title>
  <style>
    :root { --fg:#0f172a; --muted:#64748b; --accent:#1a73e8; --ok:#34a853; --warn:#c5221f; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; color: var(--fg); margin: 0; background: #f8fafc; }
    .wrap { max-width: 820px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 22px; margin: 8px 0 4px; }
    p.sub { margin: 0 0 12px; color: var(--muted); font-size: 13px; }
    .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 14px; padding: 14px; margin: 12px 0; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px; }
    input[type="text"], input[type="number"], input[type="datetime-local"] { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 14px; background: #fff; }
    input[disabled] { background: #f1f5f9; color: #94a3b8; }
    .btn { border: none; border-radius: 10px; padding: 8px 10px; font-weight: 600; cursor: pointer; }
    .btn.primary { background: var(--accent); color: #fff; }
    .btn.ghost { background: #e6eefc; color: var(--accent); }
    .btn.ok { background: #e8f5ee; color: #256c3e; }
    .btn.warn { background: #fde8e7; color: #8b1d18; }
    .pill { font-size: 11px; padding: 3px 8px; border-radius: 999px; background: #f1f5f9; }
    .target { border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; margin-top: 10px; background: #fff; }
    .target.dim { opacity: .55; }
    .topbar { display:flex; align-items:center; justify-content: space-between; }
    .fav { font-size: 18px; background: none; border: none; cursor: pointer; }
    .muted { color: var(--muted); font-size: 12px; }
    .hint { font-size: 12px; color: var(--muted); }
    #err { white-space: pre-wrap; background:#fff3cd; border:1px solid #ffeeba; color:#856404; padding:8px; border-radius:8px; display:none; }
  </style>

  <!-- React & ReactDOM (pinned versions) -->
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>

  <!-- Babel for inline JSX (with presets!) -->
  <script src="https://unpkg.com/@babel/standalone@7.25.7/babel.min.js"></script>

  <!-- Astronomy Engine (UMD) -->
  <script src="https://unpkg.com/astronomy-engine@2.2.2/astronomy.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div id="err"></div>
  </div>
  <div id="root" class="wrap"></div>

  <!-- The app -->
  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useMemo } = React;
    const { Observer, MakeTime, Equator, Horizon, Illumination, Body } = Astronomy;

    const fovDeg = (s, f) => (57.2958 * s) / f;
    const pixelScale = (p, f) => (206.265 * p) / f;
    const raHtoDeg = h => h * 15;
    const iso = d => { const pad = n => String(n).padStart(2,"0"); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; };
    const minutesBetween = (a,b) => Math.max(0,Math.round((b-a)/60000));
    const clock = d => d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

    const DSO = {
      "Sh2-101 (Tulip)": { ra:20.0, dec:35.3, type:"Emission" },
      "IC 1396A (Elephant's Trunk)": { ra:21.65, dec:57.5, type:"Emission" },
      "Melotte 15 (Heart core)": { ra:2.55, dec:61.5, type:"Emission" },
      "IC 1848 (Soul core)": { ra:2.87, dec:60.4, type:"Emission" },
      "NGC 7635 (Bubble)": { ra:23.345, dec:61.2, type:"Emission" }
    };

    function altAt(d,lat,lon,ra,dec){
      const obs=new Observer(lat,lon,0), j=MakeTime(d);
      const eq=new Equator(raHtoDeg(ra),dec,2000,"OfDate",j);
      return Horizon(j,obs,eq.ra,eq.dec,"normal").altitude;
    }
    function bestAlt(start,end,lat,lon,ra,dec){
      let bestAlt=-90, best=start;
      for(let t=new Date(start); t<=end; t=new Date(t.getTime()+5*60000)){
        const a=altAt(t,lat,lon,ra,dec);
        if(a>bestAlt){bestAlt=a;best=new Date(t);}
      }
      return {time:best,alt:bestAlt};
    }
    function suggestExp(kind,bortle,f){
      if(kind==="Emission"){
        if(bortle<=4) return Math.round(180*(5.6/f));
        if(bortle<=6) return Math.round(240*(5.6/f));
        return Math.round(300*(5.6/f));
      }
      if(bortle<=4) return Math.round(120*(5.6/f));
      if(bortle<=6) return Math.round(90*(5.6/f));
      return Math.round(60*(5.6/f));
    }

    function App(){
      const [useGPS,setUseGPS]=useState(true),[lat,setLat]=useState(null),[lon,setLon]=useState(null);
      const [focal,setFocal]=useState(448),[pixel,setPixel]=useState(3.76),[sensor,setSensor]=useState(11.31),[fRatio,setFRatio]=useState(5.6);
      const now=new Date();
      const [startISO,setStart]=useState(iso(new Date(now.getFullYear(),now.getMonth(),now.getDate(),22,45)));
      const [endISO,setEnd]=useState(iso(new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,4,15)));
      const [minAlt,setMinAlt]=useState(35),[bortle,setBortle]=useState(6),[staticExp,setStatic]=useState(240);
      const [gain,setGain]=useState(100),[offset,setOffset]=useState(50);

      const [status,setStatusMap]=useState(()=>JSON.parse(localStorage.getItem("astro_status")||"{}"));
      const [fav,setFav]=useState(()=>JSON.parse(localStorage.getItem("astro_favs")||"{}"));
      useEffect(()=>localStorage.setItem("astro_status",JSON.stringify(status)),[status]);
      useEffect(()=>localStorage.setItem("astro_favs",JSON.stringify(fav)),[fav]);

      useEffect(()=>{
        if(!useGPS) return;
        if(!navigator.geolocation) return setUseGPS(false);
        navigator.geolocation.getCurrentPosition(p=>{setLat(p.coords.latitude);setLon(p.coords.longitude)},()=>setUseGPS(false));
      },[useGPS]);

      const fov=useMemo(()=>fovDeg(sensor,focal),[sensor,focal]);
      const scale=useMemo(()=>pixelScale(pixel,focal),[pixel,focal]);

      const cands=useMemo(()=>{
        if(lat==null||lon==null) return [];
        const start=new Date(startISO), end=new Date(endISO);
        return Object.entries(DSO).map(([name,v])=>{
          let first=null, last=null;
          for(let t=new Date(start); t<=end; t=new Date(t.getTime()+5*60000)){
            const a=altAt(t,lat,lon,v.ra,v.dec);
            if(a>=minAlt){ if(!first) first=new Date(t); last=new Date(t); }
          }
          const best=bestAlt(start,end,lat,lon,v.ra,v.dec);
          const usable=(first&&last)?minutesBetween(first,last):0;
          const moonPct=Math.round(Illumination(Body.Moon,MakeTime(best.time)).phase_fraction*100);
          const exp=staticExp ?? suggestExp(v.type,bortle,fRatio);
          return {name,v,first,last,usable,best,moonPct,exp,
                  framesPerHour:Math.floor(3600/(exp+10+15/3)),
                  status: (JSON.parse(localStorage.getItem("astro_status")||"{}")[name]) || "none",
                  fav: !!(JSON.parse(localStorage.getItem("astro_favs")||"{}")[name])};
        }).filter(t=>t.usable>=60)
          .sort((a,b)=>(Number(b.fav)-Number(a.fav)) || (a.best.time-b.best.time));
      },[lat,lon,startISO,endISO,minAlt,bortle,fRatio,staticExp]);

      const toggleFav=n=>{ setFav(p=>({...p,[n]:!p[n]})); };
      const setSt=(n,s)=>{ setStatusMap(p=>({...p,[n]:s})); };

      const exportPlan=()=>{
        if(lat==null||lon==null) return;
        const targets=cands.filter(t=> (status[t.name]||"none")==="add").map(t=>({
          name:t.name,
          constraints:{ start:t.first.toISOString(), end:t.last.toISOString(), altitude_min_deg:minAlt },
          notes:`${t.v.type}; exposure ${t.exp}s; frames/hr ~${t.framesPerHour}`,
          camera:{ gain, offset }, exposure_s:t.exp, favorite:!!fav[t.name]
        }));
        const seq={ type:"MobilePlan",
          profile:{ camera:"ASI533MC Pro", mount:"iEXOS-100", guider:"PHD2", filter:"Dual-NB", reducer:"SVBONY 0.8x",
            fov_deg:[+fov.toFixed(2),+fov.toFixed(2)], pixel_scale_arcsec_per_px:+scale.toFixed(2), location:{lat,lon} },
          defaults:{ dither_every:3, settle_px:1.5, settle_s:15, center_tolerance_arcsec:15, recenter_every_minutes:20, recenter_every_frames:5, hfr_autofocus_increase:0.10 },
          targets };
        const blob=new Blob([JSON.stringify(seq,null,2)],{type:"application/json"});
        const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="astro_mobile_plan.json"; a.click();
      };

      return (
        <div className="wrap">
          <h1>Astro Target Planner</h1>
          <p className="sub">GPS shortlist → exposures → export JSON. Single HTML file.</p>

          <div className="card">
            <div className="row"><strong>Location & session</strong>
              <label><input type="checkbox" checked={useGPS} onChange={e=>setUseGPS(e.target.checked)} /> Use GPS</label></div>
            <div className="grid2" style={{marginTop:8}}>
              <div><label>Latitude</label><input type="number" step="0.0001" value={lat??""} onChange={e=>setLat(+e.target.value)} disabled={useGPS}/></div>
              <div><label>Longitude</label><input type="number" step="0.0001" value={lon??""} onChange={e=>setLon(+e.target.value)} disabled={useGPS}/></div>
              <div><label>Start (local)</label><input type="datetime-local" value={startISO} onChange={e=>setStart(e.target.value)}/></div>
              <div><label>End (local)</label><input type="datetime-local" value={endISO} onChange={e=>setEnd(e.target.value)}/></div>
              <div><label>Min altitude (°)</label><input type="number" value={minAlt} onChange={e=>setMinAlt(+e.target.value)}/></div>
              <div><label>Bortle</label><input type="number" value={bortle} min="1" max="9" onChange={e=>setBortle(+e.target.value)}/></div>
            </div>
          </div>

          <div className="card">
            <strong>Your gear</strong>
            <div className="grid2" style={{marginTop:8}}>
              <div><label>Focal length (mm)</label><input type="number" value={focal} onChange={e=>setFocal(+e.target.value)}/></div>
              <div><label>Pixel size (µm)</label><input type="number" step="0.01" value={pixel} onChange={e=>setPixel(+e.target.value)}/></div>
              <div><label>Sensor size (mm)</label><input type="number" step="0.01" value={sensor} onChange={e=>setSensor(+e.target.value)}/></div>
              <div><label>f/ ratio</label><input type="number" step="0.1" value={fRatio} onChange={e=>setFRatio(+e.target.value)}/></div>
            </div>
            <div className="muted">FoV ≈ {fov.toFixed(2)}° × {fov.toFixed(2)}° • Scale ≈ {scale.toFixed(2)}″/px</div>
          </div>

          <div className="card">
            <div className="row"><strong>Candidates (≥ {minAlt}° & ≥ 60 min)</strong>
              <div><label style={{fontSize:12}}>Static exp (s)</label>
                <input style={{width:90}} type="number" value={staticExp??""} onChange={e=>setStatic(e.target.value===""?null:+e.target.value)}/></div>
            </div>
            <div id="candidates">
              {/* Filled below via map */}
            </div>
            {/* Render candidate list */}
            {cands.length===0 && <div className="muted" style={{marginTop:8}}>No matches yet—check GPS/lat/lon, time window, or min altitude.</div>}
            {cands.map(t=>
              <div key={t.name} className={`target ${t.status==="skip"?"dim":""}`}>
                <div className="topbar">
                  <div style={{display:"flex",alignItems:"center",gap:8}}>
                    <button className="fav" onClick={()=>toggleFav(t.name)}>{t.fav?"⭐":"☆"}</button>
                    <strong>{t.name}</strong>
                  </div>
                  <span className="pill">{t.v.type}</span>
                </div>
                <div>Best: <b>{clock(t.best.time)}</b> @ {t.best.alt.toFixed(0)}° • Usable: {t.usable} min • Moon: {t.moonPct}%</div>
                <div>Exp: <b>{t.exp}s</b> • ~{t.framesPerHour} f/hr</div>
                <div className="muted">Window: {t.first?clock(t.first):"--"} – {t.last?clock(t.last):"--"}</div>
                <div className="row" style={{gap:6,marginTop:6,justifyContent:"flex-start"}}>
                  <button className={`btn ${t.status==="add"?"primary":"ghost"}`} onClick={()=>setSt(t.name,"add")}>Add</button>
                  <button className={`btn ${t.status==="imaged"?"ok":"ghost"}`} onClick={()=>setSt(t.name,"imaged")}>Imaged</button>
                  <button className={`btn ${t.status==="skip"?"warn":"ghost"}`} onClick={()=>setSt(t.name,"skip")}>Skip</button>
                  <button className="btn" style={{background:"#f1f5f9"}} onClick={()=>setSt(t.name,"none")}>Clear</button>
                </div>
              </div>
            )}
            <div className="row" style={{marginTop:8}}>
              <span className="muted">Export includes Add-marked only. Favorites pin to top.</span>
              <button className="btn primary" onClick={exportPlan}>Export JSON plan</button>
            </div>
          </div>

          <div className="hint">Tip: Add this page to your home screen. Status & favorites persist locally.</div>
        </div>
      );
    }

    // Render with a catch-all error surface so you see issues on-page.
    try {
      ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
    } catch (e) {
      const el = document.getElementById("err");
      el.style.display = "block";
      el.textContent = "Render error:\\n" + (e && e.message ? e.message : e);
      console.error(e);
    }
  </script>
</body>
</html>
