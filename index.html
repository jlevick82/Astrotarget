<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AstroTarget v0.9.0 ‚Äì Field Ready</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background:#0b0c10; color:#fff; font-family:Arial, sans-serif; padding:15px; }
    h1 { color:#66fcf1; text-align:center; }
    #version { text-align:center; font-size:14px; color:#aaa; margin-bottom:10px; }
    select, input, button { margin:8px; padding:6px; font-size:15px; }
    .card {
      background:#1f2833; border:1px solid #45a29e; border-radius:8px;
      padding:12px; margin:10px 0;
    }
    img { max-width:100%; border-radius:5px; margin-top:5px; }
    #controls { background:#1b1f24; padding:10px; border-radius:6px; margin-bottom:12px; }
    #moonCard, #clockCard, #weatherCard, #lpCard { background:#0e1a22; border:1px solid #ffcc00; padding:10px; margin-bottom:10px; border-radius:8px; }
    #scopeConfirm { color:#00ff99; font-size:14px; margin-left:10px; display:none; }
    #cacheConfirm { color:#00ff99; font-size:14px; margin-left:10px; display:none; }
    .modal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.8); justify-content:center; align-items:center;
    }
    .modal-content {
      background:#1f2833; padding:20px; border-radius:8px; max-width:90%; max-height:90%; overflow-y:auto;
    }
  </style>
</head>
<body>
  <h1>üî≠ AstroTarget</h1>
  <div id="version">v0.9.0 ‚Äì Field Ready</div>

  <!-- Info cards -->
  <div id="moonCard">üåô Loading Moon data...</div>
  <div id="clockCard">‚è∞ GPS Time: --:--:--</div>
  <div id="weatherCard">üå§ Weather: Loading...</div>
  <div id="lpCard">üåå Light Pollution: Loading...</div>

  <!-- Controls -->
  <div id="controls">
    <p>
      Catalog: 
      <select id="catalogChoice" onchange="updateCatalog()">
        <option value="messier">Messier</option>
        <option value="caldwell">Caldwell</option>
        <option value="ngc">Bright NGC</option>
        <option value="all">All</option>
        <option value="pro">Pro Mode</option>
      </select>
      <button onclick="computeTargets(currentLat,currentLon)">üîÑ Refresh</button>
    </p>
    <p>
      Search: 
      <input type="text" id="searchBox" placeholder="Type object name..." oninput="computeTargets(currentLat,currentLon)">
      <br>
      <label><input type="checkbox" id="searchAll" onchange="computeTargets(currentLat,currentLon)"> Search across all catalogs</label>
    </p>
    <p>
      Min Altitude: <input type="range" id="minAlt" min="0" max="60" step="5" value="30" oninput="document.getElementById('minAltVal').innerText=this.value"> <span id="minAltVal">30</span>¬∞ <br>
      Max Magnitude: <input type="range" id="maxMag" min="5" max="15" step="0.5" value="11" oninput="document.getElementById('maxMagVal').innerText=this.value"> <span id="maxMagVal">11</span>
    </p>
    <p>
      Show Types: 
      <label><input type="checkbox" id="showGalaxies" checked> Galaxies</label>
      <label><input type="checkbox" id="showClusters" checked> Clusters</label>
      <label><input type="checkbox" id="showNebulae" checked> Nebulae</label>
      <label><input type="checkbox" id="showStars" checked> Stars</label>
    </p>
    <p>
      Telescope FL (mm): <input type="number" id="focalLength" value="800" style="width:70px;" onchange="scopeApplied()"> 
      Camera Sensor (mm): <input type="number" id="sensorSize" value="22" style="width:60px;" onchange="scopeApplied()">
      <span id="scopeConfirm">Scope settings applied ‚úÖ</span>
    </p>
    <p>
      Plan for date/time: 
      <input type="datetime-local" id="planTime" onchange="computeTargets(currentLat,currentLon)">
    </p>
    <p>
      <label><input type="checkbox" id="scopeFilterTop" checked onchange="computeTargets(currentLat,currentLon)"> Apply scope filter to Top Picks</label>
    </p>
    <p>
      <label><input type="checkbox" id="cacheImages" onchange="cacheMyImages()"> Cache images (scope FOV only)</label>
      <span id="cacheConfirm">Caching started...</span>
    </p>
  </div>

  <p id="status">Fetching location and calculating...</p>
  <div id="results"></div>

  <!-- Modal for object details -->
  <div id="detailModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" id="modalContent"></div>
  </div>

  <!-- Catalogs -->
  <script src="messier.js"></script>
  <script src="caldwell.js"></script>
  <script src="brightngc.js"></script>
  <script>
  let currentLat = 40, currentLon = 0;

  // =====================
  // Math utilities
  // =====================
  function toRadians(deg){return deg*Math.PI/180;}
  function toDegrees(rad){return rad*180/Math.PI;}

  function radecToAlt(raHours, decDeg, lat, lon, date) {
    const ra = raHours * 15;
    const lst = getLST(lon, date);
    const ha = (lst - ra + 360) % 360;
    const haRad = toRadians(ha);
    const decRad = toRadians(decDeg);
    const latRad = toRadians(lat);
    const sinAlt = Math.sin(decRad) * Math.sin(latRad) +
                   Math.cos(decRad) * Math.cos(latRad) * Math.cos(haRad);
    return toDegrees(Math.asin(sinAlt));
  }

  function getLST(lon, date){
    const JD = (date.getTime()/86400000)+2440587.5;
    const D = JD-2451545.0;
    let GMST = 280.46061837 + 360.98564736629*D;
    GMST=(GMST%360+360)%360;
    const LST=GMST+lon;
    return (LST%360+360)%360;
  }

  // =====================
  // Moon calculations
  // =====================
  function getMoonInfo(date, lat, lon){
    const lp = (218.316 + 13.176396* ((date/86400000)+2440587.5 -2451545.0)) % 360;
    const m = (357.529 + 0.98560028*((date/86400000)+2440587.5 -2451545.0)) % 360;
    const mp = (134.963 + 13.064993*((date/86400000)+2440587.5 -2451545.0)) % 360;
    const phase = (1 - Math.cos(toRadians(m - mp)))/2;
    const alt = radecToAlt((lp/15), 5, lat, lon, new Date(date));
    return {phase:(phase*100).toFixed(1)+"%", alt:alt.toFixed(1)};
  }

  function updateMoon(){
    const now = new Date();
    const moon = getMoonInfo(now.getTime(), currentLat, currentLon);
    let rating="üåë Excellent";
    const illum=parseFloat(moon.phase);
    if(illum>50) rating="üåì Fair";
    if(illum>80) rating="üåï Poor";
    document.getElementById("moonCard").innerHTML =
      `üåô Moon Phase: ${moon.phase}<br>Altitude: ${moon.alt}¬∞<br>Dark Sky: ${rating}`;
  }

  // =====================
  // GPS Clock
  // =====================
  function startClock(){
    setInterval(()=>{
      const now=new Date();
      const h=String(now.getHours()).padStart(2,'0');
      const m=String(now.getMinutes()).padStart(2,'0');
      const s=String(now.getSeconds()).padStart(2,'0');
      document.getElementById("clockCard").innerText=`‚è∞ GPS Time: ${h}:${m}:${s}`;
    },1000);
  }

  // =====================
  // Constellation lookup (simple)
  // =====================
  function getConstellation(ra){
    const h = ra; 
    if(h<2) return "Pisces";
    if(h<4) return "Aries/Taurus";
    if(h<6) return "Orion";
    if(h<8) return "Gemini";
    if(h<10) return "Leo";
    if(h<12) return "Virgo";
    if(h<14) return "Bootes";
    if(h<16) return "Hercules";
    if(h<18) return "Lyra/Cygnus";
    if(h<20) return "Aquila";
    if(h<22) return "Pegasus";
    return "Andromeda";
  }

  // =====================
  // Weather + Light Pollution
  // =====================
  function updateWeather(){
    if(!navigator.onLine){
      document.getElementById("weatherCard").innerText="üå§ Weather: Not available offline";
      return;
    }
    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLon}&hourly=cloudcover`)
      .then(r=>r.json())
      .then(data=>{
        const clouds=data.hourly.cloudcover[0];
        let msg="Clear";
        if(clouds>50) msg="Cloudy";
        if(clouds>20 && clouds<=50) msg="Partly cloudy";
        document.getElementById("weatherCard").innerText=`üå§ Weather: ${msg} (${clouds}% clouds)`;
      }).catch(()=>{
        document.getElementById("weatherCard").innerText="üå§ Weather: Not available";
      });
  }

  function updateLightPollution(){
    if(!navigator.onLine){
      document.getElementById("lpCard").innerText="üåå Light Pollution: Not available offline";
      return;
    }
    // Placeholder: show fixed message (API hook can be added later)
    document.getElementById("lpCard").innerText="üåå Light Pollution: Bortle ~5 (estimate)";
  }

  // =====================
  // Filters & Suitability
  // =====================
  function passesFilters(obj, alt, mag){
    const minAlt = parseFloat(document.getElementById("minAlt").value);
    const maxMag = parseFloat(document.getElementById("maxMag").value);
    const type = obj.type.toLowerCase();

    if(alt < minAlt) return false;
    if(mag > maxMag) return false;

    if(type.includes("galaxy") && !document.getElementById("showGalaxies").checked) return false;
    if((type.includes("cluster")||type.includes("globular")) && !document.getElementById("showClusters").checked) return false;
    if(type.includes("nebula") && !document.getElementById("showNebulae").checked) return false;
    if(type.includes("star") && !document.getElementById("showStars").checked) return false;

    return true;
  }

  function fovCheck(objSize){
    const fl = parseFloat(document.getElementById("focalLength").value);
    const sensor = parseFloat(document.getElementById("sensorSize").value);
    if(isNaN(fl) || isNaN(sensor)) return "";

    const fov = (sensor / fl) * (57.3*60);
    const sizeVal = parseFloat(objSize);
    if(isNaN(sizeVal)) return "";

    if(sizeVal < fov*0.2) return "‚ùå Too small";
    if(sizeVal > fov*1.5) return "‚ö†Ô∏è Too big";
    return "‚úÖ Fits";
  }

  function scopeApplied(){
    const c=document.getElementById("scopeConfirm");
    c.style.display="inline";
    setTimeout(()=>{c.style.display="none";},2000);
    computeTargets(currentLat,currentLon);
  }

  // =====================
  // Deduplicate catalogs
  // =====================
  function mergeCatalogs(...cats){
    const unique = [];
    const seen = new Set();
    cats.flat().forEach(obj=>{
      const key = `${Math.round(obj.ra*10)/10},${Math.round(obj.dec*10)/10}`;
      if(!seen.has(key)){
        seen.add(key);
        unique.push(obj);
      }
    });
    return unique;
  }
  // =====================
  // Catalog selection
  // =====================
  function getActiveCatalog(){
    const choice=document.getElementById("catalogChoice").value;
    if(choice==="messier") return messier;
    if(choice==="caldwell") return caldwell;
    if(choice==="ngc") return brightngc;
    if(choice==="all") return mergeCatalogs(messier, caldwell, brightngc);
    if(choice==="pro"){ 
      alert("üöÄ Pro Mode coming soon! Extended catalogs will be added.");
      return mergeCatalogs(catalog, caldwell, brightngc);
    }
    return catalog;
  }

  // =====================
  // Main compute function
  // =====================
  function computeTargets(lat, lon){
    const nowInput = document.getElementById("planTime").value;
    const now = nowInput ? new Date(nowInput) : new Date();
    updateMoon();
    updateWeather();
    updateLightPollution();

    const query = document.getElementById("searchBox").value.toLowerCase();
    const searchAll = document.getElementById("searchAll").checked;

    let activeCatalog = searchAll 
      ? mergeCatalogs(catalog, caldwell, brightngc)
      : getActiveCatalog();

    // üåü Top Picks (with optional scope filter)
    let allCatalog = mergeCatalogs(catalog, caldwell, brightngc);
    let topPicks=[];
    allCatalog.forEach(obj=>{
      const alt=radecToAlt(obj.ra,obj.dec,lat,lon,now);
      if(passesFilters(obj,alt,obj.mag)){
        const fov=fovCheck(obj.size);
        if(document.getElementById("scopeFilterTop").checked){
          if(fov==="‚úÖ Fits") topPicks.push({...obj,alt:alt.toFixed(1)});
        } else {
          topPicks.push({...obj,alt:alt.toFixed(1)});
        }
      }
    });
    topPicks.sort((a,b)=>{
      if(b.alt !== a.alt) return b.alt - a.alt;
      return a.mag - b.mag;
    });

    let out="";

    if(topPicks.length>0){
      out += `<div class="card" style="background:#0e1a22;border:2px solid #ffcc00;">
        <h2>üåü Tonight‚Äôs Top ${Math.min(5,topPicks.length)} Targets</h2>`;
      topPicks.slice(0,5).forEach(obj=>{
        out += `<p><b>${obj.name}</b> (${obj.type}) ‚Äì Mag ${obj.mag}, Alt ${obj.alt}¬∞</p>`;
      });
      out += `</div>`;
    }

    // üìÑ Full list
    let visible=[];
    activeCatalog.forEach(obj=>{
      const alt=radecToAlt(obj.ra,obj.dec,lat,lon,now);
      if(passesFilters(obj,alt,obj.mag)){
        if(query==="" || obj.name.toLowerCase().includes(query)){
          visible.push({...obj,alt:alt.toFixed(1)});
        }
      }
    });

    visible.sort((a,b)=>{
      if(b.alt !== a.alt) return b.alt - a.alt;
      return a.mag - b.mag;
    });

    out += `<p><i>Showing ${visible.length} objects from selected catalog</i></p>`;

    if(visible.length===0) out+="<p>No objects match your filters.</p>";
    else visible.forEach(obj=>{
      const img = obj.img ? `<img src="${obj.img}" alt="${obj.name}">` : "";
      out+=`<div class="card" onclick="showDetails('${obj.name}', '${obj.type}', ${obj.ra}, ${obj.dec}, ${obj.mag}, '${obj.size}')">
        <h2>${obj.name}</h2>
        <p>Type: ${obj.type}<br>
        Mag: ${obj.mag} | Size: ${obj.size}<br>
        Altitude now: ${obj.alt}¬∞<br>
        Constellation: ${getConstellation(obj.ra)}<br>
        FOV Check: ${fovCheck(obj.size)}</p>
        ${img}
      </div>`;
    });

    document.getElementById("results").innerHTML=out;
  }

  // =====================
  // Popup details
  // =====================
  function showDetails(name,type,ra,dec,mag,size){
    const modal=document.getElementById("detailModal");
    const c=document.getElementById("modalContent");
    c.innerHTML=`<h2>${name}</h2>
      <p>Type: ${type}<br>
      RA: ${ra.toFixed(2)}h | Dec: ${dec.toFixed(2)}¬∞ (J2000)<br>
      Mag: ${mag} | Size: ${size}<br>
      Constellation: ${getConstellation(ra)}<br>
      <a href="https://en.wikipedia.org/wiki/${encodeURIComponent(name.split("‚Äì")[0].trim())}" target="_blank">üìñ Wikipedia</a></p>`;
    modal.style.display="flex";
  }

  // =====================
  // Image caching
  // =====================
  function cacheMyImages(){
    const box=document.getElementById("cacheImages");
    const confirm=document.getElementById("cacheConfirm");
    if(!box.checked) return;

    let urls=[];
    mergeCatalogs(catalog, caldwell, brightngc).forEach(obj=>{
      if(obj.img && fovCheck(obj.size)==="‚úÖ Fits"){
        urls.push(obj.img);
      }
    });

    if('serviceWorker' in navigator && navigator.serviceWorker.controller){
      navigator.serviceWorker.controller.postMessage({action:"cache", files:urls});
      confirm.style.display="inline";
      setTimeout(()=>{confirm.style.display="none";},3000);
    }
  }

  // =====================
// =====================
// Location handling + init
// =====================
function updateCatalog(){
  computeTargets(currentLat,currentLon);
}

startClock();  // <-- add this so the clock always runs

if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(pos=>{
    currentLat=pos.coords.latitude;
    currentLon=pos.coords.longitude;
    document.getElementById("status").innerText="Location detected ‚úÖ";
    updateCatalog();
  },err=>{
    document.getElementById("status").innerText="‚ö†Ô∏è Location denied. Using default (40¬∞N,0¬∞E).";
    updateCatalog();
  });
} else {
  document.getElementById("status").innerText="‚ö†Ô∏è GPS not available. Using default (40¬∞N,0¬∞E).";
  updateCatalog();
}


  // Register Service Worker
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("service-worker.js");
  }
  </script>
</body>
</html>
