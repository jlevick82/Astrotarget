<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AstroTarget v0.9.0 ‚Äì Field Ready</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background:#0b0c10; color:#fff; font-family:Arial, sans-serif; padding:15px; }
    h1 { color:#66fcf1; text-align:center; }
    #version { text-align:center; font-size:14px; color:#aaa; margin-bottom:10px; }
    select, input, button { margin:8px; padding:6px; font-size:15px; }
    .card {
      background:#1f2833; border:1px solid #45a29e; border-radius:8px;
      padding:12px; margin:10px 0;
    }
    img { max-width:100%; border-radius:5px; margin-top:5px; }
    #controls { background:#1b1f24; padding:10px; border-radius:6px; margin-bottom:12px; }
    #moonCard, #clockCard, #weatherCard, #lpCard { background:#0e1a22; border:1px solid #ffcc00; padding:10px; margin-bottom:10px; border-radius:8px; }
    #scopeConfirm { color:#00ff99; font-size:14px; margin-left:10px; display:none; }
    #cacheConfirm { color:#00ff99; font-size:14px; margin-left:10px; display:none; }
    .modal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.8); justify-content:center; align-items:center;
    }
    .modal-content {
      background:#1f2833; padding:20px; border-radius:8px; max-width:90%; max-height:90%; overflow-y:auto;
    }
  </style>
</head>
<body>
  <h1>üî≠ AstroTarget</h1>
  <div id="version">v0.9.0 ‚Äì Field Ready</div>

  <!-- Info cards -->
  <div id="moonCard">üåô Loading Moon data...</div>
  <div id="clockCard">‚è∞ GPS Time: --:--:--</div>
  <div id="weatherCard">üå§ Weather: Loading...</div>
  <div id="lpCard">üåå Light Pollution: Loading...</div>

  <!-- Controls -->
  <div id="controls">
    <p>
      Catalog: 
      <select id="catalogChoice" onchange="updateCatalog()">
        <option value="messier">Messier</option>
        <option value="caldwell">Caldwell</option>
        <option value="ngc">Bright NGC</option>
        <option value="all">All</option>
        <option value="pro">Pro Mode</option>
      </select>
      <button onclick="computeTargets(currentLat,currentLon)">üîÑ Refresh</button>
    </p>
    <p>
      Search: 
      <input type="text" id="searchBox" placeholder="Type object name..." oninput="computeTargets(currentLat,currentLon)">
      <br>
      <label><input type="checkbox" id="searchAll" onchange="computeTargets(currentLat,currentLon)"> Search across all catalogs</label>
    </p>
    <p>
      Min Altitude: <input type="range" id="minAlt" min="0" max="60" step="5" value="30" oninput="document.getElementById('minAltVal').innerText=this.value"> <span id="minAltVal">30</span>¬∞ <br>
      Max Magnitude: <input type="range" id="maxMag" min="5" max="15" step="0.5" value="11" oninput="document.getElementById('maxMagVal').innerText=this.value"> <span id="maxMagVal">11</span>
    </p>
    <p>
      Show Types: 
      <label><input type="checkbox" id="showGalaxies" checked> Galaxies</label>
      <label><input type="checkbox" id="showClusters" checked> Clusters</label>
      <label><input type="checkbox" id="showNebulae" checked> Nebulae</label>
      <label><input type="checkbox" id="showStars" checked> Stars</label>
    </p>
    <p>
      Telescope FL (mm): <input type="number" id="focalLength" value="800" style="width:70px;" onchange="scopeApplied()"> 
      Camera Sensor (mm): <input type="number" id="sensorSize" value="22" style="width:60px;" onchange="scopeApplied()">
      <span id="scopeConfirm">Scope settings applied ‚úÖ</span>
    </p>
    <p>
      Plan for date/time: 
      <input type="datetime-local" id="planTime" onchange="computeTargets(currentLat,currentLon)">
    </p>
    <p>
      <label><input type="checkbox" id="scopeFilterTop" checked onchange="computeTargets(currentLat,currentLon)"> Apply scope filter to Top Picks</label>
    </p>
    <p>
      <label><input type="checkbox" id="cacheImages" onchange="cacheMyImages()"> Cache images (scope FOV only)</label>
      <span id="cacheConfirm">Caching started...</span>
    </p>
  </div>

  <p id="status">Fetching location and calculating...</p>
  <div id="results"></div>

  <!-- Modal for object details -->
  <div id="detailModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" id="modalContent"></div>
  </div>

  <!-- Catalog scripts -->
  <script src="messier.js"></script>
  <script src="caldwell.js"></script>
  <script src="brightngc.js"></script>

  <!-- AstroTarget logic -->
  <script>
    let currentLat = 40, currentLon = 0;

    // ... (keep all the JS logic from Part 2 + Part 3 we built earlier)
    // Make sure you have startClock() called unconditionally near the bottom:

    function updateCatalog(){
      computeTargets(currentLat,currentLon);
    }

    startClock(); // Always run clock, even if GPS blocked

    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        currentLat=pos.coords.latitude;
        currentLon=pos.coords.longitude;
        document.getElementById("status").innerText="Location detected ‚úÖ";
        updateCatalog();
      },err=>{
        document.getElementById("status").innerText="‚ö†Ô∏è Location denied. Using default (40¬∞N,0¬∞E).";
        updateCatalog();
      });
    } else {
      document.getElementById("status").innerText="‚ö†Ô∏è GPS not available. Using default (40¬∞N,0¬∞E).";
      updateCatalog();
    }

    // Service Worker
    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>
</body>
</html>
