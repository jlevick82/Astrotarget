<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Nightly Go/No-Go — AstroTarget</title>
<meta name="theme-color" content="#0b1020"/>
<style>
:root{
  --bg:#0b1020; --card:#111a28; --edge:#233245;
  --text:#dfe9ff; --muted:#9ab0cc; --accent:#63a3ff;
  --pill:#0f1724; --pill-edge:#223149;
  --good:#1a6a3a; --warn:#a27a20; --bad:#9a2b2b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);
  font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
.wrap{max-width:980px;margin:0 auto;padding:18px 14px 80px}

/* header */
.hdr{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.logoBox{width:36px;height:36px;border-radius:9px;overflow:hidden;border:1px solid var(--edge);flex:0 0 36px}
.appicon{width:100%;height:100%;object-fit:cover;background:#0002}
.title{display:flex;flex-direction:column}
.brand{font-weight:800;font-size:26px;letter-spacing:.2px;line-height:1}
.sub{opacity:.7;font-weight:600}
.actions{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap}
.btn{appearance:none;border:1px solid var(--pill-edge);background:var(--pill);
  color:var(--text); padding:9px 12px;border-radius:12px;font-weight:600}
.btn:active{transform:translateY(1px)}
.badge{display:inline-block;padding:7px 10px;border-radius:11px;border:1px solid}
.badge.go{background:#0c1a13;border-color:#1b5f3a;color:#a3ffce}
.badge.marginal{background:#1c1609;border-color:#8b6a1a;color:#ffe29e}
.badge.nogo{background:#1b0f10;border-color:#8f2f2f;color:#ffc5c5}

/* cards */
.card{background:var(--card);border:1px solid var(--edge);border-radius:14px;margin:12px 0;overflow:hidden}
.card .head{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--edge)}
.card .head h3{margin:0;font-size:18px}
.toggle{margin-left:auto; width:34px;height:28px;border-radius:10px;border:1px solid var(--pill-edge);background:var(--pill);color:var(--text);font-weight:900}
.body{padding:14px}
.collapsed .body{display:none}

/* layout bits */
.kv{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.big{font-size:28px;font-weight:800}
.tag{margin-top:6px;padding:8px 10px;border-radius:10px;background:var(--pill);border:1px solid var(--pill-edge);color:var(--muted);font-weight:600}
.smalllabel{font-size:12px;color:var(--muted);margin-bottom:4px}

/* chips */
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{border:1px solid var(--pill-edge);background:var(--pill);color:var(--text);
  padding:9px 12px;border-radius:12px;font-weight:700;cursor:pointer}
.chip.active{background:var(--accent);color:#0b1020;border-color:transparent}

/* table */
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid var(--edge);text-align:left}
thead th{color:var(--muted);font-weight:700}

/* toast */
#toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;
  background:#0f1a2a;border:1px solid var(--edge);color:var(--text);
  padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:opacity .2s}
#toast.show{opacity:1}

/* compact */
.compact .optional{display:none}
.compact .card .head{padding:10px}
.compact .body{padding:10px}
.compact .kv{gap:8px}

/* night (red safe) */
.night{
  --bg:#0b0706; --card:#130b09; --edge:#2b1a14;
  --text:#ffd9c7; --muted:#ffbba3; --accent:#ff7a45;
  --pill:#1a0f0c; --pill-edge:#2b1a14;
}
.night .badge.go{background:#111f18;border-color:#2e7e52;color:#a6ffd6}
.night .badge.marginal{background:#2c1e0a;border-color:#9a6a16;color:#ffe6a6}
.night .badge.nogo{background:#2a1212;border-color:#a33;color:#ffbaba}

/* banner */
.banner{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.banner .txt{flex:1;min-width:240px}
.banner time{color:var(--muted);font-weight:600}
</style>
</head>
<body>
<div class="wrap">
  <header class="hdr">
    <div class="logoBox"><img id="logo" class="appicon" alt="AstroTarget"/></div>
    <div class="title">
      <div class="brand">Nightly Go/No-Go <span id="ver" class="sub">v25.7</span></div>
    </div>
    <div class="actions">
      <button id="btnInstall" class="btn">Install</button>
      <button id="btnCompact" class="btn">Compact off</button>
      <button id="btnNight" class="btn">Night</button>
    </div>
  </header>

  <section class="card" id="statusCard">
    <div class="head"><h3>Status</h3><button class="toggle" data-t="statusCard">▾</button></div>
    <div class="body">
      <div class="banner">
        <span id="badge" class="badge">—</span>
        <div id="bannerText" class="txt">—</div>
        <time id="updated">Updated —</time>
      </div>
    </div>
  </section>

  <section class="card" id="sky">
    <div class="head"><h3>Sky conditions</h3><button class="toggle" data-t="sky">▾</button></div>
    <div class="body">
      <div class="kv">
        <div>
          <div class="smalllabel">Astronomical dark</div>
          <div class="big" id="astroYes">—</div>
          <div class="tag" id="astroVal">Sun alt —</div>
        </div>
        <div>
          <div class="smalllabel">Moon illum</div>
          <div class="big" id="moonPct">—</div>
          <div class="tag" id="moonAlt">Alt —</div>
        </div>
      </div>
    </div>
  </section>

  <section class="card" id="cloudsCard">
    <div class="head"><h3>Clouds (avg)</h3><button class="toggle" data-t="cloudsCard">▾</button></div>
    <div class="body">
      <input id="clouds" type="range" min="0" max="100" value="40" style="width:100%"/>
      <div class="tag">Use <button id="btnCalc" class="btn" style="padding:4px 10px;margin:0 6px">Calculate</button> to auto-fill from weather. Slider overrides clouds.</div>
    </div>
  </section>

  <section class="card" id="quick">
    <div class="head"><h3>Quick setup</h3><button class="toggle" data-t="quick">▾</button></div>
    <div class="body">
      <div class="kv">
        <div>
          <div class="smalllabel">Latitude (°)</div>
          <input id="lat" inputmode="decimal" style="width:100%;padding:10px;border-radius:12px;border:1px solid var(--edge);background:var(--pill);color:var(--text)"/>
        </div>
        <div>
          <div class="smalllabel">Longitude (°)</div>
          <input id="lon" inputmode="decimal" style="width:100%;padding:10px;border-radius:12px;border:1px solid var(--edge);background:var(--pill);color:var(--text)"/>
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="btnGPS" class="btn">Use GPS</button>
        <button id="btnDemo" class="btn optional">Demo</button>
        <button id="btnRecompute" class="btn">Calculate</button>
      </div>
    </div>
  </section>

  <section class="card" id="gear">
    <div class="head"><h3>Gear</h3><button class="toggle" data-t="gear">▾</button></div>
    <div class="body">
      <div class="kv">
        <div>
          <div class="smalllabel">Scope</div>
          <select id="scope" style="width:100%;padding:10px;border-radius:12px;border:1px solid var(--edge);background:var(--pill);color:var(--text)"></select>
        </div>
        <div>
          <div class="smalllabel">Reducer / Barlow</div>
          <div id="chips" class="chips"></div>
        </div>
        <div>
          <div class="smalllabel">Camera</div>
          <select id="camera" style="width:100%;padding:10px;border-radius:12px;border:1px solid var(--edge);background:var(--pill);color:var(--text)"></select>
        </div>
        <div>
          <div class="smalllabel">FOV &amp; Scale</div>
          <div class="tag" id="fov">FOV —</div>
          <div class="tag" id="scale" style="margin-top:10px">Scale —</div>
        </div>
      </div>

      <!-- named setup presets -->
      <div style="display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap">
        <input id="presetName" placeholder="Preset name" style="flex:1;min-width:160px;padding:9px;border-radius:12px;border:1px solid var(--edge);background:var(--pill);color:var(--text)"/>
        <button id="btnSavePreset" class="btn">Save preset</button>
        <select id="presetList" style="flex:1;min-width:180px;padding:9px;border-radius:12px;border:1px solid var(--edge);background:var(--pill);color:var(--text)">
          <option value="">Load preset…</option>
        </select>
        <button id="btnDeletePreset" class="btn">Delete</button>
      </div>
    </div>
  </section>

  <section class="card" id="top5">
    <div class="head"><h3>Top 5 Recommendations</h3><button class="toggle" data-t="top5">▾</button></div>
    <div class="body"><ol id="topList" style="margin:6px 0 0 18px"></ol></div>
  </section>

  <section class="card optional" id="catalog">
    <div class="head"><h3>Catalog (subset)</h3><button class="toggle" data-t="catalog">▾</button></div>
    <div class="body">
      <input id="q" placeholder="Search by ID / name / type" style="width:100%;padding:10px;border-radius:12px;border:1px solid var(--edge);background:var(--pill);color:var(--text);margin-bottom:10px"/>
      <div id="table"></div>
    </div>
  </section>

  <div id="toast" role="status" aria-live="polite"></div>
</div>

<script>
/* ===== version & logo ===== */
document.getElementById('ver').textContent='v25.7';
(()=>{ // load logo reliably; hide if all fail
  const lg=document.getElementById('logo');
  const p1='https://jlevick82.github.io/Astrotarget/images/logo-256.png';
  const p2='https://raw.githubusercontent.com/jlevick82/Astrotarget/main/images/logo-256.png';
  lg.src=p1; lg.onerror=()=>{ if(lg.src!==p2){lg.src=p2}else{lg.style.display='none'} };
})();

/* ===== compact & night ===== */
const btnCompact=document.getElementById('btnCompact');
const btnNight=document.getElementById('btnNight');
function applyToggles(){
  const compact=localStorage.getItem('gng.compact')==='1';
  const night=localStorage.getItem('gng.night')==='1';
  document.documentElement.classList.toggle('compact',compact);
  document.documentElement.classList.toggle('night',night);
  btnCompact.textContent= compact?'Compact on':'Compact off';
  btnNight.textContent= night?'Blue':'Night';
}
btnCompact.addEventListener('click',()=>{localStorage.setItem('gng.compact', localStorage.getItem('gng.compact')==='1'?'0':'1');applyToggles();});
btnNight.addEventListener('click',()=>{localStorage.setItem('gng.night', localStorage.getItem('gng.night')==='1'?'0':'1');applyToggles();});
applyToggles();

/* ===== collapsible cards ===== */
document.querySelectorAll('.toggle').forEach(b=>{
  const id=b.dataset.t, sec=document.getElementById(id);
  const saved=localStorage.getItem('gng.collapse.'+id);
  if(saved==='closed') sec.classList.add('collapsed');
  b.textContent = sec.classList.contains('collapsed')?'▸':'▾';
  b.addEventListener('click',()=>{
    sec.classList.toggle('collapsed');
    b.textContent = sec.classList.contains('collapsed')?'▸':'▾';
    localStorage.setItem('gng.collapse.'+id, sec.classList.contains('collapsed')?'closed':'open');
  });
});

/* ===== toast ===== */
function toast(msg){const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400)}

/* ===== DOM refs ===== */
const dom={
  badge:document.getElementById('badge'),
  bannerText:document.getElementById('bannerText'),
  updated:document.getElementById('updated'),
  astroYes:document.getElementById('astroYes'),
  astroVal:document.getElementById('astroVal'),
  moonPct:document.getElementById('moonPct'),
  moonAlt:document.getElementById('moonAlt'),
  clouds:document.getElementById('clouds'),
  lat:document.getElementById('lat'),
  lon:document.getElementById('lon'),
  scope:document.getElementById('scope'),
  camera:document.getElementById('camera'),
  chips:document.getElementById('chips'),
  fov:document.getElementById('fov'),
  scale:document.getElementById('scale'),
  topList:document.getElementById('topList'),
  q:document.getElementById('q'),
  table:document.getElementById('table'),
  btnCalc:document.getElementById('btnCalc'),
  btnGPS:document.getElementById('btnGPS'),
  btnDemo:document.getElementById('btnDemo'),
  btnRecompute:document.getElementById('btnRecompute'),
  presetName:document.getElementById('presetName'),
  presetList:document.getElementById('presetList'),
  btnSavePreset:document.getElementById('btnSavePreset'),
  btnDeletePreset:document.getElementById('btnDeletePreset'),
};

/* ===== data ===== */
const scopes=[
  {id:'sv503',name:'SVBONY SV503 80ED (560mm f/7)',fl:560,ap:80,presets:[0.8,1,2]},
  {id:'gt71',name:'William Optics GT71 (420mm f/5.9)',fl:420,ap:71,presets:[0.8,1,2]},
  {id:'redcat',name:'RedCat 51 (250mm f/4.9)',fl:250,ap:51,presets:[1,2]},
  {id:'fra400',name:'Askar FRA400 (400mm f/5.6)',fl:400,ap:72,presets:[0.7,0.8,1,2]},
  {id:'edge8',name:'Celestron EdgeHD 8 (2032mm f/10)',fl:2032,ap:203,presets:[0.7,0.63,1,2]},
  {id:'custom',name:'Custom',fl:600,ap:80,presets:[1]}
];
const cameras=[
  {name:'ZWO ASI533MC Pro (IMX533)',w:11.31,h:11.31,px:3.76},
  {name:'ZWO ASI2600 (APS-C)',w:23.5,h:15.7,px:3.76},
  {name:'Canon R6',w:35.9,h:23.9,px:6.56}
];
const MESSIER=[
  {id:'M31',name:'Andromeda Galaxy',type:'GX',ra:0.71,dec:41.3},
  {id:'M27',name:'Dumbbell Nebula',type:'PN',ra:19.99,dec:22.7},
  {id:'M33',name:'Triangulum Galaxy',type:'GX',ra:1.55,dec:30.7},
  {id:'M57',name:'Ring Nebula',type:'PN',ra:18.89,dec:33.0},
  {id:'M13',name:'Hercules Globular',type:'GC',ra:16.70,dec:36.5},
  {id:'M45',name:'Pleiades',type:'OC',ra:3.79,dec:24.1}
];

/* ===== astro math ===== */
const d2r=x=>x*Math.PI/180, r2d=x=>x*180/Math.PI;
const jd=d=>d.getTime()/86400000+2440587.5;
function gmst(d){const J=jd(d),T=(J-2451545)/36525;let th=280.46061837+360.98564736629*(J-2451545)+0.000387933*T*T-T*T*T/38710000;th=((th%360)+360)%360;return th/15}
function lst(d,lon){return(gmst(d)+lon/15+24)%24}
function sunEq(date){const J=jd(date),T=(J-2451545)/36525;const L0=(280.46646+36000.76983*T+0.0003032*T*T)%360;const M=(357.52911+35999.05029*T-0.0001537*T*T)%360;const C=(1.914602-0.004817*T-0.000014*T*T)*Math.sin(d2r(M))+(0.019993-0.000101*T)*Math.sin(d2r(2*M))+0.000289*Math.sin(d2r(3*M));const lam=L0+C,eps=23.439291-0.0130042*T;const ra=Math.atan2(Math.cos(d2r(eps))*Math.sin(d2r(lam)),Math.cos(d2r(lam)));const dec=Math.asin(Math.sin(d2r(eps))*Math.sin(d2r(lam)));return{raH:(ra<0?ra+2*Math.PI:ra)*12/Math.PI,decD:r2d(dec),lamD:lam}}
function moonEq(date){const J=jd(date);const L=(218.316+13.176396*(J-2451545))%360;const M=(134.963+13.064993*(J-2451545))%360;const F=(93.272+13.229350*(J-2451545))%360;const lon=(L+6.289*Math.sin(d2r(M)))%360;const lat=5.128*Math.sin(d2r(F)),eps=23.439;const ra=Math.atan2(Math.sin(d2r(lon))*Math.cos(d2r(eps))-Math.tan(d2r(lat))*Math.sin(d2r(eps)),Math.cos(d2r(lon)));const dec=Math.asin(Math.sin(d2r(lat))*Math.cos(d2r(eps))+Math.cos(d2r(lat))*Math.sin(d2r(eps))*Math.sin(d2r(lon)));return{raH:(ra<0?ra+2*Math.PI:ra)*12/Math.PI,decD:r2d(dec),lonD:lon}}
function altFor(raH,decD,latD,lonD,date){const LST=lst(date,lonD)*15;const HA=((LST-raH*15+540)%360)-180;const ha=d2r(HA),dec=d2r(decD),lat=d2r(latD);const sA=Math.sin(dec)*Math.sin(lat)+Math.cos(dec)*Math.cos(lat)*Math.cos(ha);return r2d(Math.asin(sA))}
function sepDeg(raH1,decD1,raH2,decD2){const a1=d2r(decD1),a2=d2r(decD2),dRA=d2r((raH1-raH2)*15);const c=Math.sin(a1)*Math.sin(a2)+Math.cos(a1)*Math.cos(a2)*Math.cos(dRA);return r2d(Math.acos(Math.min(1,Math.max(-1,c))))}

/* ===== state & helpers ===== */
let lastWx=null; // {cloud, vis}
function setUpdated(){dom.updated.textContent='Updated '+new Date().toLocaleTimeString()}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function load(k,def){try{const v=localStorage.getItem(k); return v?JSON.parse(v):def}catch(_){return def}}

/* optics */
function updateOptics(factor){
  const s=scopes[parseInt(dom.scope.value,10)]||scopes[0];
  const cam=cameras[parseInt(dom.camera.value,10)]||cameras[0];
  const active=dom.chips.querySelector('.chip.active'); const f= factor ?? (active?parseFloat(active.textContent):1);
  const eff=s.fl*f;
  const fx=(57.2958*cam.w/eff).toFixed(1), fy=(57.2958*cam.h/eff).toFixed(1);
  const scale=(206.265*cam.px/eff).toFixed(2);
  dom.fov.textContent=`FOV ${fx}° × ${fy}°`;
  dom.scale.textContent=`Scale ${scale}"/px`;
}

function renderChips(){
  dom.chips.innerHTML='';
  const s=scopes[parseInt(dom.scope.value,10)];
  s.presets.forEach(f=>{
    const b=document.createElement('button');
    b.type='button'; b.className='chip'; b.textContent=f+'x';
    b.addEventListener('click',()=>{
      dom.chips.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); updateOptics(f); computeAll();
    },{passive:true});
    dom.chips.appendChild(b);
  });
  dom.chips.querySelector('button')?.classList.add('active');
}

/* named presets */
function listPresets(){return load('gng.named',[])}
function writePresets(l){save('gng.named',l)}
function refreshPresetList(){
  const l=listPresets();
  const cur=dom.presetList.value;
  dom.presetList.innerHTML='<option value="">Load preset…</option>'+l.map((p,i)=>`<option value="${i}">${p.name}</option>`).join('');
  if(cur) dom.presetList.value=cur;
}
function currentSetupObj(){
  return {
    name:(dom.presetName.value||''),
    scope:{sel:dom.scope.value, factor:(dom.chips.querySelector('.chip.active')?.textContent||'1x')},
    camera:{sel:dom.camera.value},
    loc:{lat:dom.lat.value, lon:dom.lon.value}
  };
}
function applySetupObj(o){
  if(!o) return;
  if(o.scope){dom.scope.value=o.scope.sel; renderChips();
    const chip=[...dom.chips.querySelectorAll('.chip')].find(c=>c.textContent===o.scope.factor);
    chip?.click();
  }
  if(o.camera){dom.camera.value=o.camera.sel}
  if(o.loc){dom.lat.value=o.loc.lat; dom.lon.value=o.loc.lon}
  updateOptics(); computeAll();
}

/* sky & status */
function computeSky(){
  const lat=parseFloat(dom.lat.value)||0, lon=parseFloat(dom.lon.value)||0;
  const now=new Date();
  const s=sunEq(now), m=moonEq(now);
  const sunAlt=altFor(s.raH,s.decD,lat,lon,now);
  const dark = sunAlt <= -12;
  const mAlt = altFor(m.raH,m.decD,lat,lon,now);
  const phase=(m.lonD - s.lamD + 360)%360;
  const illum=Math.round((1-Math.cos(d2r(phase)))/2*100);

  dom.astroYes.textContent = dark ? 'Yes' : 'No';
  dom.astroVal.textContent = 'Sun alt ' + sunAlt.toFixed(1) + '°';
  dom.moonPct.textContent = illum + '%';
  dom.moonAlt.textContent = 'Alt ' + mAlt.toFixed(0) + '°';
  return {dark, illum, sunAlt, mAlt, m, s};
}
function computeStatus(){
  const {dark}=computeSky();
  const cloud = Math.round(parseFloat(dom.clouds.value)||0);
  const vis = lastWx?.vis ?? 10;
  let status='MARGINAL', cls='marginal';
  if(!dark || cloud>=60) { status='NO-GO'; cls='nogo'; }
  else if(cloud<=25) { status='GO'; cls='go'; }
  dom.badge.textContent=status;
  dom.badge.className='badge '+cls;
  dom.bannerText.textContent = `${status} — Clouds ~${cloud}% · Vis ${vis} km` + (dark?' · Astro dark':'');
  setUpdated();
}

/* targets */
function computeTop5(){
  const lat=parseFloat(dom.lat.value)||0, lon=parseFloat(dom.lon.value)||0;
  const now=new Date(); const s=sunEq(now), mEq=moonEq(now);
  const mid=new Date(now.getTime()+90*60*1000);
  const m=moonEq(mid); const mInfo={raH:m.raH,decD:m.decD,illum:(1-Math.cos(d2r(((m.lonD - s.lamD + 360)%360))))/2};
  function scoreTarget(o){
    const alt=altFor(o.ra,o.dec,lat,lon,mid);
    if(alt<35) return {score:0,alt,sep:0};
    const clouds = Math.round(parseFloat(dom.clouds.value)||40);
    const cloudScore = 1 - Math.max(0,(clouds-25)/(60-25));
    const sep=sepDeg(o.ra,o.dec,mInfo.raH,mInfo.decD);
    let sepFactor = 1- Math.max(0,(sep-20)/(45-20)); sepFactor = 1-sepFactor;
    const moonScore = Math.max(0, sepFactor*(1-mInfo.illum));
    const altScore = alt>=60?1: Math.max(0,(alt-35)/(60-35));
    const score = Math.max(0, 0.35*altScore + 0.25*cloudScore + 0.25*moonScore + 0.15*0.7);
    return {score,alt,sep};
  }
  const rows=MESSIER.map(o=>{
    const r=scoreTarget(o); return {...o,alt:r.alt,sep:r.sep,score:r.score};
  }).filter(o=>o.score>0).sort((a,b)=>b.score-a.score).slice(0,5);

  dom.topList.innerHTML = rows.length
    ? rows.map((o,i)=>`<li><strong>${o.id}</strong> — ${o.name} — alt ${o.alt.toFixed(0)}° — ${o.sep.toFixed(0)}° from Moon — ${(o.score*100|0)}%</li>`).join('')
    : '<li class="bad">No suitable targets.</li>';
}
function renderTable(){
  const q=(dom.q.value||'').toLowerCase();
  const rows=MESSIER.filter(o=>!q||o.id.toLowerCase().includes(q)||o.name.toLowerCase().includes(q)||o.type.toLowerCase().includes(q));
  dom.table.innerHTML = `<table>
    <thead><tr><th>ID</th><th>Name</th><th>Type</th><th>RA</th><th>Dec</th></tr></thead>
    <tbody>${rows.map(o=>`<tr><td>${o.id}</td><td>${o.name}</td><td>${o.type}</td><td>${o.ra.toFixed(2)}h</td><td>${o.dec.toFixed(1)}°</td></tr>`).join('')}</tbody>
  </table>`;
}
function computeAll(){ computeSky(); computeStatus(); computeTop5(); renderTable(); }

/* ===== weather fetch ===== */
async function fetchWeather(){
  const lat=parseFloat(dom.lat.value), lon=parseFloat(dom.lon.value);
  if(!Number.isFinite(lat)||!Number.isFinite(lon)){ toast('Set location'); return; }
  try{
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=cloud_cover,visibility&timezone=auto`;
    const r=await fetch(url,{cache:'no-store'}); const j=await r.json();
    const cc=(j.hourly?.cloud_cover||[]).slice(0,3);
    const vis=(j.hourly?.visibility||[]).slice(0,3).map(x=>x/1000);
    const cloudAvg = cc.length ? Math.round(cc.reduce((a,b)=>a+b,0)/cc.length) : 40;
    const visAvg = vis.length ? Math.round(vis.reduce((a,b)=>a+b,0)/vis.length) : 10;
    lastWx={cloud:cloudAvg, vis:visAvg};
    dom.clouds.value=String(cloudAvg);
    toast('Targets updated');
    computeAll();
  }catch(e){ toast('Weather failed'); }
}

/* ===== events ===== */
document.addEventListener('DOMContentLoaded',()=>{
  // populate selects
  scopes.forEach((s,i)=>{const o=document.createElement('option');o.value=i;o.textContent=s.name;dom.scope.appendChild(o)});
  cameras.forEach((c,i)=>{const o=document.createElement('option');o.value=i;o.textContent=c.name;dom.camera.appendChild(o)});
  dom.scope.value=0; dom.camera.value=0; renderChips(); updateOptics(1);

  // restore state
  dom.lat.value = localStorage.getItem('gng.lat') || '';
  dom.lon.value = localStorage.getItem('gng.lon') || '';
  dom.clouds.value = localStorage.getItem('gng.cloud') || '40';
  refreshPresetList();

  // listeners
  ['input','change'].forEach(ev=>{
    dom.clouds.addEventListener(ev,()=>{localStorage.setItem('gng.cloud',dom.clouds.value); computeAll();},{passive:true});
    dom.q.addEventListener(ev,renderTable,{passive:true});
    dom.scope.addEventListener(ev,()=>{renderChips(); updateOptics(); computeAll();},{passive:true});
    dom.camera.addEventListener(ev,()=>{updateOptics(); computeAll();},{passive:true});
    dom.lat.addEventListener(ev,()=>{localStorage.setItem('gng.lat',dom.lat.value);},{passive:true});
    dom.lon.addEventListener(ev,()=>{localStorage.setItem('gng.lon',dom.lon.value);},{passive:true});
  });

  dom.btnCalc.addEventListener('click',fetchWeather);
  dom.btnRecompute.addEventListener('click',()=>{computeAll(); toast('Targets updated')});
  dom.btnDemo.addEventListener('click',()=>{dom.lat.value='37.16557'; dom.lon.value='-76.56839'; fetchWeather();});
  dom.btnGPS.addEventListener('click',async()=>{
    try{
      dom.btnGPS.disabled=true;
      const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:8000}));
      dom.lat.value=pos.coords.latitude.toFixed(5);
      dom.lon.value=pos.coords.longitude.toFixed(5);
      localStorage.setItem('gng.lat',dom.lat.value);
      localStorage.setItem('gng.lon',dom.lon.value);
      fetchWeather();
    }catch(_){ toast('GPS failed'); }
    finally{ dom.btnGPS.disabled=false; }
  });

  // preset actions
  dom.btnSavePreset.addEventListener('click',()=>{
    const name=(dom.presetName.value||'').trim();
    if(!name){toast('Enter preset name'); return;}
    const l=listPresets(); const obj=currentSetupObj(); obj.name=name;
    const i=l.findIndex(p=>p.name.toLowerCase()===name.toLowerCase());
    if(i>=0) l[i]=obj; else l.push(obj);
    writePresets(l); refreshPresetList(); toast('Preset saved');
  });
  dom.presetList.addEventListener('change',()=>{
    const l=listPresets(); const i=parseInt(dom.presetList.value,10);
    if(Number.isFinite(i) && l[i]) applySetupObj(l[i]);
  });
  dom.btnDeletePreset.addEventListener('click',()=>{
    const i=parseInt(dom.presetList.value,10); if(!Number.isFinite(i)) return;
    const l=listPresets(); l.splice(i,1); writePresets(l); refreshPresetList(); toast('Preset deleted');
  });

  computeAll();
});
</script>
</body>
</html>
```0
