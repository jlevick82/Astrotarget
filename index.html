<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Astro Target Planner (Single‑File)</title>
  <style>
    :root { --fg:#0f172a; --muted:#64748b; --accent:#1a73e8; --ok:#34a853; --warn:#c5221f; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; color: var(--fg); margin: 0; background: #f8fafc; }
    .wrap { max-width: 820px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 22px; margin: 8px 0 4px; }
    p.sub { margin: 0 0 12px; color: var(--muted); font-size: 13px; }
    .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 14px; padding: 14px; margin: 12px 0; box-shadow: 0 1px 0 rgba(15,23,42,.02); }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px; }
    input[type="text"], input[type="number"], input[type="datetime-local"] { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 14px; background: #fff; }
    input[disabled] { background: #f1f5f9; color: #94a3b8; }
    .btn { appearance: none; border: none; border-radius: 10px; padding: 10px 12px; font-weight: 600; cursor: pointer; }
    .btn.primary { background: var(--accent); color: #fff; }
    .btn.ghost { background: #e6eefc; color: var(--accent); }
    .btn.ok { background: #e8f5ee; color: #256c3e; }
    .btn.warn { background: #fde8e7; color: #8b1d18; }
    .pill { font-size: 11px; padding: 3px 8px; border-radius: 999px; background: #f1f5f9; color:#0f172a; }
    .target { border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; margin-top: 10px; background: #fff; }
    .target.dim { opacity: .55; }
    .topbar { display:flex; align-items:center; justify-content: space-between; }
    .fav { font-size: 18px; background: none; border: none; cursor: pointer; }
    .muted { color: var(--muted); font-size: 12px; }
    .hint { font-size: 12px; color: var(--muted); }
    .space { height: 8px; }
  </style>
  <!-- React & ReactDOM (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel for inline JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Astronomy Engine (UMD) exposes window.Astronomy) -->
  <script src="https://unpkg.com/astronomy-engine/astronomy.min.js"></script>
</head>
<body>
  <div id="root" class="wrap"></div>  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const { Astronomy, Body } = window;
    const { Observer, MakeTime, Equator, Horizon, Illumination } = Astronomy;

    // --- Helpers ---
    const fovDeg = (sensor_mm, focal_mm) => (57.2957795 * sensor_mm) / focal_mm;
    const pixelScaleArcsec = (pixel_um, focal_mm) => (206.264806 * pixel_um) / focal_mm;
    const raHtoDeg = (h) => h * 15.0;
    const toDateLocalISO = (d) => {
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };
    const minutesBetween = (a,b) => Math.max(0, Math.round((b.getTime()-a.getTime())/60000));
    const clock = (d) => d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

    // --- Minimal catalog (expand later) ---
    const DSO = {
      'Sh2-101 (Tulip)': { ra: 20.00, dec: 35.3, type: 'Emission' },
      "IC 1396A (Elephant's Trunk)": { ra: 21.65, dec: 57.5, type: 'Emission' },
      'Melotte 15 (Heart core)': { ra: 2.55, dec: 61.5, type: 'Emission' },
      'IC 1848 (Soul core)': { ra: 2.87, dec: 60.4, type: 'Emission' },
      // Extras you can toggle in later:
      'NGC 7635 (Bubble)': { ra: 23.345, dec: 61.2, type: 'Emission' },
      'M33 (Triangulum)': { ra: 1.544, dec: 30.66, type: 'Galaxy' }
    };

    // --- Core astro math ---
    function altitudeAt(dt, lat, lon, raHours, decDeg) {
      const obs = new Observer(lat, lon, 0);
      const j = MakeTime(dt);
      const eq = new Equator(raHtoDeg(raHours), decDeg, 2000, 'OfDate', j);
      const hor = Horizon(j, obs, eq.ra, eq.dec, 'normal');
      return hor.altitude; // degrees
    }
    function highestAltitudeTime(start, end, lat, lon, raH, decDeg) {
      let bestAlt = -90, best = new Date(start);
      for (let t = new Date(start.getTime()); t <= end; t = new Date(t.getTime()+5*60000)) {
        const alt = altitudeAt(t, lat, lon, raH, decDeg);
        if (alt > bestAlt) { bestAlt = alt; best = new Date(t); }
      }
      return { time: best, alt: bestAlt };
    }
    function suggestExposureSeconds(kind, bortle, fRatio) {
      if (kind === 'Emission') {
        if (bortle <= 4) return Math.round(180 * (5.6 / fRatio));
        if (bortle <= 6) return Math.round(240 * (5.6 / fRatio));
        return Math.round(300 * (5.6 / fRatio));
      }
      if (bortle <= 4) return Math.round(120 * (5.6 / fRatio));
      if (bortle <= 6) return Math.round(90 * (5.6 / fRatio));
      return Math.round(60 * (5.6 / fRatio));
    }

    function App(){
      // GPS
      const [useGPS, setUseGPS] = useState(true);
      const [lat, setLat] = useState(null);
      const [lon, setLon] = useState(null);

      // Gear defaults for your rig
      const [focal, setFocal] = useState(448); // 80ED * 0.8x
      const [pixel, setPixel] = useState(3.76); // µm
      const [sensor, setSensor] = useState(11.31); // mm (ASI533 square)
      const [fRatio, setFRatio] = useState(5.6);

      // Session
      const now = new Date();
      const [startISO, setStartISO] = useState(toDateLocalISO(new Date(now.getFullYear(), now.getMonth(), now.getDate(), 22, 45)));
      const [endISO, setEndISO] = useState(toDateLocalISO(new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 4, 15)));
      const [minAlt, setMinAlt] = useState(35);
      const [bortle, setBortle] = useState(6);
      const [staticExposure, setStaticExposure] = useState(240); // can set to null for auto
      const [gain, setGain] = useState(100);
      const [offset, setOffset] = useState(50);

      // Status/favorites persistence
      const [statusMap, setStatusMap] = useState(()=>{ try { return JSON.parse(localStorage.getItem('astro_status')||'{}'); } catch { return {}; } });
      const [favorites, setFavorites] = useState(()=>{ try { return JSON.parse(localStorage.getItem('astro_favs')||'{}'); } catch { return {}; } });
      useEffect(()=>localStorage.setItem('astro_status', JSON.stringify(statusMap)), [statusMap]);
      useEffect(()=>localStorage.setItem('astro_favs', JSON.stringify(favorites)), [favorites]);

      // GPS acquire
      useEffect(()=>{
        if (!useGPS) return;
        if (!navigator.geolocation) { setUseGPS(false); return; }
        navigator.geolocation.getCurrentPosition(
          (pos)=>{ setLat(pos.coords.latitude); setLon(pos.coords.longitude); },
          ()=> setUseGPS(false)
        );
      }, [useGPS]);

      const fov = useMemo(()=> fovDeg(sensor, focal), [sensor, focal]);
      const scale = useMemo(()=> pixelScaleArcsec(pixel, focal), [pixel, focal]);

      // Build candidates
      const candidates = useMemo(()=>{
        if (lat == null || lon == null) return [];
        const start = new Date(startISO);
        const end = new Date(endISO);
        return Object.entries(DSO)
          .map(([name, v])=>{
            let firstAbove = null, lastAbove = null;
            for (let t = new Date(start.getTime()); t <= end; t = new Date(t.getTime()+5*60000)){
              const alt = altitudeAt(t, lat, lon, v.ra, v.dec);
              if (alt >= minAlt){ if (!firstAbove) firstAbove = new Date(t); lastAbove = new Date(t); }
            }
            const best = highestAltitudeTime(start, end, lat, lon, v.ra, v.dec);
            const usableMin = (firstAbove && lastAbove) ? minutesBetween(firstAbove, lastAbove) : 0;
            const moonPct = Math.round(Illumination(Body.Moon, MakeTime(best.time)).phase_fraction*100);
            const expSuggest = suggestExposureSeconds(v.type, bortle, fRatio);
            const exposure = (staticExposure ?? expSuggest);
            const perFrame = exposure + 10; // simple overhead
            const framesPerHour = Math.floor(3600 / (perFrame + 15/3)); // 15s dither / 3 frames
            const status = statusMap[name] || 'none';
            const fav = !!favorites[name];
            return { name, type: v.type, best: best.time, bestAlt: best.alt, firstAbove, lastAbove, usableMin, moonPct, exposure, framesPerHour, status, fav };
          })
          .filter(t => t.usableMin >= 60)
          .sort((a,b)=> (Number(b.fav)-Number(a.fav)) || (a.best.getTime()-b.best.getTime()));
      }, [lat, lon, startISO, endISO, minAlt, bortle, fRatio, staticExposure, statusMap, favorites]);

      function setStatus(name, s){ setStatusMap(prev => ({...prev, [name]: s})); }
      function toggleFav(name){ setFavorites(prev => ({...prev, [name]: !prev[name]})); }

      function exportPlan(){
        if (lat == null || lon == null) return;
        const planTargets = candidates.filter(t=> t.status==='add').map(t=>({
          name: t.name,
          constraints: { start: t.firstAbove.toISOString(), end: t.lastAbove.toISOString(), altitude_min_deg: minAlt },
          notes: `${t.type}; exposure ${t.exposure}s; frames/hr ~${t.framesPerHour}`,
          camera: { gain, offset },
          exposure_s: t.exposure,
          favorite: t.fav
        }));
        const seq = {
          type: 'MobilePlan',
          profile: {
            camera: 'ZWO ASI533MC Pro', mount: 'iEXOS-100', guider: 'PHD2',
            filter: 'Dual-Narrowband (Hα+OIII)', reducer: 'SVBONY 0.8x',
            fov_deg: [Number(fov.toFixed(2)), Number(fov.toFixed(2))],
            pixel_scale_arcsec_per_px: Number(scale.toFixed(2)),
            location: { lat, lon }
          },
          defaults: {
            dither_every: 3, settle_px: 1.5, settle_s: 15,
            center_tolerance_arcsec: 15, recenter_every_minutes: 20,
            recenter_every_frames: 5, hfr_autofocus_increase: 0.10
          },
          targets: planTargets
        };
        const blob = new Blob([JSON.stringify(seq,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'astro_mobile_plan.json'; a.click();
        URL.revokeObjectURL(url);
      }

      return (
        <div>
          <h1>Astro Target Planner (Single‑File)</h1>
          <p className="sub">GPS shortlist → exposures → export JSON for NINA. Works as one HTML file.</p>

          <div className="card">
            <div className="row">
              <strong>Location & session</strong>
              <label style={{display:'flex', alignItems:'center', gap:8}}>
                <input type="checkbox" checked={useGPS} onChange={e=>setUseGPS(e.target.checked)} /> Use GPS
              </label>
            </div>
            <div className="grid2" style={{marginTop:8}}>
              <div>
                <label>Latitude</label>
                <input type="number" step="0.0001" value={lat ?? ''} onChange={e=>setLat(parseFloat(e.target.value))} disabled={useGPS} />
              </div>
              <div>
                <label>Longitude</label>
                <input type="number" step="0.0001" value={lon ?? ''} onChange={e=>setLon(parseFloat(e.target.value))} disabled={useGPS} />
              </div>
              <div>
                <label>Start (local)</label>
                <input type="datetime-local" value={startISO} onChange={e=>setStartISO(e.target.value)} />
              </div>
              <div>
                <label>End (local)</label>
                <input type="datetime-local" value={endISO} onChange={e=>setEndISO(e.target.value)} />
              </div>
              <div>
                <label>Min altitude (°)</label>
                <input type="number" value={minAlt} onChange={e=>setMinAlt(parseFloat(e.target.value))} />
              </div>
              <div>
                <label>Bortle</label>
                <input type="number" min="1" max="9" value={bortle} onChange={e=>setBortle(parseInt(e.target.value||'6'))} />
              </div>
            </div>
          </div>

          <div className="card">
            <strong>Your gear</strong>
            <div className="grid2" style={{marginTop:8}}>
              <div>
                <label>Focal length (mm)</label>
                <input type="number" value={focal} onChange={e=>setFocal(parseFloat(e.target.value))} />
              </div>
              <div>
                <label>Pixel size (µm)</label>
                <input type="number" step="0.01" value={pixel} onChange={e=>setPixel(parseFloat(e.target.value))} />
              </div>
              <div>
                <label>Sensor size (mm)</label>
                <input type="number" step="0.01" value={sensor} onChange={e=>setSensor(parseFloat(e.target.value))} />
              </div>
              <div>
                <label>f/ ratio</label>
                <input type="number" step="0.1" value={fRatio} onChange={e=>setFRatio(parseFloat(e.target.value))} />
              </div>
            </div>
            <div className="muted" style={{marginTop:6}}>FoV ≈ {fov.toFixed(2)}° × {fov.toFixed(2)}° • Scale ≈ {scale.toFixed(2)}″/px</div>
          </div>

          <div className="card">
            <div className="row">
              <strong>Candidates (≥ {minAlt}° & ≥ 60 min)</strong>
              <div>
                <label style={{fontSize:12, marginRight:6}}>Static exposure (s)</label>
                <input style={{width:90}} type="number" value={staticExposure ?? ''} placeholder="auto" onChange={e=>setStaticExposure(e.target.value===''?null:parseInt(e.target.value))} />
              </div>
            </div>
            {(!candidates || candidates.length===0) && <div className="muted" style={{marginTop:8}}>No matches yet—check GPS/lat/lon, time window, or min altitude.</div>}
            {candidates.map(t => (
              <div key={t.name} className={`target ${t.status==='skip'?'dim':''}`}>
                <div className="topbar">
                  <div style={{display:'flex', alignItems:'center', gap:8}}>
                    <button className="fav" onClick={()=>toggleFav(t.name)} title="Favorite">{t.fav ? '⭐' : '☆'}</button>
                    <strong>{t.name}</strong>
                  </div>
                  <span className="pill">{t.type}</span>
                </div>
                <div style={{fontSize:14, marginTop:4}}>Best: <b>{clock(t.best)}</b> @ {t.bestAlt.toFixed(0)}° • Usable: <b>{t.usableMin}</b> min • Moon: {t.moonPct}%</div>
                <div style={{fontSize:14}}>Exposure: <b>{t.exposure}s</b> • ~{t.framesPerHour} frames/hr</div>
                <div className="muted">Window: {t.firstAbove?clock(t.firstAbove):'--'} – {t.lastAbove?clock(t.lastAbove):'--'}</div>
                <div className="space"></div>
                <div className="row" style={{gap:8, justifyContent:'flex-start'}}>
                  <button className={`btn ${t.status==='add'?'primary':'ghost'}`} onClick={()=>setStatus(t.name,'add')}>Add</button>
                  <button className={`btn ${t.status==='imaged'?'ok':'ghost'}`} onClick={()=>setStatus(t.name,'imaged')}>Imaged</button>
                  <button className={`btn ${t.status==='skip'?'warn':'ghost'}`} onClick={()=>setStatus(t.name,'skip')}>Skip</button>
                  <button className="btn" style={{background:'#f1f5f9'}} onClick={()=>setStatus(t.name,'none')}>Clear</button>
                </div>
              </div>
            ))}
            <div className="row" style={{marginTop:8}}>
              <span className="muted">Export includes <b>Add</b>-marked targets only. Favorites pin to top.</span>
              <button className="btn primary" onClick={exportPlan}>Export JSON plan</button>
            </div>
          </div>

          <div className="hint">Tip: Add this page to your home screen for offline-like use. Status & favorites persist locally.</div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script></body>
</html>
