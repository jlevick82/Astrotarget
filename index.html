<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Go/No-Go v27.8</title>
<style>
  :root{
    --bg:#0e2530;--panel:#102b37;--panel-2:#0c222c;--text:#cfe7f5;--muted:#9fb7c4;
    --pill:#133544;--ok:#27c56d;--warn:#ffc247;--bad:#ff6b6b;--chip:#122e3a;--ring:#1c4353;
    --accent:#2aa9ff;--shadow:rgba(0,0,0,.35);
  }
  .night{
    --bg:#07090a;--panel:#0a0e11;--panel-2:#080c0e;--text:#ffd1d6;--muted:#ffb6bf;
    --pill:#121518;--ok:#49f08d;--warn:#ffd86a;--bad:#ff8383;--chip:#121519;--ring:#262b30;
    --accent:#ff7ea8;--shadow:rgba(0,0,0,.55);
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 600px at 50% -150px, #17465a 0%, transparent 60%), var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial,sans-serif}
  .wrap{max-width:960px;margin:0 auto;padding:24px 16px 96px}
  h1{margin:0 0 8px;font-size:38px;letter-spacing:.5px}
  .v{opacity:.7;margin-left:8px}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0 18px}
  .btn{background:var(--pill);color:var(--text);padding:10px 16px;border-radius:20px;border:1px solid var(--ring);cursor:pointer;user-select:none}
  .btn:active{transform:translateY(1px)}
  .card{background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%);border:1px solid var(--ring);box-shadow:0 12px 30px var(--shadow);border-radius:18px;padding:16px 16px 12px;margin:16px 0}
  .card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .card-title{font-size:28px;font-weight:800;letter-spacing:.3px}
  .chev{width:44px;height:44px;border-radius:12px;background:var(--chip);border:1px solid var(--ring);display:grid;place-items:center;cursor:pointer}
  .chev svg{opacity:.85}
  .content{display:grid;gap:12px}
  .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  @media(max-width:760px){.grid2,.grid4{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .pill{display:inline-block;padding:8px 14px;border-radius:999px;background:var(--chip);border:1px solid var(--ring);color:var(--text);font-weight:600}
  .chip{display:inline-block;padding:8px 14px;border-radius:14px;background:var(--chip);border:1px solid var(--ring);color:var(--muted)}
  .status-line{font-size:30px;font-weight:900;letter-spacing:.3px;line-height:1.15;margin:6px 0 10px}
  .status-badge{display:inline-grid;place-items:center;width:56px;height:36px;border-radius:12px;margin-right:10px;font-weight:800;border:1px solid var(--ring)}
  .status-badge.no{background:#2a0b0b;color:var(--bad)}
  .status-badge.go{background:#0b2a19;color:var(--ok)}
  .sub{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0}
  .kard{border:1px solid var(--ring);border-radius:16px;padding:14px;background:var(--chip)}
  .kard h4{margin:0 0 6px;font-size:14px;color:var(--muted);font-weight:700;letter-spacing:.3px}
  .kard .big{font-size:32px;font-weight:900}
  .kard .small{color:var(--muted);margin-top:2px}
  /* slider section */
  .slider{width:100%}
  .actions{display:flex;gap:12px;margin-top:10px}
  .mini{padding:10px 16px;border-radius:14px;background:var(--chip);border:1px solid var(--ring)}
  /* list */
  ol{margin:0;padding-left:22px}
  ol li{margin:8px 0}
  ol a{font-weight:800}
  /* catalog table */
  .tbl{border:1px solid var(--ring);border-radius:16px;overflow:hidden}
  .tbl-head,.tbl-row{display:grid;grid-template-columns:90px 1fr 1fr 1fr 96px}
  .tbl-head{background:rgba(255,255,255,.04);font-weight:800}
  .tbl-head div,.cell{padding:12px 14px;border-bottom:1px solid var(--ring)}
  .gallery{height:360px;overflow:auto}
  .thumb{width:64px;height:64px;border-radius:14px;border:1px solid var(--ring);background:#0b1b23 no-repeat center/cover;display:grid;place-items:end}
  .thumb span{background:rgba(0,0,0,.55);color:#fff;margin:4px;border-radius:8px;padding:2px 8px;font-weight:800}
  .empty{opacity:.45}
  /* compact mode */
  .compact .card{padding:12px}
  .compact .card-title{font-size:22px}
  .compact .status-line{font-size:24px}
  .compact .kard .big{font-size:26px}
  /* toast */
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%) translateY(20px);opacity:0;transition:.25s;z-index:50;pointer-events:none}
  .toast .bubble{background:#0d2a1a;border:1px solid #1f4b34;color:#caffdd;padding:12px 16px;border-radius:12px;box-shadow:0 10px 24px var(--shadow);max-width:90vw}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  a{color:var(--accent);text-decoration:underline}
  .muted{color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <h1>Go/No-Go <span class="v">v27.8</span></h1>
      <div class="row">
        <button class="btn" id="toggleCompact">Compact Off</button>
        <button class="btn" id="toggleNight">Night Mode</button>
      </div>
    </header>

    <!-- STATUS -->
    <section class="card" data-card="status">
      <div class="card-header">
        <div class="card-title">Status</div>
        <button class="chev" data-collapse="status" aria-label="Collapse or expand">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="content" id="status-content">
        <div class="status-line">
          <span id="statusBadge" class="status-badge no">NO</span>
          <span id="statusText">NO-GO · Clouds ~— · Vis — · Astro dark</span>
        </div>
        <div class="sub">
          <span class="pill" id="updated">Updated --:--</span>
          <span class="pill" id="sunAlt">Sun alt —</span>
          <span class="pill" id="moonIllum">Moon —</span>
          <span class="pill" id="alt">Alt —</span>
        </div>
        <div class="muted">Observing recommendation</div>
      </div>
    </section>

    <!-- SKY -->
    <section class="card" data-card="sky">
      <div class="card-header">
        <div class="card-title">Sky</div>
        <button class="chev" data-collapse="sky"><svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>
      </div>
      <div class="content" id="sky-content">
        <div class="grid4">
          <div class="kard">
            <h4>Astronomical dark</h4>
            <div class="big" id="astroDark">Yes</div>
            <div class="small" id="sunAltSmall">Sun alt -45°</div>
          </div>
          <div class="kard">
            <h4>Moon illum</h4>
            <div class="big" id="moonPct">7%</div>
            <div class="small" id="moonAltSmall">Alt -29°</div>
          </div>
          <div class="kard">
            <h4>Humidity</h4>
            <div class="big" id="humidity">—</div>
          </div>
          <div class="kard">
            <h4>Transparency</h4>
            <div class="big" id="transWord">Bad</div>
            <div class="small" id="transDetails">AOD 0.12 · PM2.5 — · RH — · Vis — · ΔT — · 0</div>
          </div>
        </div>
      </div>
    </section>

    <!-- CLOUDS -->
    <section class="card" data-card="clouds">
      <div class="card-header">
        <div class="card-title">Clouds (avg)</div>
        <button class="chev" data-collapse="clouds"><svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>
      </div>
      <div class="content" id="clouds-content">
        <input id="cloudSlider" class="slider" type="range" min="0" max="100" step="1" value="35" />
        <div class="actions">
          <button class="mini" id="useClouds">Use</button>
          <button class="mini" id="calcClouds">Calculate</button>
        </div>
        <div class="kard">
          <div id="cloudSource">From Open-Meteo (hourly) • slider overrides</div>
        </div>
        <div class="pill" id="cloudPct">35%</div>
      </div>
    </section>

    <!-- QUICK SETUP -->
    <section class="card" data-card="quick">
      <div class="card-header">
        <div class="card-title">Quick setup</div>
        <button class="chev" data-collapse="quick"><svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>
      </div>
      <div class="content" id="quick-content">
        <div class="grid2">
          <label class="kard"><h4>Latitude (°)</h4><input id="lat" type="number" step="0.00001" value="37.16558" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);background:var(--panel-2);color:var(--text)"></label>
          <label class="kard"><h4>Longitude (°)</h4><input id="lon" type="number" step="0.00001" value="-76.56841" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);background:var(--panel-2);color:var(--text)"></label>
        </div>
        <div class="grid2">
          <label class="kard"><h4>Hours (window)</h4><input id="hours" type="number" min="1" max="12" value="3" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);background:var(--panel-2);color:var(--text)"></label>
          <div class="kard" style="display:flex;align-items:center;gap:12px">
            <button class="mini" id="useGPS">Use GPS</button>
            <button class="mini" id="calcNow">Calculate Now</button>
          </div>
        </div>
      </div>
    </section>

    <!-- TOP 5 -->
    <section class="card" data-card="top5">
      <div class="card-header">
        <div class="card-title">Top 5 Recommendations</div>
        <button class="chev" data-collapse="top5"><svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>
      </div>
      <div class="content" id="top5-content">
        <ol id="top5List"></ol>
      </div>
    </section>

    <!-- CATALOG -->
    <section class="card" data-card="catalog">
      <div class="card-header">
        <div class="card-title">Catalog (subset)</div>
        <button class="chev" data-collapse="catalog"><svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>
      </div>
      <div class="content" id="catalog-content">
        <div class="tbl">
          <div class="tbl-head"><div>Type</div><div>RA</div><div>Dec</div><div>Name</div><div>Image</div></div>
          <div class="gallery" id="catalogBody"></div>
        </div>
      </div>
    </section>

    <div class="toast" id="toast"><div class="bubble" id="toastText">Saved</div></div>
  </div>

<script>
/* ========== helpers ========== */
const $ = s => document.querySelector(s);
const $all = s => [...document.querySelectorAll(s)];
const toast = (msg) => { const t=$("#toast"); $("#toastText").textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1600); };
const fmtPct = v => `${Math.round(v)}%`;
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

/* ========== state ========== */
const state = {
  night:false, compact:false,
  lat:parseFloat($("#lat").value), lon:parseFloat($("#lon").value), hours:parseInt($("#hours").value,10),
  clouds:35, humidity:91, visibilityKm:18, moonPct:7, sunAlt:-45, moonAlt:-29, astroDark:true,
};

/* ========== UI wiring ========== */
$("#toggleNight").addEventListener("click",()=>{
  state.night=!state.night; document.body.classList.toggle("night",state.night);
  $("#toggleNight").textContent = state.night ? "Normal Mode" : "Night Mode";
  toast(state.night?"Night mode on":"Night mode off");
});
$("#toggleCompact").addEventListener("click",()=>{
  state.compact=!state.compact; document.getElementById("app").classList.toggle("compact",state.compact);
  $("#toggleCompact").textContent = state.compact ? "Compact On" : "Compact Off";
});
$all(".chev").forEach(btn=>{
  btn.addEventListener("click",()=>{
    const key = btn.getAttribute("data-collapse");
    const area = document.getElementById(`${key}-content`);
    const open = area.style.display!== "none";
    area.style.display = open ? "none" : "";
    btn.querySelector("svg").style.transform = open ? "rotate(180deg)" : "rotate(0)";
  });
});
/* Controls */
$("#lat").addEventListener("change",e=>state.lat=parseFloat(e.target.value));
$("#lon").addEventListener("change",e=>state.lon=parseFloat(e.target.value));
$("#hours").addEventListener("change",e=>state.hours=parseInt(e.target.value,10));
$("#cloudSlider").addEventListener("input",e=>{
  state.clouds=parseInt(e.target.value,10);
  $("#cloudPct").textContent=fmtPct(state.clouds);
});
$("#useClouds").addEventListener("click",()=>{ applyStatus(); toast(`Clouds set to ${fmtPct(state.clouds)}`); });

$("#calcNow").addEventListener("click",async ()=>{
  await calcClouds(); applyStatus(); toast("Calculated sky & clouds");
});
$("#calcClouds").addEventListener("click",async ()=>{
  await calcClouds(); toast(`Clouds calculated from Open-Meteo: ${fmtPct(state.clouds)}`);
});
$("#useGPS").addEventListener("click",()=>{
  if(!navigator.geolocation){ toast("GPS unavailable"); return; }
  navigator.geolocation.getCurrentPosition(p=>{
    state.lat = +p.coords.latitude.toFixed(5);
    state.lon = +p.coords.longitude.toFixed(5);
    $("#lat").value=state.lat; $("#lon").value=state.lon;
    toast("GPS set");
  },()=>toast("GPS denied"));
});

/* ========== external links for Top 5 ========== */
const TOP5 = [
  {id:"M27", name:"Dumbbell Nebula", score:196, alt:"82°", sep:"142°"},
  {id:"M31", name:"Andromeda Galaxy", score:183, alt:"45°", sep:"140°"},
  {id:"M33", name:"Triangulum Galaxy", score:175, alt:"46°", sep:"145°"},
  {id:"M57", name:"Ring Nebula", score:155, alt:"44°", sep:"115°"},
  {id:"M13", name:"Hercules Globular", score:120, alt:"24°", sep:"90°"}
];
const M_WIKI = id => `https://en.wikipedia.org/wiki/${id}`;
function renderTop5(){
  const ol=$("#top5List"); ol.innerHTML="";
  TOP5.forEach((o,i)=>{
    const li=document.createElement("li");
    li.innerHTML = `<a href="${M_WIKI(o.id)}" target="_blank" rel="noopener">${o.id}</a> — ${o.name} — alt ${o.alt} — ${o.sep} from Moon — ${o.score}%`;
    ol.appendChild(li);
  });
}

/* ========== catalog with scroll & fallback thumbs ========== */
const CATALOG = [
  {type:"GX", ra:"0.71h", dec:"41.3°", name:"M31", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/M31bobo.jpg/256px-M31bobo.jpg"},
  {type:"GX", ra:"1.55h", dec:"30.7°", name:"M33", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/Triangulum_Galaxy_by_Gianni_Puga.jpg/256px-Triangulum_Galaxy_by_Gianni_Puga.jpg"},
  {type:"PN", ra:"19.89h", dec:"22.7°", name:"M27", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/M27_-_Dumbbell_Nebula.jpg/256px-M27_-_Dumbbell_Nebula.jpg"},
  {type:"PN", ra:"18.89h", dec:"33.0°", name:"M57", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/0/0a/M57_The_Ring_Nebula.JPG/256px-M57_The_Ring_Nebula.JPG"},
  {type:"GC", ra:"16.70h", dec:"36.5°", name:"M13", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/M13_-_The_Great_Hercules_Cluster.jpg/256px-M13_-_The_Great_Hercules_Cluster.jpg"},
];
function renderCatalog(){
  const body=$("#catalogBody"); body.innerHTML="";
  CATALOG.forEach(r=>{
    const row=document.createElement("div");
    row.className="tbl-row";
    const thumb = `<div class="thumb" style="background-image:url('${r.img}')" onerror="this.classList.add('empty');this.style.backgroundImage='none'"><span>${r.name}</span></div>`;
    row.innerHTML = `
      <div class="cell">${r.type}</div>
      <div class="cell">${r.ra}</div>
      <div class="cell">${r.dec}</div>
      <div class="cell">${r.name}</div>
      <div class="cell">${thumb}</div>`;
    body.appendChild(row);
  });
}

/* ========== cloud + transparency calc ========== */
async function calcClouds(){
  const {lat,lon,hours}=state;
  try{
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=cloud_cover,relative_humidity_2m,visibility&timezone=auto`;
    const r = await fetch(url,{cache:"no-store"});
    const j = await r.json();
    const cc = j.hourly.cloud_cover || [];
    const rh = j.hourly.relative_humidity_2m || [];
    const vis = j.hourly.visibility || [];

    // average over the next N hours
    const n = clamp(hours,1,12);
    const mean = arr => arr.slice(0,n).reduce((a,b)=>a+b,0)/Math.max(1,Math.min(n,arr.length));
    const ccAvg = Math.round(mean(cc));
    const rhAvg = Math.round(mean(rh));
    const visAvgKm = Math.round(mean(vis)/1000);

    // store
    state.clouds = isFinite(ccAvg) ? ccAvg : state.clouds;
    state.humidity = isFinite(rhAvg) ? rhAvg : state.humidity;
    state.visibilityKm = isFinite(visAvgKm) ? visAvgKm : state.visibilityKm;

    // update slider & label
    $("#cloudSlider").value = state.clouds;
    $("#cloudPct").textContent = fmtPct(state.clouds);
    $("#cloudSource").textContent = "From Open-Meteo (hourly) • slider overrides";

    // quick transparency word heuristic
    const aod = 0.12; // placeholder constant; could be wired to a real API later
    const score = (100-state.clouds) - (state.humidity*0.2) + (state.visibilityKm*1.2) - (aod*100*0.6);
    const word = score>75 ? "Great" : score>55 ? "Good" : score>35 ? "Fair" : "Bad";
    $("#transWord").textContent = word;
    $("#humidity").textContent = `${state.humidity}%`;
    $("#transDetails").textContent = `AOD ${aod.toFixed(2)} · PM2.5 — · RH ${state.humidity}% · Vis ${state.visibilityKm}km · ΔT 0.7°C · 0`;
  }catch(e){
    $("#cloudSource").textContent = "From slider (Open-Meteo unavailable)";
    toast("Open-Meteo unavailable — using slider");
  }
}

/* ========== status line ========== */
function applyStatus(){
  const go = state.clouds <= 40 && state.visibilityKm >= 15;
  $("#statusBadge").textContent = go ? "GO" : "NO";
  $("#statusBadge").className = "status-badge " + (go?"go":"no");
  $("#statusText").textContent = `${go?"GO":"NO-GO"} · Clouds ~${fmtPct(state.clouds)} · Vis ${state.visibilityKm} km · Astro dark`;
  $("#updated").textContent = "Updated " + new Date().toLocaleTimeString();
  $("#sunAlt").textContent = `Sun alt ${state.sunAlt>0?"+":""}${state.sunAlt}°`;
  $("#moonIllum").textContent = `Moon ${state.moonPct}%`;
  $("#alt").textContent = `Alt ${state.moonAlt}°`;
  $("#sunAltSmall").textContent = `Sun alt ${state.sunAlt}°`;
  $("#moonPct").textContent = `${state.moonPct}%`;
  $("#moonAltSmall").textContent = `Alt ${state.moonAlt}°`;
}

/* ========== init ========== */
renderTop5();
renderCatalog();
applyStatus();
$("#cloudPct").textContent = fmtPct(state.clouds);

/* initial gentle calc (doesn't block UI) */
setTimeout(()=>calcClouds().then(applyStatus), 200);
</script>
</body>
</html>
