<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AstroTarget ‚Äì Tonight‚Äôs Targets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background:#0b0c10; color:#fff; font-family:Arial, sans-serif; padding:15px; }
    h1 { color:#66fcf1; text-align:center; }
    select, input { margin:10px; padding:5px; font-size:16px; }
    .card {
      background:#1f2833; border:1px solid #45a29e; border-radius:8px;
      padding:12px; margin:10px 0;
    }
    img { max-width:100%; border-radius:5px; margin-top:5px; }
  </style>
</head>
<body>
  <h1>üî≠ AstroTarget</h1>
  <p>
    Catalog: 
    <select id="catalogChoice" onchange="updateCatalog()">
      <option value="messier">Messier</option>
      <option value="caldwell">Caldwell</option>
      <option value="ngc">Bright NGC</option>
      <option value="all">All</option>
      <option value="pro">Pro Mode</option>
    </select>
  </p>
  <p>
    Search: 
    <input type="text" id="searchBox" placeholder="Type object name..." oninput="computeTargets(currentLat,currentLon)">
    <br>
    <label><input type="checkbox" id="searchAll" onchange="computeTargets(currentLat,currentLon)"> Search across all catalogs</label>
  </p>
  <p id="status">Fetching location and calculating...</p>
  <div id="results"></div>

  <!-- Catalogs -->
  <script src="messier.js"></script>
  <script src="caldwell.js"></script>
  <script src="brightngc.js"></script>

  <script>
  let currentLat = 40, currentLon = 0;

  function toRadians(deg){return deg*Math.PI/180;}
  function toDegrees(rad){return rad*180/Math.PI;}

  function radecToAlt(raHours, decDeg, lat, lon, date) {
    const ra = raHours * 15;
    const lst = getLST(lon, date);
    const ha = (lst - ra + 360) % 360;
    const haRad = toRadians(ha);
    const decRad = toRadians(decDeg);
    const latRad = toRadians(lat);
    const sinAlt = Math.sin(decRad) * Math.sin(latRad) +
                   Math.cos(decRad) * Math.cos(latRad) * Math.cos(haRad);
    return toDegrees(Math.asin(sinAlt));
  }

  function getLST(lon, date){
    const JD = (date.getTime()/86400000)+2440587.5;
    const D = JD-2451545.0;
    let GMST = 280.46061837 + 360.98564736629*D;
    GMST=(GMST%360+360)%360;
    const LST=GMST+lon;
    return (LST%360+360)%360;
  }

  function getActiveCatalog(){
    const choice=document.getElementById("catalogChoice").value;
    if(choice==="messier") return catalog;
    if(choice==="caldwell") return caldwell;
    if(choice==="ngc") return brightngc;
    if(choice==="all") return [...catalog,...caldwell,...brightngc];
    if(choice==="pro"){ 
      alert("üöÄ Pro Mode coming soon! Extended catalogs will be added.");
      return [...catalog,...caldwell,...brightngc];
    }
    return catalog;
  }

  function computeTargets(lat, lon){
    const now=new Date();
    const query = document.getElementById("searchBox").value.toLowerCase();
    const searchAll = document.getElementById("searchAll").checked;

    // catalog selection
    let allCatalog = searchAll 
      ? [...catalog, ...caldwell, ...brightngc] 
      : getActiveCatalog();

    let visible=[];
    allCatalog.forEach(obj=>{
      const alt=radecToAlt(obj.ra,obj.dec,lat,lon,now);
      if(alt>30 && obj.mag<11){
        if(query==="" || obj.name.toLowerCase().includes(query)){
          visible.push({...obj,alt:alt.toFixed(1)});
        }
      }
    });
    visible.sort((a,b)=>b.alt-a.alt);

    let out="";
    if(visible.length===0) out="<p>No objects match your filters.</p>";
    else visible.forEach(obj=>{
      const img = obj.img ? `<img src="${obj.img}" alt="${obj.name}">` : "";
      out+=`<div class="card">
        <h2>${obj.name}</h2>
        <p>Type: ${obj.type}<br>
        Mag: ${obj.mag} | Size: ${obj.size}<br>
        Altitude now: ${obj.alt}¬∞</p>
        ${img}
      </div>`;
    });
    document.getElementById("results").innerHTML=out;
  }

  function updateCatalog(){
    computeTargets(currentLat,currentLon);
  }

  // Get location
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      currentLat=pos.coords.latitude;
      currentLon=pos.coords.longitude;
      document.getElementById("status").innerText="Location detected ‚úÖ";
      updateCatalog();
    },err=>{
      document.getElementById("status").innerText="‚ö†Ô∏è Location denied. Using default (40¬∞N,0¬∞E).";
      updateCatalog();
    });
  } else {
    document.getElementById("status").innerText="‚ö†Ô∏è GPS not available. Using default (40¬∞N,0¬∞E).";
    updateCatalog();
  }
  console.log("Messier:", catalog.length, "Caldwell:", caldwell.length, "Bright NGC:", brightngc.length);
  </script>
</body>
</html>
