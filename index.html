<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Go/No-Go v28.3+</title>
<style>
  :root{
    --bg: #0f1b22;
    --panel: #111c23;
    --panel-2: #0c151b;
    --text: #dbe7ef;
    --muted: #9fb3c1;
    --accent: #8bd3ff;
    --ok: #3ddc84;
    --warn: #ffcf5a;
    --bad: #ff6b6b;
    --chip: #13222b;
    --ring: rgba(255,255,255,.08);
    --shadow: 0 12px 40px rgba(0,0,0,.35);
    --radius: 18px;
  }
  body{margin:0;background:radial-gradient(1200px 700px at 50% -200px,#123,#0a1217) fixed,var(--bg);color:var(--text);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  *{box-sizing:border-box}
  a{color:#9fd1ff;text-decoration:underline}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px 80px}
  header.app{display:flex;align-items:end;gap:16px;margin:8px 0 18px}
  .title{font-weight:900;letter-spacing:.5px;font-size:44px}
  .ver{opacity:.65;font-weight:700;font-size:34px}
  .toolbar{display:flex;gap:12px;margin:8px 0 6px;flex-wrap:wrap}
  .btn{
    appearance:none;border:0;outline:0;padding:12px 16px;border-radius:999px;
    background:linear-gradient(#1a2a34,#141f26);color:var(--text);box-shadow:var(--shadow);
  }
  .btn:active{transform:translateY(1px)}
  .btn.small{padding:8px 12px;font-size:14px}
  .chip{
    display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;
    background:linear-gradient(180deg,#12202a,#0f1920);border:1px solid var(--ring);color:var(--text);white-space:nowrap
  }
  .chip.ok{background:#0e2216;border-color:#215b36}
  .chip.bad{background:#2a1414;border-color:#6b2a2a}
  .chip.warn{background:#2b230f;border-color:#6b5520}
  /* cards */
  .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--ring);
        border-radius:var(--radius);box-shadow:var(--shadow);margin:14px 0;overflow:hidden}
  .card-header{display:flex;align-items:center;justify-content:space-between;padding:18px 18px}
  .card-title{font-size:28px;font-weight:800;letter-spacing:.3px}
  .chev{width:42px;height:42px;border-radius:12px;background:linear-gradient(#18242c,#121b22);border:1px solid var(--ring);
        display:grid;place-items:center;color:var(--muted);cursor:pointer;user-select:none}
  .chev svg{transition:transform .25s ease}
  .chev[aria-expanded="true"] svg{transform:rotate(180deg)}
  .card-body{padding:16px 18px 22px}
  .grid{display:grid;gap:14px}
  .grid.cols2{grid-template-columns:repeat(2,1fr)}
  .grid.cols3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:820px){.grid.cols2,.grid.cols3{grid-template-columns:1fr}}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;background:#0f1a20;border:1px solid var(--ring);border-radius:999px}
  .kv{display:flex;flex-direction:column;gap:10px;padding:16px;border-radius:14px;border:1px solid var(--ring);background:#0f1a20}
  .kv h4{margin:0 0 6px 0;font-weight:700;letter-spacing:.2px;color:var(--muted)}
  .kv .big{font-size:34px;font-weight:900}
  /* table */
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  thead th{font-weight:700;color:var(--muted);text-align:left;padding:6px 10px}
  tbody td{padding:16px 10px;background:#0f1a20;border-top:1px solid var(--ring);border-bottom:1px solid var(--ring)}
  tbody tr td:first-child{border-left:1px solid var(--ring);border-top-left-radius:12px;border-bottom-left-radius:12px}
  tbody tr td:last-child{border-right:1px solid var(--ring);border-top-right-radius:12px;border-bottom-right-radius:12px}
  .thumb{width:72px;height:72px;border-radius:14px;background:#0a141a;border:1px solid var(--ring);display:grid;place-items:center;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block;opacity:.95}
  .thumb.fov::after{
    content:"";position:absolute;inset:18% 18% 18% 18%;border:2px dashed rgba(255,255,255,.6);border-radius:6px;pointer-events:none}
  .row-actions{display:flex;gap:8px;align-items:center}
  /* compact mode */
  .compact .card-body{padding:10px 12px}
  .compact .card-title{font-size:22px}
  .compact .kv .big{font-size:26px}
  /* toast */
  .toast-wrap{position:fixed;left:0;right:0;bottom:20px;display:grid;place-items:center;pointer-events:none;z-index:9999}
  .toast{
    pointer-events:auto; background:#0f1a20;border:1px solid var(--ring);box-shadow:var(--shadow);
    color:var(--text);border-radius:14px;padding:12px 14px;min-width:260px;text-align:center
  }
  /* badges */
  .badge{padding:6px 10px;border-radius:999px;border:1px solid var(--ring);background:#0e171c;white-space:nowrap}
  .badge.ok{background:#0e2216;border-color:#1b4d2f}
  .badge.bad{background:#2a1414;border-color:#6b2a2a}
  /* inputs */
  input[type="text"], input[type="number"]{
    width:100%;padding:12px 14px;border-radius:12px;color:var(--text);background:#0f1a20;border:1px solid var(--ring);
  }
  .seg{display:flex;gap:10px;flex-wrap:wrap}
  .seg .toggle{
    padding:10px 14px;border-radius:14px;border:1px solid var(--ring);background:#0f1a20;cursor:pointer;user-select:none
  }
  .seg .toggle.active{outline:2px solid var(--accent);box-shadow:0 0 0 6px rgba(139,211,255,.08) inset}
  .right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .muted{color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <header class="app">
      <div class="title">Go/No-Go</div>
      <div class="ver">v28.3+</div>
    </header>

    <div class="toolbar">
      <button id="btn-compact" class="btn">Compact On</button>
      <button id="btn-night" class="btn">Night Mode</button>
    </div>

    <!-- 1) STATUS -->
    <section id="card-status" class="card">
      <div class="card-header">
        <div class="card-title">Status</div>
        <button class="chev" data-target="card-status" aria-expanded="true" title="Collapse/Expand">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="card-body">
        <div class="grid cols3">
          <div class="kv">
            <h4>Decision</h4>
            <div id="status-decision" class="chip ok">GO</div>
          </div>
          <div class="kv">
            <h4>Clouds</h4>
            <div id="status-clouds" class="pill">~—%</div>
          </div>
          <div class="kv">
            <h4>Visibility</h4>
            <div id="status-vis" class="pill">Vis — km</div>
          </div>
        </div>
        <div class="grid cols3" style="margin-top:8px">
          <div class="pill" id="status-astro">Astro dark</div>
          <div class="pill" id="status-updated">Updated —:—</div>
          <div class="pill" id="status-sun">Sun alt —°</div>
          <div class="pill" id="status-moon">Moon —%</div>
          <div class="pill" id="status-transp">Transparency —</div>
        </div>
      </div>
    </section>

    <!-- 2) CONDITIONS -->
    <section id="card-conditions" class="card">
      <div class="card-header">
        <div class="card-title">Conditions</div>
        <button class="chev" data-target="card-conditions" aria-expanded="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="card-body">
        <div class="grid cols2">
          <div class="kv"><h4>Moon illum</h4><div class="big" id="cond-moon">—%</div><div class="muted" id="cond-moon-alt">Alt —°</div></div>
          <div class="kv"><h4>Clouds (window max)</h4><div class="big" id="cond-clouds">—%</div><div class="muted">From Open-Meteo (window max)</div></div>
          <div class="kv"><h4>Humidity</h4><div class="big" id="cond-hum">—%</div></div>
          <div class="kv"><h4>Transparency</h4><div class="big" id="cond-transp">—</div><div class="muted" id="cond-transp-detail"></div></div>
        </div>
        <div class="right" style="margin-top:10px">
          <span class="badge" id="cond-updated">Updated —:— —</span>
          <span class="badge" id="cond-sun">Sun alt —°</span>
        </div>
      </div>
    </section>

    <!-- 3) QUICK SETUP -->
    <section id="card-quicksetup" class="card">
      <div class="card-header">
        <div class="card-title">Quick setup</div>
        <button class="chev" data-target="card-quicksetup" aria-expanded="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="card-body">
        <div class="grid cols3">
          <div class="kv">
            <h4>Latitude (°)</h4>
            <input id="in-lat" type="text" inputmode="decimal" placeholder="e.g. 37.16">
          </div>
          <div class="kv">
            <h4>Longitude (°)</h4>
            <input id="in-lon" type="text" inputmode="decimal" placeholder="e.g. -76.56">
          </div>
          <div class="kv">
            <h4>Hours (window)</h4>
            <input id="in-window" type="number" min="1" max="12" value="3">
          </div>
        </div>
        <div class="right" style="margin-top:12px">
          <button id="btn-gps" class="btn small">Use GPS</button>
          <button id="btn-calc" class="btn small">Calculate Now</button>
        </div>
      </div>
    </section>

    <!-- 4) RIG -->
    <section id="card-rig" class="card">
      <div class="card-header">
        <div class="card-title">Rig (Scope + Camera)</div>
        <button class="chev" data-target="card-rig" aria-expanded="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="card-body">
        <div class="right" style="flex-wrap:wrap;margin-bottom:10px">
          <span id="rig-efffl" class="badge">Eff. FL — mm</span>
          <span id="rig-fov" class="badge">FOV — × —</span>
          <span id="rig-scale" class="badge">Scale — "/px</span>
          <span id="rig-scope" class="badge">— × — mm (f/—)</span>
          <span id="rig-reducer" class="badge">Reducer —</span>
          <button id="btn-edit-rig" class="btn small">Edit rig</button>
        </div>

        <!-- editor (collapsible inside card) -->
        <div id="rig-editor" style="display:none;margin-top:8px">
          <div class="grid cols2">
            <div class="kv">
              <h4>Scope</h4>
              <select id="sel-scope" class="btn" style="width:100%">
                <option value="SVBONY SV503|560|80">SVBONY SV503 (560 × 80)</option>
                <option value="William Z61|360|61">William Z61 (360 × 61)</option>
                <option value="Celestron C8|2032|203">Celestron C8 (2032 × 203)</option>
              </select>
              <div class="grid cols2" style="margin-top:10px">
                <input id="in-fl" type="number" placeholder="Focal length (mm)" />
                <input id="in-dia" type="number" placeholder="Diameter (mm)" />
              </div>
            </div>
            <div class="kv">
              <h4>Reducer / Barlow</h4>
              <div class="seg" id="seg-reducer">
                <span class="toggle" data-mul="0.63">0.63×</span>
                <span class="toggle" data-mul="0.7">0.7×</span>
                <span class="toggle active" data-mul="0.8">0.8×</span>
                <span class="toggle" data-mul="1">1×</span>
                <span class="toggle" data-mul="2">2×</span>
              </div>
              <div class="kv" style="margin-top:10px"><h4>Eff. FL</h4><div id="rig-efffl-editor" class="big">— mm</div></div>
            </div>
            <div class="kv">
              <h4>Camera</h4>
              <select id="sel-cam" class="btn" style="width:100%">
                <option value="ZWO ASI533MC|11.31|11.31|3.76">ZWO ASI533MC (11.31×11.31 / 3.76µm)</option>
                <option value="ZWO ASI294MC|19.1|13.0|4.63">ZWO ASI294MC (19.1×13.0 / 4.63µm)</option>
                <option value="Sony A7 III|35.9|24.0|5.94">Sony A7 III (35.9×24.0 / 5.94µm)</option>
              </select>
              <div class="grid cols3" style="margin-top:10px">
                <input id="in-sx" type="number" step="0.01" placeholder="Sensor X (mm)">
                <input id="in-sy" type="number" step="0.01" placeholder="Sensor Y (mm)">
                <input id="in-px" type="number" step="0.01" placeholder="Pixel (µm)">
              </div>
            </div>
            <div class="kv">
              <h4>Hooks</h4>
              <label class="seg"><span class="toggle active" id="hook-bias">Bias Top-5 to FOV</span></label>
              <label class="seg" style="margin-top:8px"><span class="toggle active" id="hook-fov">FOV overlay on thumbs</span></label>
              <div class="muted" style="margin-top:10px">Preset: <code id="rig-preset-name">SV503_533_0.8x</code></div>
              <div class="right" style="margin-top:10px">
                <button id="btn-save-rig" class="btn small">Save</button>
                <button id="btn-del-rig" class="btn small">Delete</button>
                <button id="btn-close-rig" class="btn small">Close editor</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 5) TOP 5 -->
    <section id="card-top5" class="card">
      <div class="card-header">
        <div class="card-title">Top 5 Recommendations</div>
        <button class="chev" data-target="card-top5" aria-expanded="false">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="card-body">
        <ol id="top5-list" style="padding-left:18px;margin:0;display:grid;gap:10px"></ol>
      </div>
    </section>

    <!-- 6) CATALOG (starts closed) -->
    <section id="card-catalog" class="card collapsed">
      <div class="card-header">
        <div class="card-title">Catalog</div>
        <button class="chev" data-target="card-catalog" aria-expanded="false">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="card-body">
        <div class="grid cols2">
          <div class="kv"><h4>Search catalog (name/type)</h4><input id="search" type="text" placeholder="e.g., M31, galaxy, nebula…"></div>
          <div class="kv"><h4>&nbsp;</h4><button id="btn-clear-search" class="btn small">Clear</button></div>
        </div>
        <div style="overflow:auto">
          <table id="tbl-catalog">
            <thead><tr><th>Name</th><th>Type</th><th>RA</th><th>Dec</th><th>Image</th></tr></thead>
            <tbody id="cat-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 7) GO/NO-GO SETTINGS (starts closed) -->
    <section id="card-gng-settings" class="card collapsed">
      <div class="card-header">
        <div class="card-title">Go/No-Go Settings</div>
        <button class="chev" data-target="card-gng-settings" aria-expanded="false">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="card-body">
        <div class="grid cols3">
          <div class="kv"><h4>Clouds threshold (max in window)</h4><input id="th-clouds" type="number" value="35" min="0" max="100"><div class="muted">GO if ≤ this %</div></div>
          <div class="kv"><h4>Humidity threshold</h4><input id="th-hum" type="number" value="90" min="0" max="100"><div class="muted">Warn if ≥ this %</div></div>
          <div class="kv"><h4>Visibility threshold (km)</h4><input id="th-vis" type="number" value="10" min="1" max="50"><div class="muted">Warn if &lt; this</div></div>
        </div>
        <div class="right" style="margin-top:10px">
          <button id="btn-save-gng" class="btn small">Save</button>
          <span class="muted">Applies on next calculation</span>
        </div>
      </div>
    </section>

    <!-- Toasts -->
    <div class="toast-wrap" id="toast-wrap" style="display:none">
      <div class="toast" id="toast"></div>
    </div>
  </div>

<script>
/* ========= UTIL ========= */
const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];
const ls = (k,v) => (v===undefined? JSON.parse(localStorage.getItem(k) || 'null') : localStorage.setItem(k,JSON.stringify(v)));
function toast(msg){ const w=$("#toast-wrap"), t=$("#toast"); t.textContent=msg; w.style.display="grid";
  clearTimeout(toast._t); toast._t=setTimeout(()=>w.style.display="none",2200); }

/* ========= CARD STATE (order per your spec) ========= */
const CARD_IDS = { status:'card-status', cond:'card-conditions', quick:'card-quicksetup', rig:'card-rig', top5:'card-top5', catalog:'card-catalog', gng:'card-gng-settings' };
function setCardOpen(id, open){
  const card = document.getElementById(id); if(!card) return;
  const body = card.querySelector('.card-body'); const btn = card.querySelector('.chev');
  body.style.display = open ? '' : 'none';
  btn.setAttribute('aria-expanded', String(open));
}
function initCardStates(){
  setCardOpen(CARD_IDS.status,true);
  setCardOpen(CARD_IDS.cond,true);
  setCardOpen(CARD_IDS.quick,true);
  setCardOpen(CARD_IDS.rig,true);
  setCardOpen(CARD_IDS.top5,false);
  setCardOpen(CARD_IDS.catalog,false);
  setCardOpen(CARD_IDS.gng,false);
}
function onTop5Rendered(){ setCardOpen(CARD_IDS.top5,true); }

/* toggle wiring */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.chev'); if(!btn) return;
  const id = btn.getAttribute('data-target') || btn.closest('.card').id;
  const open = btn.getAttribute('aria-expanded') !== 'true';
  setCardOpen(id, open);
});

/* ========= THEME / UI ========= */
$("#btn-compact").addEventListener('click', ()=>{
  document.body.classList.toggle('compact');
  $("#btn-compact").textContent = document.body.classList.contains('compact')? "Compact Off":"Compact On";
});
$("#btn-night").addEventListener('click', ()=>{
  document.body.classList.toggle('night');
  $("#btn-night").textContent = document.body.classList.contains('night')? "Normal Mode":"Night Mode";
});

/* ========= DATA MODELS ========= */
const DEFAULT_RIG = { name:"SV503_533_0.8x", fl:560, dia:80, reducer:0.8, cam:{sx:11.31, sy:11.31, px:3.76}, hooks:{bias:true,fov:true} };
const state = {
  lat: ls('lat') ?? null, lon: ls('lon') ?? null, windowH: ls('windowH') ?? 3,
  rig: ls('rig') ?? DEFAULT_RIG,
  thresholds: ls('gng') ?? {clouds:35, hum:90, vis:10},
  catalog: [
    {id:"M31", type:"GX", ra:"0.71h", dec:"41.3°", img:"https://upload.wikimedia.org/wikipedia/commons/5/5f/M31bobo11.jpg"},
    {id:"M33", type:"GX", ra:"1.55h", dec:"30.7°", img:"https://upload.wikimedia.org/wikipedia/commons/9/94/Triangulum_Galaxy_Messier_33_from_the_Mount_Lemmon_SkyCenter_Schmidt-Camera.jpg"},
    {id:"M27", type:"PN", ra:"19.89h", dec:"22.7°", img:"https://upload.wikimedia.org/wikipedia/commons/1/16/M27_Dumbbell_Nebula.jpg"},
    {id:"M57", type:"PN", ra:"18.89h", dec:"33.0°", img:"https://upload.wikimedia.org/wikipedia/commons/8/8e/M57_The_Ring_Nebula.JPG"},
    {id:"M13", type:"GC", ra:"16.70h", dec:"36.5°", img:"https://upload.wikimedia.org/wikipedia/commons/5/57/M13_-_The_Great_Globular_Cluster_in_Hercules.jpg"}
  ],
  wx: { clouds: null, vis: null, hum: null, aod: 0.12, pm25: 2.0, dT: 0.7, astroDark:true, sunAlt:-45, moonPct:7, moonAlt:-29, updated:null, transpText:"—" }
};

/* ========= RIG EDITOR ========= */
function fNumber(fl,dia){ return (fl/dia).toFixed(1); }
function computeRig(rig){
  const effFL = Math.round(rig.fl * rig.reducer);
  const fovX = 57.296 * rig.cam.sx / effFL;
  const fovY = 57.296 * rig.cam.sy / effFL;
  const scale = 206.265 * rig.cam.px / effFL;
  return {effFL, fovX, fovY, scale};
}
function renderRigSummary(){
  const r=state.rig, c=computeRig(r);
  $("#rig-efffl").textContent = `Eff. FL ${c.effFL} mm (${r.reducer}×)`;
  $("#rig-fov").textContent = `FOV ${c.fovX.toFixed(2)} × ${c.fovY.toFixed(2)}`;
  $("#rig-scale").textContent = `Scale ${c.scale.toFixed(2)} "/px`;
  $("#rig-scope").textContent = `${r.fl} × ${r.dia} mm (f/${fNumber(r.fl,r.dia)})`;
  $("#rig-reducer").textContent = `Reducer ${r.reducer}×`;
  $("#rig-preset-name").textContent = r.name || "custom";
}
function openRigEditor(open){
  $("#rig-editor").style.display = open? "block":"none";
  $("#btn-edit-rig").style.display = open? "none":"inline-flex";
  if(open){
    $("#in-fl").value = state.rig.fl;
    $("#in-dia").value = state.rig.dia;
    $("#in-sx").value = state.rig.cam.sx;
    $("#in-sy").value = state.rig.cam.sy;
    $("#in-px").value = state.rig.cam.px;
    // reducer buttons
    $$("#seg-reducer .toggle").forEach(el=>{
      el.classList.toggle('active', Number(el.dataset.mul)===state.rig.reducer);
    });
    $("#rig-efffl-editor").textContent = `${computeRig(state.rig).effFL} mm`;
  }
}
$("#btn-edit-rig").addEventListener('click', ()=>openRigEditor(true));
$("#btn-close-rig").addEventListener('click', ()=>openRigEditor(false));
$("#sel-scope").addEventListener('change', e=>{
  const [name,fl,dia]= e.target.value.split('|');
  $("#in-fl").value=fl; $("#in-dia").value=dia;
});
$("#sel-cam").addEventListener('change', e=>{
  const [name,sx,sy,px]= e.target.value.split('|');
  $("#in-sx").value=sx; $("#in-sy").value=sy; $("#in-px").value=px;
});
$("#seg-reducer").addEventListener('click', e=>{
  const t=e.target.closest('.toggle'); if(!t) return;
  $$("#seg-reducer .toggle").forEach(el=>el.classList.remove('active'));
  t.classList.add('active');
  state.rig.reducer = Number(t.dataset.mul);
  $("#rig-efffl-editor").textContent = `${computeRig(state.rig).effFL} mm`;
});
$("#btn-save-rig").addEventListener('click', ()=>{
  const r=state.rig;
  r.fl=Number($("#in-fl").value||r.fl);
  r.dia=Number($("#in-dia").value||r.dia);
  r.cam.sx=Number($("#in-sx").value||r.cam.sx);
  r.cam.sy=Number($("#in-sy").value||r.cam.sy);
  r.cam.px=Number($("#in-px").value||r.cam.px);
  r.name = `SV503_533_${r.reducer}x`;
  ls('rig', r);
  renderRigSummary();
  renderCatalog(); // update FOV overlay sizing
  toast("Rig saved");
});
$("#btn-del-rig").addEventListener('click', ()=>{
  ls('rig', DEFAULT_RIG);
  state.rig = JSON.parse(JSON.stringify(DEFAULT_RIG));
  renderRigSummary(); openRigEditor(false);
  renderCatalog();
  toast("Preset reset to default");
});
$("#hook-fov").addEventListener('click', e=>{
  e.currentTarget.classList.toggle('active');
  state.rig.hooks.fov = e.currentTarget.classList.contains('active');
  renderCatalog();
});
$("#hook-bias").addEventListener('click', e=>{
  e.currentTarget.classList.toggle('active');
  state.rig.hooks.bias = e.currentTarget.classList.contains('active');
  toast(state.rig.hooks.bias? "Top-5 will bias to your FOV":"Top-5 bias disabled");
});

/* ========= QUICK SETUP / WEATHER ========= */
function loadSavedBasics(){
  if(state.lat!=null) $("#in-lat").value = state.lat;
  if(state.lon!=null) $("#in-lon").value = state.lon;
  $("#in-window").value = state.windowH;
}
$("#btn-gps").addEventListener('click', ()=>{
  if(!navigator.geolocation){ toast("GPS not available"); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    state.lat = Number(pos.coords.latitude.toFixed(5));
    state.lon = Number(pos.coords.longitude.toFixed(5));
    $("#in-lat").value = state.lat; $("#in-lon").value=state.lon;
    ls('lat',state.lat); ls('lon',state.lon);
    toast("GPS location set");
  }, ()=>toast("GPS failed"));
});
$("#btn-calc").addEventListener('click', ()=>{
  state.lat = Number($("#in-lat").value||state.lat);
  state.lon = Number($("#in-lon").value||state.lon);
  state.windowH = Number($("#in-window").value||state.windowH);
  ls('lat',state.lat); ls('lon',state.lon); ls('windowH',state.windowH);
  recalcAll();
});

/* Open-Meteo (hourly) + simple transparency score */
async function fetchWeather(){
  if(state.lat==null || state.lon==null) return;
  const hours = Math.max(1,Math.min(12,state.windowH));
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${state.lat}&longitude=${state.lon}&hourly=cloud_cover,relative_humidity_2m,visibility&forecast_days=1`;
  try{
    const r = await fetch(url); const j = await r.json();
    const cc = j.hourly.cloud_cover.slice(0, hours);
    const rh = j.hourly.relative_humidity_2m.slice(0, hours);
    const vis = j.hourly.visibility.slice(0, hours).map(v=>Math.round(v/1000)); // m -> km
    state.wx.clouds = Math.max(...cc);
    state.wx.hum = Math.round(cc.length? rh.reduce((a,b)=>a+b)/rh.length : 0);
    state.wx.vis = Math.min(...vis);
    state.wx.updated = new Date();
    // transparency heuristic (you can swap in your own)
    const h=state.wx.hum, v=state.wx.vis;
    let txt="Great"; if(h>90 || v<8) txt="Bad"; else if(h>80 || v<12) txt="Okay";
    state.wx.transpText=txt;
  }catch(e){ console.error(e); toast("Weather fetch failed"); }
}

/* ========= TOP-5 (toy scoring + FOV bias) ========= */
function messierWikiLink(id){ return `https://en.wikipedia.org/wiki/Messier_${id.replace('M','')}`; }
function computeTop5(){
  // naive score: prefer larger altitude gap from moon (not available here),
  // so just prioritize by catalog order + FOV bias
  const r=state.rig, c=computeRig(r), diagFov=Math.hypot(c.fovX,c.fovY);
  const bias = r.hooks.bias? (m=>{ // galaxies like wider FOV
    const want = (m.type==="GX"? 2.0 : m.type==="GC"? 1.0 : 1.5);
    return Math.max(0, 1.5 - Math.abs(diagFov - want)); // closeness
  }) : (()=>1);

  const scored = state.catalog.map(m=>({m,score:Math.random()*0.8 + bias(m)}))
                   .sort((a,b)=>b.score-a.score).slice(0,5).map(x=>x.m);
  return scored;
}
function renderTop5(items){
  const ol=$("#top5-list"); ol.innerHTML="";
  items.forEach((m,i)=>{
    const li=document.createElement('li');
    const link = document.createElement('a');
    link.href = messierWikiLink(m.id); link.target="_blank"; link.textContent=m.id;
    li.appendChild(link);
    li.insertAdjacentText('beforeend', ` — ${m.id} — alt — —`);
    ol.appendChild(li);
  });
  onTop5Rendered();
}

/* ========= CATALOG + SEARCH ========= */
function renderCatalog(){
  const body=$("#cat-body"); body.innerHTML="";
  const q=($("#search").value||"").trim().toLowerCase();
  const items = state.catalog.filter(x=>{
    if(!q) return true;
    return x.id.toLowerCase().includes(q) || x.type.toLowerCase().includes(q);
  });
  items.forEach(m=>{
    const tr=document.createElement('tr');
    const imgCell = `<div class="thumb${state.rig.hooks.fov?' fov':''}"><img loading="lazy" src="${m.img}" alt="${m.id}"></div>`;
    tr.innerHTML = `<td><a href="${messierWikiLink(m.id)}" target="_blank">${m.id}</a></td>
                    <td>${m.type}</td><td>${m.ra}</td><td>${m.dec}</td><td>${imgCell}</td>`;
    body.appendChild(tr);
  });
}
$("#search").addEventListener('input', renderCatalog);
$("#btn-clear-search").addEventListener('click', ()=>{ $("#search").value=""; renderCatalog(); });

/* ========= GO/NO-GO DECISION ========= */
function decideGoNoGo(){
  const th = state.thresholds;
  const clouds = state.wx.clouds ?? 100;
  const vis = state.wx.vis ?? 0;
  const hum = state.wx.hum ?? 100;

  const go = (clouds <= th.clouds) && (vis >= th.vis);
  $("#status-decision").textContent = go ? "GO" : "NO-GO";
  $("#status-decision").className = `chip ${go?'ok':'bad'}`;
  $("#status-clouds").textContent = `~${clouds ?? '—'}%`;
  $("#status-vis").textContent = `Vis ${vis ?? '—'} km`;
  $("#status-astro").textContent = state.wx.astroDark ? "Astro dark" : "Not astro dark";
  $("#status-updated").textContent = state.wx.updated ? `Updated ${state.wx.updated.toLocaleTimeString()}` : "Updated —:—";
  $("#status-sun").textContent = `Sun alt ${state.wx.sunAlt}°`;
  $("#status-moon").textContent = `Moon ${state.wx.moonPct}%`;
  $("#status-transp").textContent = `Transparency ${state.wx.transpText}`;

  $("#cond-moon").textContent = `${state.wx.moonPct}%`;
  $("#cond-moon-alt").textContent = `Alt ${state.wx.moonAlt}°`;
  $("#cond-clouds").textContent = `${clouds ?? '—'}%`;
  $("#cond-hum").textContent = `${hum ?? '—'}%`;
  $("#cond-transp").textContent = state.wx.transpText;
  $("#cond-transp-detail").textContent = `AOD ${state.wx.aod} · PM2.5 ${state.wx.pm25} · RH ${hum}% · Vis ${vis}km · ΔT ${state.wx.dT}°C · ${0}`;
  $("#cond-updated").textContent = $("#status-updated").textContent;
  $("#cond-sun").textContent = $("#status-sun").textContent;
}
$("#btn-save-gng").addEventListener('click', ()=>{
  state.thresholds.clouds = Number($("#th-clouds").value||state.thresholds.clouds);
  state.thresholds.hum = Number($("#th-hum").value||state.thresholds.hum);
  state.thresholds.vis = Number($("#th-vis").value||state.thresholds.vis);
  ls('gng', state.thresholds);
  toast("Go/No-Go thresholds saved");
});

/* ========= RECALC PIPELINE ========= */
async function recalcAll(){
  toast("Calculating…");
  await fetchWeather();
  decideGoNoGo();
  renderRigSummary();
  renderCatalog();
  const top = computeTop5(); renderTop5(top);
  toast("Updated");
}

/* ========= BOOT ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  // load saved basics
  loadSavedBasics();
  // apply saved thresholds
  $("#th-clouds").value = state.thresholds.clouds;
  $("#th-hum").value = state.thresholds.hum;
  $("#th-vis").value = state.thresholds.vis;

  initCardStates();
  renderRigSummary();
  renderCatalog();
  decideGoNoGo();

  // initial compute if we have coords
  if(state.lat!=null && state.lon!=null){ recalcAll(); }
});
</script>
</body>
</html>
