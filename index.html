<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Nightly Go/No-Go v26.4</title>
<meta name="theme-color" content="#0b1620" />
<style>
/* ============ Core Theme ============ */
:root{
  --bg:#0e1a25;
  --panel:#122233;
  --panel-2:#16293d;
  --text:#dce6f4;
  --muted:#98a7bd;
  --accent:#4da3ff;
  --ok:#2ecc71;
  --warn:#f0b429;
  --bad:#ff5964;
  --chip:#0f2030;
  --ring:rgba(255,255,255,.08);
  --shadow:0 8px 28px rgba(0,0,0,.35);
  --radius:18px;
  --radius-sm:14px;
  --gap:16px;
  --card-pad:18px;
  --chip-pad:10px 14px;
  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:linear-gradient(180deg,#0b1620,#0b1620 220px,#0e1a25 220px);
  color:var(--text); font:16px/1.45 var(--font);
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
}
.container{max-width:1000px;margin:0 auto;padding:20px}
h1{margin:0 0 4px;font-size:44px;letter-spacing:.5px}
.subv{opacity:.6;font-size:14px;margin:4px 0 14px}
.controls{display:flex;gap:12px;flex-wrap:wrap}
.btn{
  background:var(--panel-2); color:var(--text); border:1px solid var(--ring);
  padding:10px 16px; border-radius:999px; cursor:pointer; transition:.18s;
}
.btn:hover{transform:translateY(-1px)}
.btn-outline{background:transparent}
.badge{
  display:inline-flex;align-items:center;gap:10px;padding:14px 16px;border-radius:999px;
  border:1px solid var(--ring); background:#102033; font-weight:700; letter-spacing:.3px;
}
.badge .dot{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;
  outline:2px solid #1e3b29;outline-offset:-2px; background:#0f1f16}
.badge .dot.go{outline-color:#1b5232;color:#bfffd4}
.badge .dot.warn{outline-color:#5a4a17;color:#ffe6a9}
.badge .dot.no{outline-color:#5a1a1e;color:#ffc1c6}
.card{
  background:var(--panel); border:1px solid var(--ring); border-radius:var(--radius);
  padding:var(--card-pad); box-shadow:var(--shadow); position:relative;
}
.stack{display:grid;gap:var(--gap)}
.grid-2{display:grid;grid-template-columns:1fr 1fr; gap:var(--gap)}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr); gap:var(--gap)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.chip{background:var(--chip);border:1px solid var(--ring);padding:var(--chip-pad);border-radius:999px;color:var(--text)}
.kv{background:var(--panel-2);border:1px solid var(--ring);border-radius:var(--radius-sm);padding:16px}
.kv h4{margin:0 0 6px;font-size:15px;opacity:.8}
.kv .big{font-weight:800;font-size:28px}
.kv .sub{opacity:.7;margin-top:6px}
.section-title{font-size:28px;margin:8px 0 10px}
.right-actions{position:absolute;right:12px;top:12px}
.dd{background:var(--chip);border:1px solid var(--ring);border-radius:12px;padding:6px 10px}

/* Inputs */
input[type="text"], input[type="number"], select{
  width:100%;background:var(--panel-2);color:var(--text);border:1px solid var(--ring);
  border-radius:12px;padding:12px 14px;font-size:16px;outline:none;
}
.range{width:100%}
.toggle{
  background:var(--panel-2); border:1px solid var(--ring); padding:10px 14px;
  border-radius:18px; display:inline-flex; gap:10px;
}
.toggle .opt{padding:8px 12px;border-radius:12px;border:1px solid transparent;cursor:pointer}
.toggle .opt.active{border-color:var(--accent); box-shadow:0 0 0 2px rgba(77,163,255,.25) inset}

/* Catalog table */
.table{width:100%;border-collapse:separate;border-spacing:0 10px}
.table th{font-weight:600; text-align:left; opacity:.7; padding:0 10px 4px}
.table td{background:var(--panel);border:1px solid var(--ring);padding:12px 10px;border-radius:12px}
.table td.img{width:72px}
.thumb{width:64px;height:64px;object-fit:cover;border-radius:10px;border:1px solid var(--ring);cursor:pointer}

/* Image viewer */
#viewer{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:9999}
#viewer img{max-width:96vw;max-height:92vh;display:block}
#viewer .close{position:absolute;top:14px;right:14px;background:#0008;border:1px solid #fff3;color:#fff;padding:10px 14px;border-radius:999px;cursor:pointer}

/* Toasts */
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
  color:#fff;padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);z-index:9000;
  font-weight:600}
.toast.info{background:#2d6cdf}
.toast.success{background:#1f9d57}
.toast.warn{background:#b88916}
.toast.error{background:#bf2d36}

/* Collapsible */
.collapsible > .collapser{position:absolute;right:14px;top:10px}
.collapsible .body{transition:max-height .25s ease}
.collapsible.closed .body{max-height:0;overflow:hidden}

/* Compact mode */
.compact .card{padding:14px}
.compact .kv .big{font-size:24px}
.compact .section-title{font-size:22px}
.compact .badge{padding:10px 14px}
.compact .row .chip{padding:8px 12px}
.compact .grid-4{grid-template-columns:repeat(2,1fr)}

/* Small screens */
@media (max-width:680px){
  .grid-2{grid-template-columns:1fr}
  .grid-4{grid-template-columns:repeat(2,1fr)}
  h1{font-size:38px}
}
</style>
</head>
<body>
<div class="container" id="app">
  <h1>Nightly<br/>Go/No-Go</h1>
  <div class="subv">v26.4</div>

  <div class="controls">
    <button id="btnCompact" class="btn">Compact off</button>
    <button id="btnTheme" class="btn">Blue</button>
  </div>

  <!-- Status -->
  <section class="card collapsible" id="statusCard">
    <div class="collapser"><span class="dd">▾</span></div>
    <div class="stack">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="badge" id="statusBadge">
          <span class="dot go" id="statusDot">GO</span>
          <span id="statusText">GO · Clouds ~2% · Vis 18 km · Astro dark</span>
        </div>
        <div class="chip" id="updatedAt">Updated —</div>
      </div>
      <div class="row" id="statusChips">
        <span class="chip" id="chipSun">Sun alt —</span>
        <span class="chip" id="chipMoon">Moon —</span>
        <span class="chip" id="chipAlt">Alt —</span>
      </div>
    </div>
  </section>

  <!-- Sky -->
  <section class="card collapsible" id="skyCard">
    <div class="section-title">Sky</div>
    <div class="collapser"><span class="dd">▾</span></div>
    <div class="body">
      <div class="grid-4">
        <div class="kv">
          <h4>Astronomical dark</h4>
          <div class="big" id="astroDark">Yes</div>
          <div class="sub" id="sunAlt">Sun alt —</div>
        </div>
        <div class="kv">
          <h4>Moon illum</h4>
          <div class="big" id="moonPct">—</div>
          <div class="sub" id="moonAlt">Alt —</div>
        </div>
        <div class="kv">
          <h4>Humidity</h4>
          <div class="big" id="humidity">—</div>
        </div>
        <div class="kv">
          <h4>Transparency</h4>
          <div class="big" id="transparency">—</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Clouds -->
  <section class="card">
    <div class="section-title">Clouds (avg)</div>
    <input id="cloudSlider" class="range" type="range" min="0" max="100" value="8" />
    <div class="row" style="justify-content:space-between;margin-top:10px">
      <div class="row" style="gap:8px">
        <button class="btn" id="btnUseClouds">Use</button>
        <button class="btn" id="btnCalcClouds">Calculate</button>
      </div>
      <div class="chip" id="cloudSource">From Open-Meteo (hourly) • slider overrides</div>
    </div>
  </section>

  <!-- Quick setup -->
  <section class="card collapsible" id="qsCard">
    <div class="section-title">Quick setup</div>
    <div class="collapser"><span class="dd">▾</span></div>
    <div class="body">
      <div class="grid-2">
        <div>
          <label>Latitude (°)</label>
          <input id="lat" type="number" step="0.00001" />
        </div>
        <div>
          <label>Longitude (°)</label>
          <input id="lon" type="number" step="0.00001" />
        </div>
      </div>
      <div class="row" style="margin-top:12px;gap:10px">
        <button class="btn" id="btnGPS">Use GPS</button>
        <button class="btn" id="btnRecalc">Calculate Now</button>
      </div>
    </div>
  </section>

  <!-- Gear -->
  <section class="card collapsible" id="gearCard">
    <div class="section-title">Gear</div>
    <div class="collapser"><span class="dd">▾</span></div>
    <div class="body stack">
      <div>
        <label>Scope</label>
        <select id="scope">
          <option value="SV503-560">SVBONY SV503 80ED (560mm f/7)</option>
          <option value="Generic-400">Generic 400mm</option>
          <option value="Generic-800">Generic 800mm</option>
        </select>
      </div>

      <div>
        <label>Reducer / Barlow</label><br/>
        <div class="toggle" id="rb">
          <div class="opt active" data-mag="0.8">0.8x</div>
          <div class="opt" data-mag="1">1x</div>
          <div class="opt" data-mag="2">2x</div>
        </div>
      </div>

      <div>
        <label>Camera</label>
        <select id="camera">
          <option value="IMX533">ZWO ASI533MC Pro (IMX533)</option>
          <option value="IMX585">ZWO ASI585MC (IMX585)</option>
        </select>
      </div>

      <div class="grid-2">
        <div class="kv"><div class="big" id="fov">FOV 1.4° × 1.4°</div></div>
        <div class="kv"><div class="big" id="scale">Scale 1.73"/px</div></div>
      </div>

      <div class="grid-2">
        <div>
          <input id="presetName" type="text" placeholder="Preset name…" />
        </div>
        <div class="row" style="gap:10px">
          <button class="btn" id="btnSavePreset">Save</button>
          <select id="presetLoad"><option value="">Load preset…</option></select>
          <button class="btn" id="btnDeletePreset">Delete</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Recommendations -->
  <section class="card collapsible" id="recCard">
    <div class="section-title">Top 5 Recommendations</div>
    <div class="collapser"><span class="dd">▾</span></div>
    <div class="body">
      <div id="recs" class="stack"></div>
    </div>
  </section>

  <!-- Catalog -->
  <section class="card collapsible" id="catCard">
    <div class="section-title">Catalog (subset)</div>
    <div class="collapser"><span class="dd">▾</span></div>
    <div class="body">
      <table class="table" id="catTable">
        <thead>
          <tr>
            <th style="width:70px">ID</th>
            <th>Name</th>
            <th>Type</th>
            <th>RA</th>
            <th>Dec</th>
            <th class="img">Image</th>
          </tr>
        </thead>
        <tbody id="catBody"></tbody>
      </table>
    </div>
  </section>
</div>

<!-- Image Viewer -->
<div id="viewer">
  <button class="close" id="viewerClose">Close ✕</button>
  <img id="viewerImg" alt="target" />
</div>

<script>
/* ================= Helpers ================= */
const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];
const fmtPct = n => `${Math.round(n)}%`;
const nowText = () => new Date().toLocaleTimeString();
const toast = (msg, type='info', ms=1800) => {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(()=>{ el.remove(); }, ms);
};

/* ================= State ================= */
const STATE = {
  version: 'v26.4',
  lat: 37.16557,
  lon: -76.5684,
  hours: 3,
  clouds: 8,
  cloudSource: 'Open-Meteo (hourly)',
  moonPct: 7,
  moonAlt: -29,
  sunAlt: -44,
  humidity: 91,
  transparency: 'Bad',
  mag: 0.8,
  scope: 'SV503-560',
  camera: 'IMX533',
  compact: false,
  theme: 'blue',
  imgBase: 'https://raw.githubusercontent.com/jlevick82/Astrotarget/main/images/full/'
};

/* ================= UI Bind ================= */
function applyHeader(){
  $('#updatedAt').textContent = `Updated ${nowText()}`;
  $('#chipSun').textContent = `Sun alt ${STATE.sunAlt > 0 ? '+' : ''}${STATE.sunAlt}°`;
  $('#chipMoon').textContent = `Moon ${fmtPct(STATE.moonPct)}`;
  $('#chipAlt').textContent = `Alt ${STATE.moonAlt > 0 ? '+' : ''}${STATE.moonAlt}°`;
  $('#statusText').textContent = `GO · Clouds ~${fmtPct(STATE.clouds)} · Vis 18 km · Astro dark`;
  $('#statusDot').textContent = 'GO';
  $('#astroDark').textContent = (STATE.sunAlt <= -18) ? 'Yes' : 'No';
  $('#sunAlt').textContent = `Sun alt ${STATE.sunAlt}°`;
  $('#moonPct').textContent = fmtPct(STATE.moonPct);
  $('#moonAlt').textContent = `Alt ${STATE.moonAlt}°`;
  $('#humidity').textContent = `${STATE.humidity}%`;
  $('#transparency').textContent = STATE.transparency;
  $('#cloudSlider').value = STATE.clouds;
  $('#cloudSource').textContent = `From ${STATE.cloudSource} • slider overrides`;
}
function applyGear(){
  $('#scope').value = STATE.scope;
  $('#camera').value = STATE.camera;
  // crude FOV/scale demo text
  const baseF = STATE.scope==='SV503-560'?560:STATE.scope==='Generic-800'?800:400;
  const effF = Math.round(baseF * STATE.mag);
  const fov = (76/effF).toFixed(1);
  const scale = (206 * 3.76 / effF).toFixed(2);
  $('#fov').textContent = `FOV ${fov}° × ${fov}°`;
  $('#scale').textContent = `Scale ${scale}"/px`;
  $$('#rb .opt').forEach(o=>{
    o.classList.toggle('active', Number(o.dataset.mag)===STATE.mag);
  });
}
function applyCompact(){
  document.body.classList.toggle('compact', STATE.compact);
  $('#btnCompact').textContent = STATE.compact ? 'Compact on' : 'Compact off';
}
function applyTheme(){
  const next = STATE.theme; // only label swap for now
  $('#btnTheme').textContent = next[0].toUpperCase()+next.slice(1);
}

/* ================= Catalog ================= */
const CAT = [
  { id:'M31', name:'Andromeda Galaxy', type:'GX', ra:'0.71h', dec:'41.3°', img:'m31.jpg' },
  { id:'M33', name:'Triangulum Galaxy', type:'GX', ra:'1.55h', dec:'30.7°', img:'m33.jpg' },
  { id:'M27', name:'Dumbbell Nebula', type:'PN', ra:'19.89h', dec:'22.7°', img:'m27.jpg' },
  { id:'M57', name:'Ring Nebula', type:'PN', ra:'18.89h', dec:'33.0°', img:'m57.jpg' },
  { id:'M13', name:'Hercules Globular', type:'GC', ra:'16.70h', dec:'36.5°', img:'m13.jpg' },
  { id:'M45', name:'Pleiades', type:'OC', ra:'3.79h', dec:'24.1°', img:'m45.jpg' }
];
function buildCatalog(){
  const tb = $('#catBody'); tb.innerHTML = '';
  CAT.forEach(row=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.id}</td>
      <td>${row.name}</td>
      <td>${row.type}</td>
      <td>${row.ra}</td>
      <td>${row.dec}</td>
      <td class="img"><img class="thumb" data-id="${row.id}" src="${STATE.imgBase}${row.img}" alt="${row.id}"/></td>
    `;
    tb.appendChild(tr);
  });
}

/* ================= Recs ================= */
function buildRecs(){
  const container = $('#recs');
  container.innerHTML = '';
  const list = [
    'M27 — Dumbbell Nebula — alt 82° — 142° from Moon — 196%',
    'M31 — Andromeda Galaxy — alt 45° — 140° from Moon — 183%',
    'M33 — Triangulum Galaxy — alt 46° — 112° from Moon — 168%',
    'M57 — Ring Nebula — alt 44° — 115° from Moon — 155%',
    'M13 — Hercules Globular — alt 24° — 90° from Moon — 120%'
  ];
  list.forEach((t,i)=>{
    const p = document.createElement('div');
    p.textContent = `${i+1}. ${t}`;
    container.appendChild(p);
  });
}

/* ================= Presets ================= */
function loadPresetList(){
  const dd = $('#presetLoad'); dd.innerHTML = '<option value="">Load preset…</option>';
  const keys = Object.keys(localStorage).filter(k=>k.startsWith('preset.'));
  keys.sort().forEach(k=>{
    const opt = document.createElement('option');
    opt.value = k; opt.textContent = k.replace('preset.','');
    dd.appendChild(opt);
  });
}
function savePreset(){
  const name = $('#presetName').value.trim();
  if(!name){ toast('Enter a preset name', 'warn'); return; }
  const data = {
    scope: STATE.scope, camera: STATE.camera, mag: STATE.mag
  };
  localStorage.setItem('preset.'+name, JSON.stringify(data));
  loadPresetList();
  toast('Preset saved', 'success');
}
function applyPreset(key){
  try{
    const data = JSON.parse(localStorage.getItem(key)||'{}');
    if(!data.scope) return;
    STATE.scope = data.scope; STATE.camera = data.camera; STATE.mag = Number(data.mag)||STATE.mag;
    applyGear(); toast('Preset loaded', 'info');
  }catch(e){}
}
function deletePreset(){
  const key = $('#presetLoad').value;
  if(!key){ toast('Choose a preset', 'warn'); return; }
  localStorage.removeItem(key);
  loadPresetList();
  toast('Preset deleted', 'error');
}

/* ================= Weather (clouds) ================= */
async function calcClouds(){
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${STATE.lat}&longitude=${STATE.lon}&hourly=cloud_cover&forecast_days=1`;
  try{
    const r = await fetch(url);
    const j = await r.json();
    const arr = j?.hourly?.cloud_cover||[];
    const avg = arr.slice(0, STATE.hours||3).reduce((a,b)=>a+b,0)/(arr.length?Math.min(arr.length,STATE.hours||3):1);
    STATE.clouds = Math.round(avg);
    STATE.cloudSource = 'Open-Meteo (hourly)';
    applyHeader();
    toast(`Clouds ~${fmtPct(STATE.clouds)} from weather`, 'info');
  }catch(e){
    toast('Weather fetch failed', 'error');
  }
}

/* ================= Collapsible ================= */
function wireCollapsibles(){
  $$('.collapsible').forEach(sec=>{
    const toggle = sec.querySelector('.collapser');
    const body = sec.querySelector('.body') || sec.querySelector('.stack');
    if(!toggle || !body) return;
    toggle.addEventListener('click', ()=>{
      sec.classList.toggle('closed');
      toast(sec.classList.contains('closed')?'Collapsed':'Expanded','info',900);
    });
  });
}

/* ================= Viewer ================= */
function wireViewer(){
  $('#viewerClose').onclick = ()=> $('#viewer').style.display='none';
  document.addEventListener('click', (e)=>{
    const img = e.target.closest('.thumb');
    if(!img) return;
    $('#viewerImg').src = img.src;
    $('#viewer').style.display='flex';
  });
}

/* ================= Events ================= */
function wireEvents(){
  $('#btnCompact').onclick = ()=>{ STATE.compact = !STATE.compact; applyCompact(); };
  $('#btnTheme').onclick = ()=>{ STATE.theme = (STATE.theme==='blue'?'red':'blue'); applyTheme(); };

  $('#cloudSlider').oninput = e => { STATE.clouds = Number(e.target.value); STATE.cloudSource='Manual'; applyHeader(); };
  $('#btnUseClouds').onclick = ()=>{ STATE.cloudSource='Manual'; applyHeader(); toast('Using slider value', 'success'); };
  $('#btnCalcClouds').onclick = calcClouds;

  $('#btnGPS').onclick = async ()=>{
    try{
      const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:8000}));
      STATE.lat = +(pos.coords.latitude.toFixed(5));
      STATE.lon = +(pos.coords.longitude.toFixed(5));
      $('#lat').value = STATE.lat; $('#lon').value = STATE.lon;
      toast('Location updated', 'success');
    }catch{ toast('GPS unavailable', 'warn'); }
  };
  $('#btnRecalc').onclick = ()=>{ // simple recompute stub
    STATE.sunAlt = -44; STATE.moonAlt = 21; STATE.moonPct = 10;
    applyHeader(); buildRecs(); toast('Targets updated', 'info');
  };

  $('#lat').onchange = e=> STATE.lat = Number(e.target.value);
  $('#lon').onchange = e=> STATE.lon = Number(e.target.value);
  $('#scope').onchange = e=>{ STATE.scope = e.target.value; applyGear(); };
  $('#camera').onchange = e=>{ STATE.camera = e.target.value; applyGear(); };
  $$('#rb .opt').forEach(o=>{
    o.onclick = ()=>{ STATE.mag = Number(o.dataset.mag); applyGear(); };
  });

  $('#btnSavePreset').onclick = savePreset;
  $('#presetLoad').onchange = e=> e.target.value && applyPreset(e.target.value);
  $('#btnDeletePreset').onclick = deletePreset;
}

/* ================= Init ================= */
function init(){
  // restore coords if present
  try{
    const s = JSON.parse(localStorage.getItem('astro.state')||'{}');
    Object.assign(STATE, s);
  }catch{}
  $('#lat').value = STATE.lat; $('#lon').value = STATE.lon;
  applyHeader(); applyGear(); applyCompact(); applyTheme();
  buildRecs(); buildCatalog(); loadPresetList();
  wireEvents(); wireViewer(); wireCollapsibles();
  // persist
  window.addEventListener('beforeunload', ()=> localStorage.setItem('astro.state', JSON.stringify(STATE)));
}
init();
</script>
</body>
</html>
