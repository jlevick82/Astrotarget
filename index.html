<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Go/No-Go v28.2</title>
<style>
:root{
  --bg:#0a1116; --panel:#0f1720; --panel2:#0b131a;
  --text:#e8f4ff; --muted:#99b8cc; --ring:#21313c; --chip:#121b23;
  --accent:#59c4ff; --ok:#7ad2a5; --warn:#ffd76a; --bad:#ff8f8f;
  --shadow:0 10px 35px rgba(0,0,0,.45);
  --radius:16px;
  --pill-r:22px;
  font-synthesis-weight:none;
}
*{box-sizing:border-box}
html,body{margin:0;background:radial-gradient(1200px 600px at 50% -80px,#0e2a3b 0%,#0b1821 50%,#0a1116 100%);color:var(--text);font:500 16px/1.5 system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial}
h1,h2,h3{margin:0 0 12px}
a{color:#9fd0ff;text-decoration:none}
.wrap{max-width:980px;margin:24px auto;padding:0 16px}
.header{display:flex;align-items:flex-end;gap:12px;margin:12px 0 20px}
.title{font-weight:800;font-size:42px;letter-spacing:.5px}
.ver{opacity:.7;font-weight:700;font-size:32px}
.btn{background:var(--chip);border:1px solid var(--ring);color:var(--text);padding:10px 16px;border-radius:999px;box-shadow:var(--shadow);cursor:pointer;user-select:none}
.btn:active{transform:translateY(1px)}
.card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin:18px 0;position:relative}
.card-title{font-size:28px;font-weight:800;margin:2px 0 14px}
.pills{display:flex;flex-wrap:wrap;gap:10px}
.pill{background:var(--chip);border:1px solid var(--ring);padding:7px 12px;border-radius:999px;color:var(--text);display:inline-flex;align-items:center;gap:8px}
.pill.bad{color:var(--bad);border-color:#442224;background:#1b0f12}
.pill.ok{color:var(--ok);border-color:#1d3328;background:#0d1812}
.kv{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.kv .box{border:1px solid var(--ring);border-radius:14px;padding:14px;background:#0d151d}
.kv .big{font-size:34px;font-weight:900;letter-spacing:.5px;display:block;margin-top:4px}
hr.sep{border:0;height:1px;background:linear-gradient(90deg,transparent,#20303b,transparent);margin:16px 0}

.toggle{position:absolute;right:14px;top:14px}
.chev{width:46px;height:46px;border-radius:12px;border:1px solid var(--ring);background:#0d141a;display:grid;place-items:center;cursor:pointer}
.chev:after{content:"⌄";font-size:20px;transform:rotate(180deg);opacity:.8}
.card[data-collapsed="true"] .chev:after{transform:none}
.card[data-collapsed="true"] .collapse{display:none}

.slider{appearance:none;width:100%;height:10px;border-radius:8px;background:#e9edf1;outline:none}
.slider::-webkit-slider-thumb{appearance:none;width:22px;height:22px;border-radius:50%;background:#428cff;border:2px solid #173554;box-shadow:0 2px 6px rgba(0,0,0,.4)}
.slider-row{display:grid;grid-template-columns:1fr 86px;gap:12px;align-items:center;margin:10px 0}
.slider-help{color:var(--muted);font-size:13px;margin-top:-4px}

.tbl{border:1px solid var(--ring);border-radius:14px;overflow:hidden}
.tbl-head,.tbl-row{display:grid;grid-template-columns:1.3fr .6fr .6fr .6fr 96px}
.tbl-head{position:sticky;top:0;z-index:1;background:rgba(255,255,255,.06);backdrop-filter:saturate(120%) blur(6px)}
.cell{padding:10px 12px;border-bottom:1px solid var(--ring);display:flex;align-items:center;min-height:56px}
.tbl-row{cursor:pointer}
.tbl-row:hover{background:rgba(255,255,255,.04)}
.gallery{max-height:360px;overflow:auto}
.thumb{width:60px;height:60px;border-radius:12px;border:1px solid var(--ring);background:#0b1b23 center/cover no-repeat;position:relative}
.thumb img{width:100%;height:100%;object-fit:cover;border-radius:12px;display:block}
.badge{position:absolute;bottom:-8px;right:-8px;background:#0b1b23;border:1px solid var(--ring);border-radius:16px;padding:2px 8px;color:#cfeaff;font-size:12px}

.controls{display:flex;gap:10px;flex-wrap:wrap}

/* toasts */
.toast{position:fixed;left:16px;right:16px;bottom:16px;display:grid;place-items:center;pointer-events:none}
.toast>div{background:#0f1720;border:1px solid var(--ring);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);max-width:520px}
.toast.hide{display:none}

/* compact */
.compact .kv{grid-template-columns:1fr 1fr;gap:10px}
.compact .cell{padding:8px 10px;min-height:50px}
.compact .thumb{width:52px;height:52px}
</style>
</head>
<body>
<div class="wrap" id="app">
  <div class="header">
    <div class="title">Go/No-Go</div>
    <div class="ver">v28.2</div>
  </div>
  <div class="controls">
    <button class="btn" id="toggleCompact">Compact Off</button>
    <button class="btn" id="toggleTheme">Normal Mode</button>
  </div>

  <!-- STATUS -->
  <section class="card" id="cardStatus">
    <div class="toggle"><div class="chev"></div></div>
    <div class="card-title">Status</div>
    <div class="pills" id="statusLine"></div>
    <div class="pills" style="margin-top:12px">
      <span class="pill" id="pUpdated">Updated —:—</span>
      <span class="pill" id="pSun">Sun alt —</span>
      <span class="pill" id="pMoon">Moon —</span>
      <span class="pill" id="pTrans">Transparency —</span>
    </div>
    <div class="collapse"></div>
  </section>

  <!-- CONDITIONS (merged Sky + Clouds) -->
  <section class="card" id="cardCond">
    <div class="toggle"><div class="chev"></div></div>
    <div class="card-title">Conditions</div>
    <div class="kv">
      <div class="box">
        <div>Moon illum</div>
        <span class="big" id="cMoonPct">—</span>
        <div class="muted" id="cMoonAlt">Alt —</div>
      </div>
      <div class="box">
        <div>Clouds (window max)</div>
        <span class="big" id="cClouds">—</span>
        <div class="muted">From Open-Meteo (window max)</div>
      </div>
      <div class="box">
        <div>Humidity</div>
        <span class="big" id="cHum">—</span>
      </div>
      <div class="box">
        <div>Transparency</div>
        <span class="big" id="cTransBig">—</span>
        <div class="muted" id="cTransLine">—</div>
      </div>
    </div>
  </section>

  <!-- GO / NO-GO SETTINGS -->
  <section class="card" id="cardRules">
    <div class="toggle"><div class="chev"></div></div>
    <div class="card-title">Go/No-Go Settings</div>
    <div class="slider-row">
      <label>Cloud weight <small>(how much clouds drive the decision)</small></label>
      <input id="wCloud" class="slider" type="range" min="0" max="100" step="1">
    </div>
    <div class="slider-help">Higher = more sensitive to clouds. 0 ignores clouds; 100 makes clouds dominate.</div>

    <div class="slider-row">
      <label>Transparency weight <small>(impact of transparency)</small></label>
      <input id="wTrans" class="slider" type="range" min="0" max="100" step="1">
    </div>
    <div class="slider-help">Higher = hazy/poor transparency blocks a “GO” sooner.</div>

    <div class="slider-row">
      <label>Min visibility (km) <small>(below this is likely no-go)</small></label>
      <input id="minVis" class="slider" type="range" min="2" max="30" step="1">
    </div>

    <div class="slider-row">
      <label>Moon tolerance (%) <small>(max illumination allowed for GO)</small></label>
      <input id="moonTol" class="slider" type="range" min="0" max="100" step="1">
    </div>

    <div class="slider-row">
      <label>Humidity penalty <small>(extra caution when RH is high)</small></label>
      <input id="humPen" class="slider" type="range" min="0" max="100" step="1">
    </div>
    <div class="slider-help">This adds to “risk” when humidity is high—useful for dew-prone setups.</div>

    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="btn" id="saveRules">Save Rules</button>
      <button class="btn" id="resetRules">Reset Defaults</button>
      <span id="rulesEcho" style="align-self:center;color:var(--muted)"></span>
    </div>
  </section>

  <!-- TOP 5 -->
  <section class="card" id="cardTop">
    <div class="toggle"><div class="chev"></div></div>
    <div class="card-title">Top 5 Recommendations</div>
    <ol id="topList" style="padding-left:22px;margin:0"></ol>
  </section>

  <!-- SEARCH -->
  <section class="card" id="cardSearch">
    <div class="toggle"><div class="chev"></div></div>
    <div class="card-title">Search</div>
    <div class="controls" style="margin-bottom:12px">
      <input id="searchBox" class="pill" style="width:260px" placeholder="Search catalog (name/type)"/>
      <button class="btn" id="clearSearch">Clear</button>
    </div>
    <div class="tbl">
      <div class="tbl-head">
        <div class="cell">Name</div>
        <div class="cell">Type</div>
        <div class="cell">RA</div>
        <div class="cell">Dec</div>
        <div class="cell">Image</div>
      </div>
      <div class="gallery" id="searchBody"></div>
    </div>
  </section>

  <!-- CATALOG -->
  <section class="card" id="cardCat">
    <div class="toggle"><div class="chev"></div></div>
    <div class="card-title">Catalog (subset)</div>
    <div class="tbl">
      <div class="tbl-head">
        <div class="cell">Name</div>
        <div class="cell">Type</div>
        <div class="cell">RA</div>
        <div class="cell">Dec</div>
        <div class="cell">Image</div>
      </div>
      <div class="gallery" id="catalogBody"></div>
    </div>
  </section>

  <!-- RIG SUMMARY (top pills only; full rig editor omitted for length) -->
  <section class="card" id="cardRig">
    <div class="toggle"><div class="chev"></div></div>
    <div class="card-title">Rig (Scope + Camera)</div>
    <div class="pills">
      <span class="pill" id="sumEff">Eff. FL —</span>
      <span class="pill" id="sumFOV">FOV — × —</span>
      <span class="pill" id="sumScale">Scale — "/px</span>
      <span class="pill" id="sumScope">560 × 80 mm (f/7.0)</span>
      <span class="pill">Reducer 0.8×</span>
    </div>
  </section>

  <!-- TOAST -->
  <div id="toast" class="toast hide"><div id="toastMsg"></div></div>
</div>

<script>
/* ---------- tiny helpers ---------- */
const $=s=>document.querySelector(s);
function toast(msg){ const t=$("#toast"); $("#toastMsg").textContent=msg; t.classList.remove("hide"); setTimeout(()=>t.classList.add("hide"),1800); }
function pill(txt,klass=""){const s=document.createElement("span");s.className="pill"+(klass?(" "+klass):"");s.textContent=txt;return s;}

/* ---------- demo data (replace with live later) ---------- */
const CATALOG=[
  {name:"M31",type:"GX",ra:"0.71h",dec:"41.3°",img:"https://upload.wikimedia.org/wikipedia/commons/5/5f/M31bobo.jpg"},
  {name:"M33",type:"GX",ra:"1.55h",dec:"30.7°",img:"https://upload.wikimedia.org/wikipedia/commons/5/55/Triangulum_Galaxy_Messier_33_from_the_Mount_Lemmon_SkyCenter_Schulman_Telescope_courtesy_Adam_Block.jpg"},
  {name:"M27",type:"PN",ra:"19.89h",dec:"22.7°",img:"https://upload.wikimedia.org/wikipedia/commons/3/3f/Dumbbell_Nebula_-_HST_-_Potw2029a.jpg"},
  {name:"M57",type:"PN",ra:"18.89h",dec:"33.0°",img:"https://upload.wikimedia.org/wikipedia/commons/0/0d/M57_The_Ring_Nebula.JPG"},
  {name:"M13",type:"GC",ra:"16.70h",dec:"36.5°",img:"https://upload.wikimedia.org/wikipedia/commons/4/4d/M13_-_Hercules_Globular_Cluster.jpg"},
];
const WIKI_MAP={M31:"Andromeda_Galaxy",M33:"Messier_33",M27:"Messier_27",M57:"Messier_57",M13:"Messier_13"};

/* ---------- user-tunable rules ---------- */
const DEFAULT_RULES={ wCloud:70, wTrans:40, minVis:12, moonTol:50, humPen:15 };
const rules = JSON.parse(localStorage.getItem("gng_rules")||"null")||DEFAULT_RULES;
function bindRules(){
  $("#wCloud").value=rules.wCloud;
  $("#wTrans").value=rules.wTrans;
  $("#minVis").value=rules.minVis;
  $("#moonTol").value=rules.moonTol;
  $("#humPen").value=rules.humPen;
  echoRules();
}
function echoRules(){
  $("#rulesEcho").textContent=`Cloud ${rules.wCloud} · Trans ${rules.wTrans} · Vis ≥ ${rules.minVis}km · Moon ≤ ${rules.moonTol}% · RH pen ${rules.humPen}`;
}
$("#saveRules").onclick=()=>{
  rules.wCloud=+$("#wCloud").value;
  rules.wTrans=+$("#wTrans").value;
  rules.minVis=+$("#minVis").value;
  rules.moonTol=+$("#moonTol").value;
  rules.humPen=+$("#humPen").value;
  localStorage.setItem("gng_rules",JSON.stringify(rules));
  echoRules(); applyStatus();
  toast("Go/No-Go rules saved");
};
$("#resetRules").onclick=()=>{
  Object.assign(rules,DEFAULT_RULES);
  localStorage.setItem("gng_rules",JSON.stringify(rules));
  bindRules(); applyStatus();
  toast("Rules reset to defaults");
};

/* ---------- fake “current conditions” (replace with your real fetch) ---------- */
const state={
  updated:new Date(),
  sunAlt:-45, moonPct:7, moonAlt:-29,
  clouds:7, vis:14, rh:86,
  transText:"Great", aod:0.12, pm25:"—", dT:0.7, aqi:0,
  showFOV:true
};

/* ---------- UI: collapsers, theme, compact ---------- */
document.querySelectorAll(".card .chev").forEach(c=>{
  c.addEventListener("click",()=>{
    const card=c.closest(".card");
    const col = card.getAttribute("data-collapsed")==="true";
    card.setAttribute("data-collapsed", col?"false":"true");
  });
});
$("#toggleTheme").onclick=()=>{
  document.body.classList.toggle("night");
  $("#toggleTheme").textContent=document.body.classList.contains("night")?"Night Mode":"Normal Mode";
};
$("#toggleCompact").onclick=()=>{
  document.body.classList.toggle("compact");
  $("#toggleCompact").textContent=document.body.classList.contains("compact")?"Compact On":"Compact Off";
};

/* ---------- status line ---------- */
function applyStatus(){
  const s=$("#statusLine"); s.innerHTML="";
  // compute a risk score 0..100
  const cloudRisk = state.clouds;               // 0..100
  const transRisk = ({"Great":10,"Good":25,"OK":40,"Poor":65,"Bad":85}[state.transText]||40);
  let risk = (rules.wCloud*cloudRisk + rules.wTrans*transRisk) / Math.max(1,(rules.wCloud+rules.wTrans));
  // humidity penalty
  risk += (state.rh/100)*rules.humPen;
  // hard gates
  const hardBlock = (state.vis < rules.minVis) || (state.moonPct > rules.moonTol && state.moonAlt>-5);
  const good = !hardBlock && risk < 50;

  s.appendChild(pill(good?"GO":"NO-GO", good?"ok":"bad"));
  s.appendChild(pill(`Clouds ~${state.clouds}%`));
  s.appendChild(pill(`Vis ${state.vis} km`));
  s.appendChild(pill(`Astro dark`));

  $("#pUpdated").textContent="Updated "+state.updated.toLocaleTimeString();
  $("#pSun").textContent=`Sun alt ${state.sunAlt}°`;
  $("#pMoon").textContent=`Moon ${state.moonPct}%`;
  $("#pTrans").textContent=`Transparency ${state.transText}`;
}
function renderConditions(){
  $("#cMoonPct").textContent=state.moonPct+"%";
  $("#cMoonAlt").textContent="Alt "+state.moonAlt+"°";
  $("#cClouds").textContent=state.clouds+"%";
  $("#cHum").textContent=state.rh+"%";
  $("#cTransBig").textContent=state.transText;
  $("#cTransLine").textContent=`AOD ${state.aod} · PM2.5 ${state.pm25} · RH ${state.rh}% · Vis ${state.vis}km · ΔT ${state.dT}°C · ${state.aqi}`;
}

/* ---------- shared table renderer ---------- */
function rowLink(name){ return `https://en.wikipedia.org/wiki/${WIKI_MAP[name]||encodeURIComponent(name)}`; }
function renderInto(container, rows){
  const body=$(container); body.innerHTML="";
  rows.forEach(r=>{
    const row=document.createElement("a");
    row.className="tbl-row";
    row.href=rowLink(r.name); row.target="_blank"; row.rel="noopener";
    row.innerHTML=`
      <div class="cell">${r.name}</div>
      <div class="cell">${r.type}</div>
      <div class="cell">${r.ra}</div>
      <div class="cell">${r.dec}</div>
      <div class="cell"><div class="thumb"><img loading="lazy" alt="${r.name}"></div></div>`;
    const img=row.querySelector("img");
    img.src=r.img;
    img.onerror=()=>{ img.style.display="none"; };
    body.appendChild(row);
  });
}

/* ---------- Top 5 list using same data ---------- */
function renderTop(){
  const ol=$("#topList"); ol.innerHTML="";
  CATALOG.forEach((r,i)=>{
    const li=document.createElement("li");
    li.style.margin="6px 0";
    const a=document.createElement("a");
    a.href=rowLink(r.name); a.target="_blank"; a.rel="noopener"; a.textContent=r.name;
    li.appendChild(a);
    li.insertAdjacentHTML("beforeend",` — ${(["Dumbbell Nebula","Andromeda Galaxy","Triangulum Galaxy","Ring Nebula","Hercules Globular"][i]||"")}`);
    ol.appendChild(li);
  });
}

/* ---------- Search ---------- */
$("#searchBox").addEventListener("input",()=>{
  const q=$("#searchBox").value.trim().toLowerCase();
  const rows = CATALOG.filter(r=>
    r.name.toLowerCase().includes(q) ||
    r.type.toLowerCase().includes(q)
  );
  renderInto("#searchBody", rows);
});
$("#clearSearch").onclick=()=>{ $("#searchBox").value=""; renderInto("#searchBody", CATALOG); }

/* ---------- Rig summary (static demo values) ---------- */
function calcRigSummary(){
  const baseFL=560, ap=80, factor=0.8;
  const effFL=Math.round(baseFL*factor);
  const w=11.31, h=11.31, px=3.76;
  const fovX=(57.2958*w/effFL).toFixed(2), fovY=(57.2958*h/effFL).toFixed(2);
  const scale=(206.265*px/effFL).toFixed(2);
  const fRatio=(baseFL/ap).toFixed(1);
  $("#sumEff").textContent=`Eff. FL ${effFL} mm (0.8×)`;
  $("#sumFOV").textContent=`FOV ${fovX} × ${fovY}`;
  $("#sumScale").textContent=`Scale ${scale} "/px`;
  $("#sumScope").textContent=`${baseFL} × ${ap} mm (f/${fRatio})`;
}

/* ---------- init ---------- */
bindRules();
applyStatus();
renderConditions();
renderTop();
renderInto("#catalogBody", CATALOG);
renderInto("#searchBody", CATALOG);
calcRigSummary();

/* ---------- collapse default off ---------- */
document.querySelectorAll(".card").forEach(c=>c.setAttribute("data-collapsed","false"));
</script>
</body>
</html>
