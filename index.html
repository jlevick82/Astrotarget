<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Go/No-Go v28.4</title>
<style>
  :root{
    --bg: #0f1b22;
    --panel: #111c23;
    --panel-2: #0c151b;
    --text: #dbe7ef;
    --muted: #9fb3c1;
    --accent: #8bd3ff;
    --ok: #2dc070;
    --bad: #ff6b6b;
    --ring: rgba(255,255,255,.08);
    --shadow: 0 12px 36px rgba(0,0,0,.35);
    --radius: 16px;
  }
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 700px at 50% -200px,#123,#0a1217) fixed,var(--bg);color:var(--text);font:15.5px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  *{box-sizing:border-box}
  a{color:#9fd1ff}
  .wrap{max-width:980px;margin:20px auto;padding:0 14px 80px}
  header.app{display:flex;align-items:flex-end;gap:12px;margin:0 0 10px}
  .title{font-weight:900;letter-spacing:.5px;font-size:38px}
  .ver{opacity:.65;font-weight:800;font-size:28px}
  .toolbar{display:flex;gap:10px;margin:10px 0 12px;flex-wrap:wrap}
  .btn{
    appearance:none;border:0;outline:0;padding:10px 14px;border-radius:999px;
    background:linear-gradient(#1a2a34,#141f26);color:var(--text);box-shadow:var(--shadow);cursor:pointer
  }
  .btn.small{padding:8px 12px;font-size:14px}
  .btn:active{transform:translateY(1px)}
  .badge{padding:6px 10px;border-radius:999px;border:1px solid var(--ring);background:#0e171c;white-space:nowrap}
  .badge.ok{background:#0e2216;border-color:#1b4d2f}
  .badge.bad{background:#2a1414;border-color:#6b2a2a}
  .chip{display:inline-flex;align-items:center;padding:10px 14px;border-radius:999px;background:#0f1a20;border:1px solid var(--ring)}
  .chip.ok{background:#0e2216;border-color:#205b35}
  .chip.bad{background:#2a1414;border-color:#6b2a2a}
  /* cards */
  .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--ring);
        border-radius:var(--radius);box-shadow:var(--shadow);margin:12px 0;overflow:hidden}
  .card-header{display:flex;align-items:center;justify-content:space-between;padding:14px 14px}
  .card-title{font-size:24px;font-weight:850;letter-spacing:.2px}
  .chev{width:38px;height:38px;border-radius:12px;background:linear-gradient(#18242c,#121b22);border:1px solid var(--ring);
        display:grid;place-items:center;color:#a9bdc9;cursor:pointer}
  .chev svg{transition:transform .2s ease}
  .chev[aria-expanded="true"] svg{transform:rotate(180deg)}
  .card-body{padding:12px 14px 16px}
  .grid{display:grid;gap:10px}
  .cols2{grid-template-columns:repeat(2,1fr)}
  .cols3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:820px){.cols2,.cols3{grid-template-columns:1fr}}
  .kv{display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:12px;border:1px solid var(--ring);background:#0f1a20}
  .kv h4{margin:0;font-weight:700;letter-spacing:.2px;color:#b7c7d1;font-size:13.5px}
  .big{font-size:28px;font-weight:900}
  .pill{display:inline-flex;align-items:center;padding:8px 12px;background:#0f1a20;border:1px solid var(--ring);border-radius:999px}
  /* inputs */
  input[type="text"], input[type="number"], select{
    width:100%;padding:10px 12px;border-radius:12px;color:var(--text);background:#0f1a20;border:1px solid var(--ring);
  }
  select{appearance:none}
  .seg{display:flex;gap:8px;flex-wrap:wrap}
  .seg .toggle{
    padding:8px 12px;border-radius:12px;border:1px solid var(--ring);background:#0f1a20;cursor:pointer;user-select:none
  }
  .seg .toggle.active{outline:2px solid var(--accent);box-shadow:0 0 0 6px rgba(139,211,255,.08) inset}
  /* table */
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{font-weight:700;color:#a9bdc9;text-align:left;padding:4px 8px}
  tbody td{padding:12px 8px;background:#0f1a20;border-top:1px solid var(--ring);border-bottom:1px solid var(--ring)}
  tbody tr td:first-child{border-left:1px solid var(--ring);border-top-left-radius:10px;border-bottom-left-radius:10px}
  tbody tr td:last-child{border-right:1px solid var(--ring);border-top-right-radius:10px;border-bottom-right-radius:10px}
  .thumb{position:relative;width:64px;height:64px;border-radius:12px;background:#0a141a;border:1px solid var(--ring);overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .thumb.fov:after{content:"";position:absolute;inset:18% 18%;border:2px dashed rgba(255,255,255,.6);border-radius:6px}
  /* toast */
  .toast-wrap{position:fixed;left:0;right:0;bottom:18px;display:grid;place-items:center;pointer-events:none;z-index:9999}
  .toast{pointer-events:auto;background:#0f1a20;border:1px solid var(--ring);box-shadow:var(--shadow);color:var(--text);
         border-radius:12px;padding:10px 12px;min-width:240px;text-align:center}
  /* compact */
  .compact .card-body{padding:10px}
  .compact .kv{padding:10px}
</style>
</head>
<body>
  <div class="wrap">
    <header class="app">
      <div class="title">Go/No-Go</div>
      <div class="ver">v28.4</div>
    </header>

    <div class="toolbar">
      <button id="btn-compact" class="btn">Compact On</button>
      <button id="btn-night" class="btn">Night Mode</button>
    </div>

    <!-- 1) STATUS -->
    <section id="card-status" class="card">
      <div class="card-header">
        <div class="card-title">Status</div>
        <button class="chev" data-target="card-status" aria-expanded="true" title="Collapse/Expand">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="card-body">
        <div class="grid cols3">
          <div class="kv"><h4>Decision</h4><div id="status-decision" class="chip ok">GO</div></div>
          <div class="kv"><h4>Clouds</h4><div id="status-clouds" class="pill">~—%</div></div>
          <div class="kv"><h4>Visibility</h4><div id="status-vis" class="pill">Vis — km</div></div>
        </div>
        <div class="grid cols3" style="margin-top:8px">
          <div class="pill" id="status-astro">Astro dark</div>
          <div class="pill" id="status-updated">Updated —:—</div>
          <div class="pill" id="status-sun">Sun alt —°</div>
          <div class="pill" id="status-moon">Moon —%</div>
          <div class="pill" id="status-transp">Transparency —</div>
        </div>
      </div>
    </section>

    <!-- 2) CONDITIONS -->
    <section id="card-conditions" class="card">
      <div class="card-header">
        <div class="card-title">Conditions</div>
        <button class="chev" data-target="card-conditions" aria-expanded="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="card-body">
        <div class="grid cols2">
          <div class="kv"><h4>Moon illum</h4><div class="big" id="cond-moon">—%</div><div class="muted" id="cond-moon-alt">Alt —°</div></div>
          <div class="kv"><h4>Clouds (window max)</h4><div class="big" id="cond-clouds">—%</div><div class="muted">From Open-Meteo (window max)</div></div>
          <div class="kv"><h4>Humidity</h4><div class="big" id="cond-hum">—%</div></div>
          <div class="kv"><h4>Transparency</h4><div class="big" id="cond-transp">—</div><div class="muted" id="cond-transp-detail"></div></div>
        </div>
        <div class="pill" id="cond-updated" style="margin-top:8px">Updated —:—</div>
      </div>
    </section>

    <!-- 3) QUICK SETUP -->
    <section id="card-quicksetup" class="card">
      <div class="card-header">
        <div class="card-title">Quick setup</div>
        <button class="chev" data-target="card-quicksetup" aria-expanded="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="card-body">
        <div class="grid cols3">
          <div class="kv">
            <h4>Latitude (°)</h4>
            <input id="in-lat" type="text" inputmode="decimal" placeholder="e.g. 37.16">
          </div>
          <div class="kv">
            <h4>Longitude (°)</h4>
            <input id="in-lon" type="text" inputmode="decimal" placeholder="e.g. -76.56">
          </div>
          <div class="kv">
            <h4>Hours (window)</h4>
            <input id="in-window" type="number" min="1" max="12" value="3">
          </div>
        </div>
        <div class="toolbar" style="gap:8px;margin-top:8px">
          <button id="btn-gps" class="btn small">Use GPS</button>
          <button id="btn-calc" class="btn small">Calculate Now</button>
        </div>
      </div>
    </section>

    <!-- 4) RIG -->
    <section id="card-rig" class="card">
      <div class="card-header">
        <div class="card-title">Rig (Scope + Camera)</div>
        <button class="chev" data-target="card-rig" aria-expanded="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="card-body">
        <div class="grid cols3" style="margin-bottom:8px">
          <span id="rig-efffl" class="badge">Eff. FL — mm</span>
          <span id="rig-fov" class="badge">FOV — × —</span>
          <span id="rig-scale" class="badge">Scale — "/px</span>
        </div>

        <!-- Newbie-friendly steps -->
        <div id="rig-editor">
          <!-- STEP 1 -->
          <div class="kv">
            <h4>Step 1 — Select Scope</h4>
            <select id="sel-scope">
              <option value="" selected disabled>Select Scope</option>
              <option value="SVBONY SV503|560|80">SVBONY SV503 (560 × 80)</option>
              <option value="William Z61|360|61">William Z61 (360 × 61)</option>
              <option value="Celestron C8|2032|203">Celestron C8 (2032 × 203)</option>
              <option value="custom">Custom…</option>
            </select>
            <div class="grid cols2" id="scope-custom" style="display:none;margin-top:8px">
              <input id="in-fl" type="number" placeholder="Focal length (mm)">
              <input id="in-dia" type="number" placeholder="Diameter (mm)">
            </div>
            <div class="muted">Tip: focal length ÷ diameter ≈ f-ratio.</div>
          </div>

          <!-- STEP 2 -->
          <div class="kv">
            <h4>Step 2 — Reducer / Barlow</h4>
            <div class="seg" id="seg-reducer">
              <span class="toggle" data-mul="0.63">0.63×</span>
              <span class="toggle" data-mul="0.7">0.7×</span>
              <span class="toggle" data-mul="0.8">0.8×</span>
              <span class="toggle active" data-mul="1">1×</span>
              <span class="toggle" data-mul="2">2×</span>
            </div>
            <div class="big" id="rig-efffl-editor" style="margin-top:6px">— mm</div>
          </div>

          <!-- STEP 3 -->
          <div class="kv">
            <h4>Step 3 — Select Camera</h4>
            <select id="sel-cam">
              <option value="" selected disabled>Select Camera</option>
              <option value="ZWO ASI533MC|11.31|11.31|3.76">ZWO ASI533MC (11.31×11.31 / 3.76µm)</option>
              <option value="ZWO ASI294MC|19.1|13.0|4.63">ZWO ASI294MC (19.1×13.0 / 4.63µm)</option>
              <option value="Sony A7 III|35.9|24.0|5.94">Sony A7 III (35.9×24.0 / 5.94µm)</option>
              <option value="custom">Custom…</option>
            </select>
            <div class="grid cols3" id="cam-custom" style="display:none;margin-top:8px">
              <input id="in-sx" type="number" step="0.01" placeholder="Sensor X (mm)">
              <input id="in-sy" type="number" step="0.01" placeholder="Sensor Y (mm)">
              <input id="in-px" type="number" step="0.01" placeholder="Pixel (µm)">
            </div>
            <div class="muted">Tip: pixel size + focal length ⇒ image scale (arcsec/pixel).</div>
          </div>

          <!-- STEP 4 -->
          <div class="kv">
            <h4>Step 4 — Save preset & options</h4>
            <div class="seg" style="margin-bottom:8px">
              <span id="hook-bias" class="toggle active">Bias Top-5 to FOV</span>
              <span id="hook-fov" class="toggle active">FOV overlay on thumbs</span>
            </div>
            <div class="grid cols3" style="align-items:end">
              <input id="preset-name" type="text" placeholder="Preset name (e.g., SV503_533_0.8x)">
              <button id="btn-save-rig" class="btn small">Save</button>
              <button id="btn-del-rig" class="btn small">Delete</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 5) TOP 5 -->
    <section id="card-top5" class="card">
      <div class="card-header">
        <div class="card-title">Top 5 Recommendations</div>
        <button class="chev" data-target="card-top5" aria-expanded="false">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="card-body">
        <ol id="top5-list" style="padding-left:18px;margin:0;display:grid;gap:8px"></ol>
      </div>
    </section>

    <!-- 6) CATALOG (closed) -->
    <section id="card-catalog" class="card">
      <div class="card-header">
        <div class="card-title">Catalog</div>
        <button class="chev" data-target="card-catalog" aria-expanded="false">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="card-body" style="display:none">
        <div class="grid cols2">
          <div class="kv"><h4>Search catalog (name/type)</h4><input id="search" type="text" placeholder="e.g., M31, galaxy, nebula…"></div>
          <div class="kv"><h4>&nbsp;</h4><button id="btn-clear-search" class="btn small">Clear</button></div>
        </div>
        <div style="overflow:auto;margin-top:4px">
          <table id="tbl-catalog">
            <thead><tr><th>Name</th><th>Type</th><th>RA</th><th>Dec</th><th>Image</th></tr></thead>
            <tbody id="cat-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 7) GO/NO-GO SETTINGS (closed) -->
    <section id="card-gng-settings" class="card">
      <div class="card-header">
        <div class="card-title">Go/No-Go Settings</div>
        <button class="chev" data-target="card-gng-settings" aria-expanded="false">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="card-body" style="display:none">
        <div class="grid cols3">
          <div class="kv"><h4>Clouds threshold (max in window)</h4><input id="th-clouds" type="number" value="35" min="0" max="100"><div class="muted">GO if ≤ this %</div></div>
          <div class="kv"><h4>Humidity threshold</h4><input id="th-hum" type="number" value="90" min="0" max="100"><div class="muted">Warn if ≥ this %</div></div>
          <div class="kv"><h4>Visibility threshold (km)</h4><input id="th-vis" type="number" value="10" min="1" max="50"><div class="muted">Warn if &lt; this</div></div>
        </div>
        <div class="toolbar" style="gap:8px;margin-top:8px">
          <button id="btn-save-gng" class="btn small">Save</button>
          <span class="muted">Applies on next calculation</span>
        </div>
      </div>
    </section>

    <!-- Toasts -->
    <div class="toast-wrap" id="toast-wrap" style="display:none"><div class="toast" id="toast"></div></div>
  </div>

<script>
/* ========== tiny helpers ========== */
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const ls = (k,v) => (v===undefined? JSON.parse(localStorage.getItem(k)||'null') : localStorage.setItem(k,JSON.stringify(v)));
function toast(msg){ const w=$("#toast-wrap"), t=$("#toast"); t.textContent=msg; w.style.display="grid"; clearTimeout(toast._t); toast._t=setTimeout(()=>w.style.display="none",2000); }
function setOpen(cardId, open){
  const card = document.getElementById(cardId);
  const body = card.querySelector('.card-body');
  const btn = card.querySelector('.chev');
  body.style.display = open ? '' : 'none';
  btn.setAttribute('aria-expanded', String(open));
}

/* ========== app state ========== */
const DEFAULT_RIG = { name:"SV503_533_0.8x", fl:560, dia:80, reducer:0.8, cam:{sx:11.31, sy:11.31, px:3.76}, hooks:{bias:true,fov:true}, initialized:true };
const state = {
  lat: ls('lat') ?? null, lon: ls('lon') ?? null, windowH: ls('windowH') ?? 3,
  thresholds: ls('gng') ?? {clouds:35, hum:90, vis:10},
  rig: ls('rig') ?? {initialized:false}, // first run: uninitialized to show placeholders
  catalog: [
    {id:"M31", type:"GX", ra:"0.71h", dec:"41.3°", img:"https://upload.wikimedia.org/wikipedia/commons/5/5f/M31bobo11.jpg"},
    {id:"M33", type:"GX", ra:"1.55h", dec:"30.7°", img:"https://upload.wikimedia.org/wikipedia/commons/9/94/Triangulum_Galaxy_Messier_33_from_the_Mount_Lemmon_SkyCenter_Schmidt-Camera.jpg"},
    {id:"M27", type:"PN", ra:"19.89h", dec:"22.7°", img:"https://upload.wikimedia.org/wikipedia/commons/1/16/M27_Dumbbell_Nebula.jpg"},
    {id:"M57", type:"PN", ra:"18.89h", dec:"33.0°", img:"https://upload.wikimedia.org/wikipedia/commons/8/8e/M57_The_Ring_Nebula.JPG"},
    {id:"M13", type:"GC", ra:"16.70h", dec:"36.5°", img:"https://upload.wikimedia.org/wikipedia/commons/5/57/M13_-_The_Great_Globular_Cluster_in_Hercules.jpg"}
  ],
  wx: { clouds:null, vis:null, hum:null, aod:0.12, pm25:2.0, dT:0.7, astroDark:true, sunAlt:-45, moonPct:7, moonAlt:-29, updated:null, transpText:"—" }
};

/* ========== theme & chevrons ========== */
$("#btn-compact").addEventListener('click', ()=>{ document.body.classList.toggle('compact'); $("#btn-compact").textContent = document.body.classList.contains('compact')? "Compact Off":"Compact On"; });
$("#btn-night").addEventListener('click', ()=>{ document.body.classList.toggle('night'); $("#btn-night").textContent = document.body.classList.contains('night')? "Normal Mode":"Night Mode"; });
document.addEventListener('click', e=>{
  const c = e.target.closest('.chev'); if(!c) return;
  const id = c.getAttribute('data-target') || c.closest('.card').id;
  const open = c.getAttribute('aria-expanded') !== 'true';
  setOpen(id, open);
});

/* ========== rig math & rendering ========== */
function computeRig(r){
  if(!r.fl || !r.dia || !r.reducer || !r.cam || !r.cam.sx || !r.cam.sy || !r.cam.px) return null;
  const effFL = Math.round(r.fl * r.reducer);
  const fovX = 57.296 * r.cam.sx / effFL;
  const fovY = 57.296 * r.cam.sy / effFL;
  const scale = 206.265 * r.cam.px / effFL;
  return {effFL, fovX, fovY, scale};
}
function renderRigSummary(){
  const r = state.rig.initialized ? state.rig : null;
  const c = r ? computeRig(r) : null;
  $("#rig-efffl").textContent = c ? `Eff. FL ${c.effFL} mm (${r.reducer}×)` : "Eff. FL — mm";
  $("#rig-fov").textContent   = c ? `FOV ${c.fovX.toFixed(2)} × ${c.fovY.toFixed(2)}` : "FOV — × —";
  $("#rig-scale").textContent = c ? `Scale ${c.scale.toFixed(2)} \"/px` : "Scale — \"/px";
}
function syncEditorFromRig(){
  // apply to selects/inputs and reducer buttons
  if(!state.rig.initialized){ // placeholders
    $("#sel-scope").value = "";
    $("#sel-cam").value = "";
    $("#scope-custom").style.display="none";
    $("#cam-custom").style.display="none";
    $("#rig-efffl-editor").textContent="— mm";
    $$("#seg-reducer .toggle").forEach(t=>t.classList.toggle('active', t.dataset.mul==="1"));
    return;
  }
  // scope
  const scopeOpt = `${state.rig.name?.includes("SV503")?"SVBONY SV503|560|80":""}`;
  if(scopeOpt) $("#sel-scope").value = scopeOpt;
  $("#scope-custom").style.display = "none";
  $("#in-fl").value = state.rig.fl;
  $("#in-dia").value = state.rig.dia;
  // reducer
  $$("#seg-reducer .toggle").forEach(t=>t.classList.toggle('active', Number(t.dataset.mul)===state.rig.reducer));
  // camera
  const camMatch = (sx,sy,px)=>{
    const v = `${sx}|${sy}|${px}`;
    for(const opt of $("#sel-cam").options){
      if(!opt.value || opt.value==="custom") continue;
      const parts = opt.value.split("|").slice(1).join("|");
      if(parts===v) return opt.value;
    }
    return "custom";
  };
  const camVal = camMatch(state.rig.cam.sx,state.rig.cam.sy,state.rig.cam.px);
  $("#sel-cam").value = camVal==="custom"?"custom":camVal;
  $("#cam-custom").style.display = camVal==="custom" ? "" : "none";
  $("#in-sx").value = state.rig.cam.sx;
  $("#in-sy").value = state.rig.cam.sy;
  $("#in-px").value = state.rig.cam.px;
  // eff FL preview
  const c = computeRig(state.rig);
  $("#rig-efffl-editor").textContent = c? `${c.effFL} mm` : "— mm";
  $("#preset-name").value = state.rig.name || "";
}
function touchRigAndRecompute(){
  renderRigSummary();
  renderCatalog();
}

/* editor interactions */
$("#sel-scope").addEventListener('change', e=>{
  const val = e.target.value;
  if(val==="custom"){
    $("#scope-custom").style.display="";
    state.rig.fl = Number($("#in-fl").value||0);
    state.rig.dia = Number($("#in-dia").value||0);
  }else{
    const [label,fl,dia] = val.split("|");
    $("#scope-custom").style.display="none";
    state.rig.fl = Number(fl); state.rig.dia = Number(dia);
  }
  state.rig.initialized = true;
  $("#rig-efffl-editor").textContent = computeRig({...state.rig})? `${computeRig(state.rig).effFL} mm` : "— mm";
  touchRigAndRecompute();
});
$("#in-fl").addEventListener('input', ()=>{ state.rig.fl = Number($("#in-fl").value||0); state.rig.initialized=true; $("#rig-efffl-editor").textContent = computeRig(state.rig)? `${computeRig(state.rig).effFL} mm` : "— mm"; touchRigAndRecompute(); });
$("#in-dia").addEventListener('input', ()=>{ state.rig.dia = Number($("#in-dia").value||0); state.rig.initialized=true; $("#rig-efffl-editor").textContent = computeRig(state.rig)? `${computeRig(state.rig).effFL} mm` : "— mm"; touchRigAndRecompute(); });

$("#seg-reducer").addEventListener('click', e=>{
  const t=e.target.closest('.toggle'); if(!t) return;
  $$("#seg-reducer .toggle").forEach(el=>el.classList.remove('active'));
  t.classList.add('active');
  state.rig.reducer = Number(t.dataset.mul);
  state.rig.initialized = true;
  $("#rig-efffl-editor").textContent = computeRig(state.rig)? `${computeRig(state.rig).effFL} mm` : "— mm";
  touchRigAndRecompute();
});

$("#sel-cam").addEventListener('change', e=>{
  const v=e.target.value;
  if(v==="custom"){
    $("#cam-custom").style.display="";
    state.rig.cam = {sx:Number($("#in-sx").value||0), sy:Number($("#in-sy").value||0), px:Number($("#in-px").value||0)};
  }else{
    const [label,sx,sy,px]=v.split("|");
    $("#cam-custom").style.display="none";
    state.rig.cam = {sx:Number(sx), sy:Number(sy), px:Number(px)};
  }
  state.rig.initialized = true;
  $("#rig-efffl-editor").textContent = computeRig(state.rig)? `${computeRig(state.rig).effFL} mm` : "— mm";
  touchRigAndRecompute();
});
["#in-sx","#in-sy","#in-px"].forEach(sel=>{
  $(sel).addEventListener('input', ()=>{
    state.rig.cam = {sx:Number($("#in-sx").value||0), sy:Number($("#in-sy").value||0), px:Number($("#in-px").value||0)};
    state.rig.initialized = true;
    $("#rig-efffl-editor").textContent = computeRig(state.rig)? `${computeRig(state.rig).effFL} mm` : "— mm";
    touchRigAndRecompute();
  });
});

$("#hook-fov").addEventListener('click', e=>{ e.currentTarget.classList.toggle('active'); state.rig.hooks ??= {}; state.rig.hooks.fov = e.currentTarget.classList.contains('active'); renderCatalog(); });
$("#hook-bias").addEventListener('click', e=>{ e.currentTarget.classList.toggle('active'); state.rig.hooks ??= {}; state.rig.hooks.bias = e.currentTarget.classList.contains('active'); toast(state.rig.hooks.bias? "Top-5 will bias to your FOV":"Top-5 bias disabled"); });

$("#btn-save-rig").addEventListener('click', ()=>{
  const name = ($("#preset-name").value||"").trim();
  state.rig.name = name || `SV503_533_${state.rig.reducer}x`;
  state.rig.initialized = true;
  ls('rig', state.rig);
  renderRigSummary();
  toast("Rig saved");
});
$("#btn-del-rig").addEventListener('click', ()=>{
  localStorage.removeItem('rig');
  state.rig = {initialized:false};
  syncEditorFromRig(); renderRigSummary(); renderCatalog();
  toast("Rig preset cleared");
});

/* ========== Catalog + Search ========== */
function messierWikiLink(id){ return `https://en.wikipedia.org/wiki/Messier_${id.replace('M','')}`; }
function renderCatalog(){
  const body=$("#cat-body"); if(!body) return;
  body.innerHTML="";
  const q=($("#search")?.value||"").trim().toLowerCase();
  const items = state.catalog.filter(x=>!q || x.id.toLowerCase().includes(q) || x.type.toLowerCase().includes(q));
  items.forEach(m=>{
    const tr=document.createElement('tr');
    const imgCell = `<div class="thumb ${state.rig?.hooks?.fov?'fov':''}"><img loading="lazy" src="${m.img}" alt="${m.id}"></div>`;
    tr.innerHTML = `<td><a href="${messierWikiLink(m.id)}" target="_blank">${m.id}</a></td>
                    <td>${m.type}</td><td>${m.ra}</td><td>${m.dec}</td><td>${imgCell}</td>`;
    body.appendChild(tr);
  });
}
$("#search")?.addEventListener('input', renderCatalog);
$("#btn-clear-search")?.addEventListener('click', ()=>{ $("#search").value=""; renderCatalog(); });

/* ========== Weather / Conditions / Decision ========== */
function decideGoNoGo(){
  const th = state.thresholds;
  const clouds = state.wx.clouds ?? 100;
  const vis = state.wx.vis ?? 0;
  const hum = state.wx.hum ?? 100;

  const go = (clouds <= th.clouds) && (vis >= th.vis);
  $("#status-decision").textContent = go ? "GO" : "NO-GO";
  $("#status-decision").className = `chip ${go?'ok':'bad'}`;
  $("#status-clouds").textContent = `~${clouds}%`;
  $("#status-vis").textContent = `Vis ${vis} km`;
  $("#status-astro").textContent = state.wx.astroDark ? "Astro dark" : "Not astro dark";
  $("#status-updated").textContent = state.wx.updated ? `Updated ${state.wx.updated.toLocaleTimeString()}` : "Updated —:—";
  $("#status-sun").textContent = `Sun alt ${state.wx.sunAlt}°`;
  $("#status-moon").textContent = `Moon ${state.wx.moonPct}%`;
  $("#status-transp").textContent = `Transparency ${state.wx.transpText}`;

  $("#cond-moon").textContent = `${state.wx.moonPct}%`;
  $("#cond-moon-alt").textContent = `Alt ${state.wx.moonAlt}°`;
  $("#cond-clouds").textContent = `${clouds}%`;
  $("#cond-hum").textContent = `${hum}%`;
  $("#cond-transp").textContent = state.wx.transpText;
  $("#cond-transp-detail").textContent = `AOD ${state.wx.aod} · PM2.5 ${state.wx.pm25} · RH ${hum}% · Vis ${vis}km · ΔT ${state.wx.dT}°C · 0`;
  $("#cond-updated").textContent = $("#status-updated").textContent;
}
$("#btn-save-gng").addEventListener('click', ()=>{
  state.thresholds.clouds = Number($("#th-clouds").value||state.thresholds.clouds);
  state.thresholds.hum = Number($("#th-hum").value||state.thresholds.hum);
  state.thresholds.vis = Number($("#th-vis").value||state.thresholds.vis);
  ls('gng', state.thresholds);
  toast("Go/No-Go thresholds saved");
});

async function fetchWeather(){
  if(state.lat==null || state.lon==null) return;
  const hours = Math.max(1,Math.min(12,state.windowH));
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${state.lat}&longitude=${state.lon}&hourly=cloud_cover,relative_humidity_2m,visibility&forecast_days=1`;
  try{
    const r = await fetch(url); const j = await r.json();
    const cc = j.hourly.cloud_cover.slice(0, hours);
    const rh = j.hourly.relative_humidity_2m.slice(0, hours);
    const vis = j.hourly.visibility.slice(0, hours).map(v=>Math.round(v/1000));
    state.wx.clouds = Math.max(...cc);
    state.wx.hum = Math.round(rh.reduce((a,b)=>a+b)/rh.length);
    state.wx.vis = Math.min(...vis);
    state.wx.updated = new Date();
    let txt="Great"; if(state.wx.hum>90 || state.wx.vis<8) txt="Bad"; else if(state.wx.hum>80 || state.wx.vis<12) txt="Okay";
    state.wx.transpText=txt;
  }catch(e){ console.error(e); toast("Weather fetch failed"); }
}

/* ========== Top-5 ========== */
function computeTop5(){
  const r=state.rig.initialized?state.rig:null;
  const c=r?computeRig(r):null;
  const diag = c? Math.hypot(c.fovX,c.fovY):null;
  const bias = r?.hooks?.bias? (m=>{ const want = (m.type==="GX"?2.0:m.type==="GC"?1.0:1.5); return diag? Math.max(0,1.5-Math.abs(diag-want)) : 1; }) : (()=>1);
  return state.catalog.map(m=>({m,score:Math.random()*0.8 + bias(m)})).sort((a,b)=>b.score-a.score).slice(0,5).map(x=>x.m);
}
function renderTop5(list){
  const ol=$("#top5-list"); ol.innerHTML="";
  list.forEach(m=>{
    const li=document.createElement('li');
    const a=document.createElement('a'); a.href=messierWikiLink(m.id); a.target="_blank"; a.textContent=m.id;
    li.appendChild(a); li.insertAdjacentText('beforeend', ` — ${m.id} — alt — —`);
    ol.appendChild(li);
  });
  // auto-open when (re)computed
  setOpen('card-top5', true);
}

/* ========== Quick setup buttons ========== */
function loadBasics(){
  if(state.lat!=null) $("#in-lat").value = state.lat;
  if(state.lon!=null) $("#in-lon").value = state.lon;
  $("#in-window").value = state.windowH;
}
$("#btn-gps").addEventListener('click', ()=>{
  if(!navigator.geolocation){ toast("GPS not available"); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    state.lat = Number(pos.coords.latitude.toFixed(5));
    state.lon = Number(pos.coords.longitude.toFixed(5));
    $("#in-lat").value = state.lat; $("#in-lon").value=state.lon;
    ls('lat',state.lat); ls('lon',state.lon);
    toast("GPS location set");
  }, ()=>toast("GPS failed"));
});
$("#btn-calc").addEventListener('click', async ()=>{
  state.lat = Number($("#in-lat").value||state.lat);
  state.lon = Number($("#in-lon").value||state.lon);
  state.windowH = Number($("#in-window").value||state.windowH);
  ls('lat',state.lat); ls('lon',state.lon); ls('windowH',state.windowH);
  toast("Calculating…");
  await fetchWeather();
  decideGoNoGo();
  renderTop5(computeTop5());
  toast("Updated");
});

/* ========== Boot ========== */
document.addEventListener('DOMContentLoaded', ()=>{
  // Open state per your spec
  setOpen('card-status', true);
  setOpen('card-conditions', true);
  setOpen('card-quicksetup', true);
  setOpen('card-rig', true);
  setOpen('card-top5', false);
  setOpen('card-catalog', false);
  setOpen('card-gng-settings', false);

  // thresholds
  $("#th-clouds").value = state.thresholds.clouds;
  $("#th-hum").value = state.thresholds.hum;
  $("#th-vis").value = state.thresholds.vis;

  // if user has a saved rig, load it; else start clean for onboarding
  if(!state.rig.initialized){
    // show placeholders; if you want default to prefill, uncomment next line:
    // state.rig = {...DEFAULT_RIG}; state.rig.initialized=true;
  }
  syncEditorFromRig();
  renderRigSummary();
  loadBasics();
  renderCatalog();
  decideGoNoGo();

  // if coords already saved, do a live fetch
  if(state.lat!=null && state.lon!=null){ (async()=>{ await fetchWeather(); decideGoNoGo(); })(); }
});
</script>
</body>
</html>
