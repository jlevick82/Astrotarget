<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Go/No-Go</title>
<style>
  :root{
    --bg:#0b1a22;--bg2:#0f2430;--card:#0e2a36;--ink:#e8f0f4;--muted:#a9c0cb;
    --ok:#10b981;--warn:#f59e0b;--bad:#ef4444;--chip:#123544;--chip2:#132e3a;
    --accent:#69a7ff;--ring:#2a5363;--shadow:rgba(0,0,0,.25);
  }
  .night:root{ /* softer contrast for night */
    --bg:#0a0b0d;--bg2:#0e0f11;--card:#121317;--ink:#ffd9df;--muted:#e3b7bf;
    --chip:#1b1c22;--chip2:#17181f;--ring:#2b2d35;--accent:#8bb4ff;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font:400 16px/1.4 system-ui,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  h1{font-size:44px;letter-spacing:.5px;margin:8px 0 10px}
  .version{opacity:.6;font-weight:700;margin-left:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{background:var(--chip);border:1px solid var(--ring);color:var(--ink);padding:10px 16px;border-radius:999px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:18px;padding:16px;box-shadow:0 6px 20px var(--shadow);margin:14px 0}
  .card.hdr{display:flex;align-items:center;justify-content:space-between}
  .title{font-weight:800;font-size:28px}
  .chev{width:42px;height:42px;border-radius:12px;background:var(--chip2);display:grid;place-items:center;border:1px solid var(--ring);cursor:pointer}
  .collapse{display:none}
  .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .chip{background:var(--chip);border:1px solid var(--ring);padding:10px 14px;border-radius:999px;white-space:nowrap}
  .chip.ok{background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.35);color:var(--ink)}
  .chip.bad{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.35)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:720px){.grid2{grid-template-columns:1fr}}
  .tile{background:var(--bg2);border-radius:16px;padding:16px;border:1px solid var(--ring)}
  .tile h4{margin:0 0 6px;font-weight:700;color:var(--muted)}
  .big{font-size:34px;font-weight:900}
  .table{width:100%;border-collapse:separate;border-spacing:0}
  .thead th{font-weight:700;color:var(--muted);text-align:left;padding:14px}
  .tbody td{padding:14px;border-top:1px solid var(--ring)}
  .thumb{width:72px;height:72px;border-radius:12px;background:var(--chip2);border:1px solid var(--ring);object-fit:cover}
  a{color:#9cc9ff}
  input[type="text"], input[type="number"]{width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--ring);background:var(--bg2);color:var(--ink)}
  .sl{accent-color:var(--accent);width:100%}
  .right{margin-left:auto}
  .muted{color:var(--muted)}
  /* toast */
  .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#0c0e12;color:#eaf2f7;border:1px solid #405264;padding:12px 16px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:.25s}
  .toast.show{opacity:1;pointer-events:auto}
  /* compact mode spacing */
  .compact .card{padding:12px;border-radius:14px}
  .compact .title{font-size:24px}
  .compact .chip{padding:8px 12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Go/No-Go <span class="version">v28.3</span></h1>
  <div class="row">
    <button id="compactBtn" class="btn">Compact Off</button>
    <button id="themeBtn" class="btn">Normal Mode</button>
  </div>

  <!-- Status -->
  <section class="card">
    <div class="card hdr">
      <div class="title">Status</div>
      <div class="chev" data-target="#statusBody">⌄</div>
    </div>
    <div id="statusBody">
      <div class="chips" id="statusChips">
        <!-- filled by JS -->
      </div>
    </div>
  </section>

  <!-- Go/No-Go Settings -->
  <section class="card">
    <div class="card hdr">
      <div class="title">Go/No-Go Settings</div>
      <div class="chev" data-target="#settingsBody">⌄</div>
    </div>
    <div id="settingsBody">
      <div class="grid2">
        <div class="tile">
          <h4>Cloud weight</h4>
          <input id="setCloudW" type="range" min="0" max="100" value="60" class="sl">
          <div class="muted">How strongly clouds affect the decision.</div>
        </div>
        <div class="tile">
          <h4>Min visibility (km)</h4>
          <input id="setVisMin" type="range" min="5" max="50" value="12" class="sl">
          <div class="muted">Below this → automatic NO-GO.</div>
        </div>
        <div class="tile">
          <h4>Moon tolerance (%)</h4>
          <input id="setMoonTol" type="range" min="0" max="100" value="35" class="sl">
          <div class="muted">Max moon illum allowed when the Moon is above horizon.</div>
        </div>
        <div class="tile">
          <h4>Refresh every (min)</h4>
          <input id="setRefresh" type="range" min="5" max="60" value="10" class="sl">
          <div class="muted">Auto update cadence.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Conditions -->
  <section class="card">
    <div class="card hdr">
      <div class="title">Conditions</div>
      <div class="chev" data-target="#condBody">⌄</div>
    </div>
    <div id="condBody">
      <div class="grid2">
        <div class="tile"><h4>Moon illum</h4><div class="big" id="moonPct">—</div><div class="muted" id="moonAlt">—</div></div>
        <div class="tile"><h4>Clouds (window max)</h4><div class="big" id="clouds">—</div><div class="muted">From Open-Meteo (window max)</div></div>
        <div class="tile"><h4>Humidity</h4><div class="big" id="rh">—</div></div>
        <div class="tile"><h4>Transparency</h4><div class="big" id="transp">—</div><div class="muted" id="transpInfo">—</div></div>
      </div>
      <div class="chips" style="margin-top:12px">
        <div class="chip" id="updated">Updated —</div>
        <div class="chip" id="sunAlt">Sun alt —</div>
        <div class="chip" id="astro">—</div>
      </div>
    </div>
  </section>

  <!-- Quick setup -->
  <section class="card">
    <div class="card hdr">
      <div class="title">Quick setup</div>
      <div class="chev" data-target="#qsBody">⌄</div>
    </div>
    <div id="qsBody">
      <div class="grid2">
        <div class="tile"><h4>Latitude (°)</h4><input id="lat" type="number" step="0.00001"></div>
        <div class="tile"><h4>Longitude (°)</h4><input id="lon" type="number" step="0.00001"></div>
      </div>
      <div class="chips" style="margin-top:12px">
        <button id="gpsBtn" class="btn">Use GPS</button>
        <button id="calcBtn" class="btn">Calculate Now</button>
      </div>
    </div>
  </section>

  <!-- Top 5 (example static for now, sorted later by rules) -->
  <section class="card">
    <div class="card hdr">
      <div class="title">Top 5 Recommendations</div>
      <div class="chev" data-target="#topBody">⌄</div>
    </div>
    <div id="topBody">
      <ol id="topList" style="padding-left:22px;margin:10px 0 0"></ol>
    </div>
  </section>

  <!-- Catalog (with built-in search) -->
  <section class="card">
    <div class="card hdr">
      <div class="title">Catalog</div>
      <div class="chev" data-target="#catBody">⌄</div>
    </div>
    <div id="catBody">
      <div class="row" style="margin:6px 0 10px">
        <input id="search" type="text" placeholder="Search catalog (name/type)" />
        <button id="clearSearch" class="btn">Clear</button>
      </div>
      <div class="tile">
        <table class="table">
          <thead class="thead">
            <tr><th>Name</th><th>Type</th><th>RA</th><th>Dec</th><th>Image</th></tr>
          </thead>
          <tbody id="catRows" class="tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Rig -->
  <section class="card">
    <div class="card hdr">
      <div class="title">Rig (Scope + Camera)</div>
      <div class="chev" data-target="#rigBody">⌄</div>
    </div>
    <div id="rigBody">
      <div class="chips" id="rigSummary"></div>
      <div class="chips" style="margin-top:10px">
        <button id="editRigBtn" class="btn">Edit rig</button>
      </div>
      <div id="rigEditor" class="collapse" style="margin-top:10px">
        <div class="grid2">
          <div class="tile">
            <h4>Scope (FL × Dia)</h4>
            <div class="row">
              <input id="scopeFL" type="number" placeholder="Focal length (mm)" />
              <input id="scopeDia" type="number" placeholder="Diameter (mm)" />
            </div>
          </div>
          <div class="tile">
            <h4>Reducer / Barlow</h4>
            <div class="row">
              <button class="btn redBtn" data-red="0.63">0.63×</button>
              <button class="btn redBtn" data-red="0.7">0.7×</button>
              <button class="btn redBtn" data-red="0.8">0.8×</button>
              <button class="btn redBtn" data-red="1">1×</button>
              <button class="btn redBtn" data-red="2">2×</button>
            </div>
          </div>
          <div class="tile">
            <h4>Camera sensor (mm)</h4>
            <div class="row">
              <input id="camW" type="number" step="0.01" placeholder="Width" />
              <input id="camH" type="number" step="0.01" placeholder="Height" />
              <input id="pix" type="number" step="0.01" placeholder="Pixel size (µm)" />
            </div>
          </div>
          <div class="tile">
            <h4>Preset</h4>
            <input id="presetName" type="text" placeholder="SV503_533_0.8x" />
            <div class="chips" style="margin-top:10px">
              <button id="savePreset" class="btn">Save</button>
              <button id="delPreset" class="btn">Delete</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

</div>

<div id="toast" class="toast">—</div>

<script>
/* ---------- helpers ---------- */
const $=q=>document.querySelector(q);
const $$=q=>[...document.querySelectorAll(q)];
const toast=(msg)=>{const t=$("#toast");t.textContent=msg;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2200);}
const fmtPct=x=> (x==null?"—":Math.round(x)+"%");
const nowStr=()=> new Date().toLocaleTimeString();
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

/* ---------- theme + compact ---------- */
const applyTheme=()=>{
  const night=localStorage.getItem("night")==="1";
  document.documentElement.classList.toggle("night",night);
  $("#themeBtn").textContent = night ? "Night Mode" : "Normal Mode";
};
$("#themeBtn").onclick=()=>{localStorage.setItem("night", localStorage.getItem("night")==="1"?"0":"1");applyTheme();toast("Theme updated");};
const applyCompact=()=>{
  const c=localStorage.getItem("compact")==="1";
  document.body.classList.toggle("compact",c);
  $("#compactBtn").textContent=c?"Compact On":"Compact Off";
};
$("#compactBtn").onclick=()=>{localStorage.setItem("compact", localStorage.getItem("compact")==="1"?"0":"1");applyCompact();};

applyTheme();applyCompact();

/* ---------- collapsibles ---------- */
$$(".chev").forEach(ch=>{
  ch.addEventListener("click",()=> {
    const tgt=ch.getAttribute("data-target");
    const el=document.querySelector(tgt);
    el.classList.toggle("collapse");
    ch.textContent = el.classList.contains("collapse") ? "˄" : "⌄";
  });
});

/* ---------- settings (persist) ---------- */
const settingsKeys=["setCloudW","setVisMin","setMoonTol","setRefresh"];
settingsKeys.forEach(id=>{
  const el=$("#"+id);
  const s=localStorage.getItem(id);
  if(s!=null) el.value=s;
  el.addEventListener("input",()=>{localStorage.setItem(id, el.value); liveDecide();});
});

/* ---------- location ---------- */
const getLatLon=()=>{
  const lat=parseFloat($("#lat").value), lon=parseFloat($("#lon").value);
  if(Number.isFinite(lat)&&Number.isFinite(lon)) return {lat,lon};
  const ls=localStorage.getItem("latlon");
  return ls?JSON.parse(ls):null;
};
const setLatLon=(lat,lon)=>{ $("#lat").value=lat.toFixed(5); $("#lon").value=lon.toFixed(5); localStorage.setItem("latlon", JSON.stringify({lat,lon}));};
$("#gpsBtn").onclick=()=>{
  if(!navigator.geolocation){toast("Geolocation not available");return;}
  navigator.geolocation.getCurrentPosition(p=>{
    const {latitude:lat,longitude:lon}=p.coords;
    setLatLon(lat,lon); toast("GPS location set");
  }, _=> toast("GPS denied or failed"));
};
$("#calcBtn").onclick=()=>{fetchLive();};

/* ---------- astronomy (Sun/Moon) – SunCalc mini ---------- */
/* Minimal functions adapted from SunCalc principles */
function toRad(d){return d*Math.PI/180;}
function toDeg(r){return r*180/Math.PI;}
function julian(date){return date/86400000-0.5+2440588;}
function eclipticObliquity(){return toRad(23.4397);}
function solarMeanAnomaly(d){return toRad(357.5291 + 0.98560028*d);}
function eclipticLongitude(M){return toRad(280.1470 + 360.9856235*M/ (2*Math.PI))} // simple
function sunDeclination(d){ // rough
  const n=julian(d)-2451545;
  const L = toRad((280.46 + 0.9856474*n)%360);
  const g = toRad((357.528 + 0.9856003*n)%360);
  const lam = L + toRad(1.915)*Math.sin(g) + toRad(0.02)*Math.sin(2*g);
  return Math.asin(Math.sin(lam)*Math.sin(eclipticObliquity()));
}
function sunAltitude(date,lat,lon){
  const d = date.getTime();
  const dec = sunDeclination(d);
  const lst = ((date.getUTCHours()+date.getUTCMinutes()/60 + lon/15)+24)%24;
  const ha = toRad((lst*15) - 0); // crude hour angle
  const alt = Math.asin(Math.sin(toRad(lat))*Math.sin(dec)+Math.cos(toRad(lat))*Math.cos(dec)*Math.cos(ha));
  return toDeg(alt);
}
// Simple moon illumination & altitude via SunCalc-like approximations:
function moonIllumPct(date){ // 0..100
  const d=(date - new Date("2001-01-01"))/86400000;
  const syn=29.53058867;
  const phase=((d % syn)+syn)%syn;
  return Math.round((1 - Math.cos(2*Math.PI*phase/syn))*50);
}
function moonAltRough(date,lat,lon){
  // crude: shift sun hour angle by ~12h (opposition)
  const alt = sunAltitude(new Date(date.getTime()+12*3600*1000), lat, lon);
  return alt;
}

/* ---------- weather via Open-Meteo ---------- */
async function getOpenMeteo(lat,lon){
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=cloudcover,visibility,relativehumidity_2m,temperature_2m,dewpoint_2m&forecast_days=1`;
  const aq = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5,aerosol_optical_depth&forecast_days=1`;
  const [wRes, aRes] = await Promise.all([fetch(url), fetch(aq)]);
  if(!wRes.ok||!aRes.ok) throw new Error("Open-Meteo error");
  const w=await wRes.json(), a=await aRes.json();
  const idx=new Date().getHours(); // window start hour; we also peek 3h window
  const hours=[idx, idx+1, idx+2].map(i=>Math.min(i, w.hourly.cloudcover.length-1));
  const clouds = Math.max(...hours.map(i=>w.hourly.cloudcover[i])); // window max
  const vis = Math.min(...hours.map(i=> (w.hourly.visibility[i]||20000)/1000 )); // km (min in window)
  const rh = Math.max(...hours.map(i=> w.hourly.relativehumidity_2m[i]));
  const t = w.hourly.temperature_2m[idx], td = w.hourly.dewpoint_2m[idx];
  const dT = +(t-td).toFixed(1);
  const pm = a.hourly.pm2_5[idx] ?? 0;
  const aod = a.hourly.aerosol_optical_depth[idx] ?? 0;
  return {clouds, vis, rh, dT, pm, aod};
}

/* ---------- decision engine ---------- */
function transparencyRating({aod, pm, rh, dT}){
  // quick heuristic score 0..100
  let score = 100;
  score -= clamp(aod*200,0,35); // higher AOD worse
  score -= clamp(pm*1.2,0,35);
  score -= clamp((rh-50)*0.6,0,15);
  score -= clamp((1.5-dT)*18,0,15); // if dewpoint close to temp
  const text = score>75?"Great": score>55?"Good": score>35?"Fair": score>20?"Poor":"Bad";
  return {score, text};
}

function decide(status){
  const set = {
    cloudW: +$("#setCloudW").value, visMin:+$("#setVisMin").value,
    moonTol:+$("#setMoonTol").value
  };
  // hard blocks
  if(status.vis < set.visMin) return "NO-GO";
  if(status.moonPct > set.moonTol && status.moonAlt > -5) return "NO-GO";
  // weighted risk
  const cloudPenalty = status.clouds * (set.cloudW/100);
  const transPenalty = (100-status.transpScore) * (1 - set.cloudW/100);
  const risk = cloudPenalty*0.7 + transPenalty*0.3 + (status.rh>90?5:0);
  return risk<45 ? "GO" : (risk<65? "MAYBE" : "NO-GO");
}

/* ---------- catalog + images ---------- */
const CATALOG = [
  {id:"M31", type:"GX", ra:"0.71h", dec:"41.3°", wiki:"https://en.wikipedia.org/wiki/Andromeda_Galaxy",
   img:"https://upload.wikimedia.org/wikipedia/commons/thumb/9/98/Andromeda_Galaxy_%28with_h-alpha%29.jpg/320px-Andromeda_Galaxy_%28with_h-alpha%29.jpg"},
  {id:"M33", type:"GX", ra:"1.55h", dec:"30.7°", wiki:"https://en.wikipedia.org/wiki/Triangulum_Galaxy",
   img:"https://upload.wikimedia.org/wikipedia/commons/thumb/9/9b/M33_-_Triangulum_Galaxy.jpg/320px-M33_-_Triangulum_Galaxy.jpg"},
  {id:"M27", type:"PN", ra:"19.89h", dec:"22.7°", wiki:"https://en.wikipedia.org/wiki/Dumbbell_Nebula",
   img:"https://upload.wikimedia.org/wikipedia/commons/thumb/f/fb/M27_Dumbbell_Nebula.jpg/320px-M27_Dumbbell_Nebula.jpg"},
  {id:"M57", type:"PN", ra:"18.89h", dec:"33.0°", wiki:"https://en.wikipedia.org/wiki/Ring_Nebula",
   img:"https://upload.wikimedia.org/wikipedia/commons/thumb/4/49/M57_The_Ring_Nebula.JPG/320px-M57_The_Ring_Nebula.JPG"},
  {id:"M13", type:"GC", ra:"16.70h", dec:"36.5°", wiki:"https://en.wikipedia.org/wiki/Great_Hercules_Cluster",
   img:"https://upload.wikimedia.org/wikipedia/commons/thumb/4/4d/M13_-_Great_Hercules_Cluster.jpg/320px-M13_-_Great_Hercules_Cluster.jpg"}
];

function renderTop5(list){
  const ol=$("#topList"); ol.innerHTML="";
  list.forEach((o,i)=>{
    const li=document.createElement("li");
    li.style.margin="6px 0";
    li.innerHTML = `<a href="${o.wiki}" target="_blank" rel="noopener">${o.id}</a> — `+
      `${o.name??o.title??o.id} — alt ${o.alt??'—'} — ${o.sep??''}`;
    ol.appendChild(li);
  });
}

function renderCatalog(filter=""){
  const tbody=$("#catRows"); tbody.innerHTML="";
  const q=filter.trim().toLowerCase();
  CATALOG.filter(o=>!q || o.id.toLowerCase().includes(q) || o.type.toLowerCase().includes(q))
    .forEach(o=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td><a href="${o.wiki}" target="_blank" rel="noopener">${o.id}</a></td>
        <td>${o.type}</td>
        <td>${o.ra}</td>
        <td>${o.dec}</td>
        <td><a href="${o.wiki}" target="_blank" rel="noopener"><img class="thumb" loading="lazy" src="${o.img}" onerror="this.style.opacity=.25"></a></td>`;
      tbody.appendChild(tr);
    });
}
$("#search").addEventListener("input", e=> renderCatalog(e.target.value));
$("#clearSearch").onclick=()=>{$("#search").value="";renderCatalog("");};

/* ---------- rig ---------- */
function rigLoad(){
  const d=JSON.parse(localStorage.getItem("rig")||"{}");
  const rig = {
    fl: d.fl ?? 560, dia: d.dia ?? 80, red: d.red ?? 0.8,
    camW:d.camW ?? 11.31, camH:d.camH ?? 11.31, pix:d.pix ?? 3.76,
    name: d.name ?? "SV503_533_0.8x"
  };
  $("#scopeFL").value=rig.fl; $("#scopeDia").value=rig.dia;
  $("#camW").value=rig.camW; $("#camH").value=rig.camH; $("#pix").value=rig.pix;
  $("#presetName").value=rig.name;
  updateRigSummary(rig);
  return rig;
}
function updateRigSummary(r){
  const eff = Math.round(r.fl * r.red);
  const scale = (206.265 * r.pix / eff).toFixed(2);
  // FOV (degrees) ~ 57.3 * sensor(mm) / eff(mm)
  const fovX = (57.2958 * r.camW / eff).toFixed(2);
  const fovY = (57.2958 * r.camH / eff).toFixed(2);
  $("#rigSummary").innerHTML =
    `<div class="chip">Eff. FL ${eff} mm (${r.red}×)</div>
     <div class="chip">FOV ${fovX} × ${fovY}</div>
     <div class="chip">Scale ${scale} "/px</div>
     <div class="chip">${r.fl} × ${r.dia} mm (f/${(r.fl/r.dia).toFixed(1)})</div>
     <div class="chip">Reducer ${r.red}×</div>`;
  localStorage.setItem("rig", JSON.stringify(r));
}
let RIG = rigLoad();
$("#editRigBtn").onclick=()=>{
  const ed=$("#rigEditor"); ed.classList.toggle("collapse");
  $("#editRigBtn").textContent = ed.classList.contains("collapse") ? "Edit rig" : "Close editor";
};
$$(".redBtn").forEach(b=>{
  b.addEventListener("click",()=>{
    RIG.red = parseFloat(b.dataset.red);
    updateRigSummary(RIG);
    toast(`Reducer set to ${RIG.red}×`);
  });
});
["scopeFL","scopeDia","camW","camH","pix","presetName"].forEach(id=>{
  $("#"+id).addEventListener("change",()=>{
    RIG.fl=+$("#scopeFL").value; RIG.dia=+$("#scopeDia").value;
    RIG.camW=+$("#camW").value; RIG.camH=+$("#camH").value; RIG.pix=+$("#pix").value;
    RIG.name=$("#presetName").value || "SV503_533_0.8x";
    updateRigSummary(RIG);
  });
});
$("#savePreset").onclick=()=>{localStorage.setItem("rigPreset_"+(RIG.name||"SV503_533_0.8x"), JSON.stringify(RIG)); toast("Preset saved");}
$("#delPreset").onclick=()=>{localStorage.removeItem("rigPreset_"+(RIG.name||"SV503_533_0.8x")); toast("Preset deleted");}

/* ---------- live fetch + render ---------- */
async function fetchLive(){
  const ll=getLatLon();
  if(!ll){toast("Set location (GPS or manual) first");return;}
  const {lat,lon}=ll;

  // astronomy
  const now=new Date();
  const sunA= sunAltitude(now,lat,lon);
  const astro = sunA<-18 ? "Astro dark" : (sunA<-12?"Nautical":"—");
  const moonPct= moonIllumPct(now);
  const moonA = moonAltRough(now,lat,lon);

  // weather
  let wx;
  try{
    wx = await getOpenMeteo(lat,lon);
  }catch(e){ toast("Weather fetch failed"); return; }

  // transparency
  const tr = transparencyRating(wx);

  // update Conditions
  $("#moonPct").textContent = fmtPct(moonPct);
  $("#moonAlt").textContent = `Alt ${Math.round(moonA)}°`;
  $("#clouds").textContent = fmtPct(wx.clouds);
  $("#rh").textContent = fmtPct(wx.rh);
  $("#transp").textContent = tr.text;
  $("#transpInfo").textContent = `AOD ${wx.aod.toFixed(2)} · PM2.5 ${wx.pm?.toFixed?.(1)??wx.pm} · RH ${wx.rh}% · Vis ${wx.vis.toFixed(0)}km · ΔT ${wx.dT}°C`;
  $("#updated").textContent = `Updated ${nowStr()}`;
  $("#sunAlt").textContent = `Sun alt ${Math.round(sunA)}°`;
  $("#astro").textContent = astro;

  // decision
  const status = {
    clouds: wx.clouds, vis: wx.vis, rh: wx.rh, transpScore: tr.score,
    moonPct, moonAlt: moonA
  };
  const decision = decide(status);
  renderStatus(decision, wx, astro, moonPct, sunA);

  // top 5 (placeholder order; can bias by FOV later)
  renderTop5(CATALOG);
  toast("Live data updated");
}
function renderStatus(decision, wx, astro, moonPct, sunAlt){
  const chips=$("#statusChips"); chips.innerHTML="";
  const tag=document.createElement("div");
  tag.className="chip "+(decision==="GO"?"ok": decision==="NO-GO"?"bad":"");
  tag.textContent=decision; chips.appendChild(tag);
  [
    `Clouds ~${Math.round(wx.clouds)}%`,
    `Vis ${wx.vis.toFixed(0)} km`,
    astro,
    `Updated ${nowStr()}`,
    `Sun alt ${Math.round(sunAlt)}°`,
    `Moon ${moonPct}%`,
    `Transparency ${transparencyRating(wx).text}`
  ].forEach(t=>{const c=document.createElement("div");c.className="chip";c.textContent=t;chips.appendChild(c);});
}

/* ---------- boot ---------- */
(function boot(){
  // initial lat/lon from LS or ask
  const ll = getLatLon();
  if(ll){ setLatLon(ll.lat,ll.lon); }
  renderCatalog("");
  renderTop5(CATALOG);
  fetchLive();
  // auto refresh
  setInterval(()=>fetchLive(), (+$("#setRefresh").value||10)*60000);
})();
</script>
</body>
</html>
