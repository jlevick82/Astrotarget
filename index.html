<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nightly Go/No-Go</title>
<link rel="icon" href="favicon.ico" />
<style>
  :root{
    --bg: #0f2230;
    --bg-elev: #132a3a;
    --bg-elev-2: #163243;
    --text: #e7f0fb;
    --muted: #a9bfd4;
    --chip: #0d2130;
    --chip-bd: #24465f;
    --ok: #36d27d;
    --bad: #ffb84d;
    --danger: #ff6868;
    --accent: #2f7de0;
    --ring: rgba(255,255,255,.10);
    --bd: rgba(255,255,255,.08);
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius-xl: 22px; --radius-lg: 18px; --radius: 14px; --radius-sm: 12px;
    --pad: 16px; --gap: 14px;
    --fs-xxl: clamp(26px,4.8vw,44px);
    --fs-xl: 26px; --fs-lg: 20px; --fs: 16px; --fs-sm: 14px; --fs-xs: 12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font: 400 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    color:var(--text); background:
      radial-gradient(1200px 600px at 20% -10%, rgba(55,93,133,.30), transparent 60%),
      radial-gradient(1000px 500px at 110% -10%, rgba(35,72,110,.35), transparent 55%),
      var(--bg);
  }
  .wrap{max-width:920px; margin:0 auto; padding:28px 18px 120px}
  header h1{margin:0 0 6px; font-size:var(--fs-xxl); letter-spacing:.3px}
  .toolbar{display:flex; gap:10px; flex-wrap:wrap}
  .btn{
    display:inline-flex; align-items:center; justify-content:center;
    padding:10px 16px; border-radius:999px; border:1px solid var(--bd);
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    color:var(--text); box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
  }
  .btn:active{transform:translateY(1px)}
  .chip{padding:8px 14px; border-radius:999px; background:var(--chip); border:1px solid var(--chip-bd); color:var(--muted)}
  .section{margin-top:18px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02)) , var(--bg-elev);
    border:1px solid var(--bd); border-radius:var(--radius-xl); box-shadow:var(--shadow);
    overflow:hidden;
  }
  .card .hdr{
    display:flex; align-items:center; gap:12px; padding:16px 16px 10px 16px;
  }
  .card .title{font-weight:700; font-size:var(--fs-lg)}
  .card .sub{color:var(--muted)}
  .card .card-body{padding: 10px 16px 16px}
  .go-badge{
    width:56px; height:56px; border-radius:18px; border:2px solid #2b6f41;
    background:#0f2a1b; display:flex; align-items:center; justify-content:center; color:#a7f5c9; font-weight:800;
    box-shadow:inset 0 0 0 2px rgba(54,210,125,.15);
  }
  .chevron{
    margin-left:auto; width:38px; height:38px; border-radius:12px; border:1px solid var(--bd);
    background:rgba(255,255,255,.04); display:inline-flex; align-items:center; justify-content:center; color:var(--muted); font-size:18px;
  }
  /* Sky grid */
  .grid{display:grid; gap:14px}
  .grid-2{grid-template-columns:1fr 1fr}
  @media (max-width:560px){ .grid-2{grid-template-columns:1fr} }
  .info{
    background:var(--bg-elev-2); border:1px solid var(--bd); border-radius:var(--radius-lg);
    padding:14px 16px;
  }
  .info .label{color:var(--muted); font-size:var(--fs-sm)}
  .info .value{font-size:clamp(20px,6vw,34px); font-weight:800; letter-spacing:.2px}
  .value.bad{color:var(--bad)} .value.ok{color:var(--ok)} .value.danger{color:var(--danger)}
  /* Slider & controls */
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .row.spread{justify-content:space-between}
  input[type=range]{width:100%}
  .pill{border-radius:999px; padding:10px 14px; border:1px solid var(--bd); background:var(--bg-elev-2); color:var(--muted)}
  .chips{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
  /* Table */
  table{width:100%; border-collapse:separate; border-spacing:0 10px}
  th,td{padding:12px 14px; text-align:left}
  th{color:var(--muted); font-weight:600}
  tbody tr{background:var(--bg-elev-2); border:1px solid var(--bd)}
  tbody td:first-child{border-top-left-radius:14px; border-bottom-left-radius:14px}
  tbody td:last-child{border-top-right-radius:14px; border-bottom-right-radius:14px}
  .thumb{width:68px; height:68px; border-radius:12px; object-fit:cover; border:1px solid var(--bd); cursor:pointer}
  /* Modal image */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:60}
  .modal.open{display:flex}
  .modal img{max-width:92vw; max-height:86vh; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.5)}
  /* Toasts */
  .toast-wrap{position:fixed; left:50%; bottom:18px; transform:translateX(-50%); display:flex; flex-direction:column; gap:10px; z-index:80; width:min(92vw,580px)}
  .toast{background:var(--bg-elev-2); border:1px solid var(--bd); color:var(--text); padding:12px 14px; border-radius:16px; box-shadow:var(--shadow)}
  /* Compact toggle */
  .compact .card .hdr{padding:12px 14px 8px}
  .compact .card .card-body{padding:8px 14px 14px}
  .compact .info{padding:12px 14px}
</style>
</head>
<body>
<div class="wrap">

  <header class="section">
    <h1>Nightly<br/>Go/No-Go <span style="font-size:14px; color:var(--muted)">v26.6</span></h1>
    <div class="toolbar">
      <button id="compactBtn" class="btn">Compact <span id="compactState">off</span></button>
      <button id="themeBtn" class="btn">Blue</button>
    </div>
  </header>

  <!-- ===== Status / GO card ===== -->
  <section id="statusCard" class="section card">
    <div class="hdr">
      <div class="go-badge" id="goBadge">GO</div>
      <div>
        <div class="title" id="goLine">GO · Clouds ~— · Vis — km · Astro —</div>
        <div class="sub" id="goSub">Observing recommendation</div>
      </div>
      <button class="chevron" data-toggle="statusCard" aria-expanded="true">▾</button>
    </div>
    <div class="card-body">
      <div class="chips">
        <span class="chip" id="chipUpdated">Updated —:—</span>
        <span class="chip" id="chipSun" data-chip-sun>Sun alt —°</span>
        <span class="chip" id="chipMoon" data-chip-moon>Moon —%</span>
        <span class="chip" id="chipAlt" data-chip-alt>Alt —°</span>
      </div>
    </div>
  </section>

  <!-- ===== Sky ===== -->
  <section id="skyCard" class="section card">
    <div class="hdr">
      <div class="title">Sky</div>
      <button class="chevron" data-toggle="skyCard" aria-expanded="true">▾</button>
    </div>
    <div class="card-body">
      <div class="grid grid-2">
        <div class="info">
          <div class="label">Astronomical dark</div>
          <div class="value ok" id="astroNow" data-sky-astro>—</div>
          <div class="sub" id="sunAltNow" data-sky-sunalt>Sun alt —°</div>
        </div>
        <div class="info">
          <div class="label">Moon illum</div>
          <div class="value" id="moonIllum">—%</div>
          <div class="sub" id="moonAlt">Alt —°</div>
        </div>
        <div class="info">
          <div class="label">Humidity</div>
          <div class="value" id="humidityVal">—%</div>
        </div>
        <div class="info">
          <div class="label">Transparency</div>
          <div class="value" id="transparencyVal">—</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Clouds ===== -->
  <section id="cloudsCard" class="section card">
    <div class="hdr">
      <div class="title">Clouds (avg)</div>
      <button class="chevron" data-toggle="cloudsCard" aria-expanded="true">▾</button>
    </div>
    <div class="card-body">
      <div class="row">
        <input id="cloudsRange" type="range" min="0" max="100" value="8" />
      </div>
      <div class="row">
        <button class="btn" id="useClouds">Use</button>
        <button class="btn" id="calcClouds">Calculate</button>
        <span class="pill" id="cloudsSource">From Open-Meteo (hourly) · slider overrides</span>
        <span class="chip" id="cloudsPct">8%</span>
      </div>
    </div>
  </section>

  <!-- ===== Quick setup ===== -->
  <section id="quickSetupCard" class="section card">
    <div class="hdr">
      <div class="title">Quick setup</div>
      <button class="chevron" data-toggle="quickSetupCard" aria-expanded="true">▾</button>
    </div>
    <div class="card-body">
      <div class="grid grid-2">
        <div class="info">
          <div class="label">Latitude (°)</div>
          <input id="lat" name="lat" class="pill" inputmode="decimal" />
        </div>
        <div class="info">
          <div class="label">Longitude (°)</div>
          <input id="lon" name="lon" class="pill" inputmode="decimal" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="useGPS">Use GPS</button>
        <button class="btn" id="recalc">Calculate Now</button>
      </div>
    </div>
  </section>

  <!-- ===== Top 5 ===== -->
  <section id="top5Card" class="section card">
    <div class="hdr">
      <div class="title">Top 5 Recommendations</div>
      <button class="chevron" data-toggle="top5Card" aria-expanded="true">▾</button>
    </div>
    <div class="card-body">
      <ol id="top5List" style="margin:0 0 0 18px; padding:0; display:grid; gap:10px">
        <!-- filled in JS -->
      </ol>
    </div>
  </section>

  <!-- ===== Catalog ===== -->
  <section id="catalogCard" class="section card">
    <div class="hdr">
      <div class="title">Catalog (subset)</div>
      <button class="chevron" data-toggle="catalogCard" aria-expanded="true">▾</button>
    </div>
    <div class="card-body">
      <table aria-label="Catalog">
        <thead>
          <tr><th>Name</th><th>Type</th><th>RA</th><th>Dec</th><th>Image</th></tr>
        </thead>
        <tbody id="catalogBody"></tbody>
      </table>
    </div>
  </section>

</div>

<!-- Toasts -->
<div class="toast-wrap" id="toasts"></div>

<!-- Image modal -->
<div class="modal" id="imgModal" role="dialog" aria-modal="true" aria-label="Image preview">
  <img id="modalImg" alt="">
</div>

<!-- SunCalc for solar/lunar positions -->
<script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.js"></script>

<script>
/* ========= Small util ========= */
const $ = (sel, ctx=document)=>ctx.querySelector(sel);
const $$ = (sel, ctx=document)=>Array.from(ctx.querySelectorAll(sel));
const toasts = $('#toasts');
function toast(msg, ms=2200){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; toasts.appendChild(t); setTimeout(()=>t.remove(), ms); }

/* ========= Collapsible cards ========= */
(function(){
  const LS_KEY='astro_collapsed';
  const state = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
  function set(card, collapsed){
    const body = card.querySelector('.card-body');
    const btn = card.querySelector('.chevron');
    if (!body||!btn) return;
    btn.setAttribute('aria-expanded', String(!collapsed));
    btn.textContent = collapsed ? '▸' : '▾';
    body.style.overflow='hidden';
    body.style.transition='max-height .25s ease, opacity .25s ease';
    if (collapsed){ body.style.maxHeight='0px'; body.style.opacity='0'; }
    else { body.style.maxHeight=body.scrollHeight+'px'; body.style.opacity='1'; setTimeout(()=>{ body.style.maxHeight='none'; }, 250); }
  }
  $$('.card').forEach(card=>{
    const id = card.id || Math.random().toString(36).slice(2);
    card.id = id;
    const collapsed = !!state[id];
    set(card, collapsed);
    const btn = card.querySelector('.chevron');
    const hdr = card.querySelector('.hdr');
    function toggle(){ const next = btn.getAttribute('aria-expanded')==='true'; state[id]=next; localStorage.setItem(LS_KEY, JSON.stringify(state)); set(card, next); }
    btn?.addEventListener('click', (e)=>{ e.stopPropagation(); toggle(); });
    hdr?.addEventListener('click', (e)=>{ if (e.target.closest('.chevron')) return; toggle(); });
  });
})();

/* ========= Theme + compact ========= */
(function(){
  const compactBtn = $('#compactBtn'), compactState = $('#compactState');
  function sync(){ const on = document.body.classList.toggle('compact', JSON.parse(localStorage.getItem('compact')||'false')); compactState.textContent = on ? 'on' : 'off'; }
  compactBtn.addEventListener('click', ()=>{ const next = !(JSON.parse(localStorage.getItem('compact')||'false')); localStorage.setItem('compact', JSON.stringify(next)); sync(); });
  sync();

  const themeBtn=$('#themeBtn');
  themeBtn.addEventListener('click', ()=>{
    const t = localStorage.getItem('theme') || 'blue';
    const next = t==='blue'?'red':'blue';
    localStorage.setItem('theme', next);
    themeBtn.textContent = next==='blue'?'Blue':'Red';
    // simple accent flip
    document.documentElement.style.setProperty('--accent', next==='blue' ? '#2f7de0' : '#e04848');
  });
})();

/* ========= App state ========= */
const app = {
  lat: 37.1656,
  lon: -76.5684,
  clouds: 8, // %
  visibilityKm: 18,
  humidity: 91,
  transparency: 'Bad',
  moonIllum: 7,
  moonAlt: -29,
};

/* ========= DOM refs ========= */
const goBadge = $('#goBadge'), goLine=$('#goLine'), goSub=$('#goSub');
const chipUpdated=$('#chipUpdated'), chipSun=$('#chipSun'), chipMoon=$('#chipMoon'), chipAlt=$('#chipAlt');
const astroNow=$('#astroNow'), sunAltNow=$('#sunAltNow'), moonIllum=$('#moonIllum'), moonAlt=$('#moonAlt');
const humidityVal=$('#humidityVal'), transparencyVal=$('#transparencyVal');
const latIn=$('#lat'), lonIn=$('#lon'), recalcBtn=$('#recalc'), gpsBtn=$('#useGPS');
const cloudsRange=$('#cloudsRange'), cloudsPct=$('#cloudsPct'), cloudsSource=$('#cloudsSource');
const top5List=$('#top5List'), catalogBody=$('#catalogBody');

/* ========= Helpers ========= */
function fmt(num, digits=0){ return Number(num).toFixed(digits); }
function signDeg(v){ return (v>0?'+':'') + fmt(v); }
function nowStr(){
  const d=new Date(); return d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit', second:'2-digit'});
}

/* ========= Sky & status compute ========= */
function computeSky(){
  const now=new Date();
  const sun=SunCalc.getPosition(now, app.lat, app.lon);
  const sunAltDeg = sun.altitude*180/Math.PI;
  const astro = sunAltDeg < -18;
  const moon = SunCalc.getMoonIllumination(now); // fraction 0..1
  const moonPos= SunCalc.getMoonPosition(now, app.lat, app.lon);
  const moonAltDeg = moonPos.altitude*180/Math.PI;

  app.moonIllum = Math.round(moon.fraction*100);
  app.moonAlt = Math.round(moonAltDeg);

  // Update UI
  astroNow.textContent = astro ? 'Yes' : 'No';
  astroNow.classList.toggle('ok', astro);
  astroNow.classList.toggle('danger', !astro);
  sunAltNow.textContent = `Sun alt ${Math.round(sunAltDeg)}°`;

  moonIllum.textContent = `${app.moonIllum}%`;
  moonAlt.textContent = `Alt ${signDeg(app.moonAlt)}°`;

  humidityVal.textContent = `${app.humidity}%`;
  transparencyVal.textContent = app.transparency;

  chipSun.textContent = `Sun alt ${Math.round(sunAltDeg)}°`;
  chipMoon.textContent = `Moon ${app.moonIllum}%`;
  chipAlt.textContent  = `Alt ${signDeg(app.moonAlt)}°`;

  // GO/No-Go quick line
  const cloudsStr = `Clouds ~${app.clouds}%`;
  const visStr = `Vis ${app.visibilityKm} km`;
  const astroStr = astro ? 'Astro dark' : 'Not astro dark';
  goLine.textContent = `GO · ${cloudsStr} · ${visStr} · ${astroStr}`;
  goBadge.textContent = (app.clouds>=60 || !astro) ? 'NO' : 'GO';
  goBadge.style.borderColor = (app.clouds>=60 || !astro) ? '#6f2b2b' : '#2b6f41';
  goBadge.style.background = (app.clouds>=60 || !astro) ? '#2a0f0f' : '#0f2a1b';

  chipUpdated.textContent = `Updated ${nowStr()}`;
}

/* ========= Clouds control ========= */
function syncCloudsUI(){
  cloudsRange.value = String(app.clouds);
  cloudsPct.textContent = `${app.clouds}%`;
}
cloudsRange.addEventListener('input', ()=>{
  app.clouds = parseInt(cloudsRange.value,10);
  syncCloudsUI();
  computeSky();
});
$('#useClouds').addEventListener('click', ()=>{
  toast(`Targets updated · clouds ${app.clouds}%`);
  computeSky();
});
$('#calcClouds').addEventListener('click', ()=>{
  // Placeholder: pretend we fetched Open-Meteo and got 35%
  const fetched = 35;
  app.clouds = fetched;
  syncCloudsUI();
  cloudsSource.textContent = 'From Open-Meteo (hourly) · slider overrides';
  toast(`Clouds ${fetched}% (Open-Meteo)`);
  computeSky();
});

/* ========= Location controls ========= */
function syncLatLonUI(){ latIn.value = app.lat.toFixed(5); lonIn.value = app.lon.toFixed(5); }
recalcBtn.addEventListener('click', ()=>{ 
  app.lat=parseFloat(latIn.value); app.lon=parseFloat(lonIn.value);
  toast('Targets updated');
  computeSky();
});
gpsBtn.addEventListener('click', ()=>{
  if (!navigator.geolocation){ toast('GPS not available'); return; }
  navigator.geolocation.getCurrentPosition(
    (pos)=>{ app.lat=pos.coords.latitude; app.lon=pos.coords.longitude; syncLatLonUI(); computeSky(); toast('Location set from GPS'); },
    ()=>toast('Could not get GPS')
  );
});

/* ========= Top 5 (demo list kept) ========= */
function renderTop5(){
  const items = [
    {id:'M27', name:'Dumbbell Nebula', note:'alt 82° — 142° from Moon — 196%'},
    {id:'M31', name:'Andromeda Galaxy', note:'alt 45° — 140° from Moon — 183%'},
    {id:'M33', name:'Triangulum Galaxy', note:'alt 46° — 145° from Moon — 175%'},
    {id:'M57', name:'Ring Nebula', note:'alt 44° — 115% from Moon — 155%'},
    {id:'M13', name:'Hercules Globular', note:'alt 24° — 90° from Moon — 120%'},
  ];
  top5List.innerHTML = items.map((x,i)=>`<li><b>${x.id}</b> — ${x.name} — ${x.note}</li>`).join('');
}

/* ========= Catalog (subset) ========= */
const GIT_BASE = 'https://raw.githubusercontent.com/jlevick82/Astrotarget/main/images/full/';
const cat = [
  {id:'M31', name:'Andromeda Galaxy', type:'GX', ra:'0.71h', dec:'41.3°', img:'m31.jpg' },
  {id:'M33', name:'Triangulum Galaxy', type:'GX', ra:'1.55h', dec:'30.7°', img:'m33.jpg' },
  {id:'M27', name:'Dumbbell Nebula', type:'PN', ra:'19.89h', dec:'22.7°', img:'m27.jpg' },
  {id:'M57', name:'Ring Nebula', type:'PN', ra:'18.89h', dec:'33.0°', img:'m57.jpg' },
  {id:'M13', name:'Hercules Globular', type:'GC', ra:'16.70h', dec:'36.5°', img:'m13.jpg' },
];
function renderCatalog(){
  catalogBody.innerHTML = cat.map(row=>{
    const url = GIT_BASE + row.img;
    return `<tr>
      <td>${row.name}</td>
      <td>${row.type}</td>
      <td>${row.ra}</td>
      <td>${row.dec}</td>
      <td><img class="thumb" src="${url}" alt="${row.name}" data-full="${url}"></td>
    </tr>`;
  }).join('');
  // modal wiring
  $$('#catalogBody .thumb').forEach(img=>{
    img.addEventListener('click', ()=>{
      $('#modalImg').src = img.dataset.full;
      $('#imgModal').classList.add('open');
    });
  });
}
$('#imgModal').addEventListener('click', ()=>$('#imgModal').classList.remove('open'));

/* ========= Init ========= */
(function init(){
  syncLatLonUI();
  syncCloudsUI();
  renderTop5();
  renderCatalog();
  computeSky();
  setInterval(computeSky, 5*60*1000); // keep "now" fresh
})();
</script>
</body>
</html>
