<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nightly Go/No-Go</title>
<link rel="icon" href="favicon.ico" />
<style>
  :root{
    --bg:#0e1a24;
    --bg2:#0f2332;
    --card:#10283b;
    --text:#d9e6f2;
    --muted:#9fb3c6;
    --good:#1dd675;
    --warn:#f5b94a;
    --bad:#ff6b6b;
    --chip:#123147;
    --chipText:#cfe6fb;
    --ring:#2d5b7a;
    --shadow:0 8px 30px rgba(0,0,0,.35);
    --radius:22px;
  }
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1200px 900px at 0 -200px, #14314a 0%, #0e1a24 45%, #0a1420 100%);
    color:var(--text);
    font: 16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
  }
  .wrap{max-width:980px;margin:28px auto;padding:0 16px}
  h1{font-size:44px;line-height:1.05;margin:0 0 10px}
  .ver{opacity:.6;font-size:14px;margin:0 0 18px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .btn{
    background:linear-gradient(180deg,#1a3d56,#122c40);
    color:var(--text);
    border:1px solid #214a66;
    padding:10px 16px;border-radius:999px;box-shadow:var(--shadow);
  }
  .card{
    background:linear-gradient(180deg,#0f2536,#0c1c2a);
    border:1px solid #1f3f56;
    border-radius:var(--radius);
    box-shadow: var(--shadow);
    padding:14px 16px;
  }
  .status{position:relative;overflow:hidden}
  .status .pill{
    width:58px;height:58px;border-radius:18px;
    display:grid;place-items:center;margin-right:12px;
    border:2px solid #1c4f33;background:#092015; color:#caffdf; font-weight:800;
    box-shadow: inset 0 0 0 2px #0e2c1d, 0 5px 16px rgba(0,0,0,.4);
  }
  .status .hdr{display:flex;align-items:center}
  .titleLine{font-size:22px;font-weight:800;letter-spacing:.2px}
  .subtitle{opacity:.85;margin-top:6px}
  .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .chip{
    background:var(--chip);
    color:var(--chipText);
    border:1px solid #1f4863;
    border-radius:999px;
    padding:8px 12px;font-weight:600
  }
  .chip.time{opacity:.9}
  .sectionHdr{font-size:28px;margin:18px 0 8px}
  .collapser{position:absolute;right:12px;top:12px}
  .chev{
    width:40px;height:40px;border-radius:12px;border:1px solid #2a516b;background:#10283b; color:#cfe6fb;
    display:grid;place-items:center;cursor:pointer
  }
  .grid4{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .tile{background:#0f2536;border:1px solid #1f3f56;border-radius:16px;padding:14px}
  .k{font-size:14px;color:var(--muted);margin-bottom:6px}
  .v{font-size:28px;font-weight:800}
  .minor{margin-top:6px;opacity:.8}
  .tile.bad .v{color:var(--bad)}
  .tile.ok .v{color:var(--warn)}
  .tile.good .v{color:var(--good)}
  .sliderRow{display:flex;align-items:center;gap:12px;margin-top:10px}
  input[type=range]{width:100%}
  .actions{display:flex;gap:12px;margin-top:10px}
  .subtle{margin-top:10px;color:var(--muted)}
  .table{width:100%;border-spacing:0;border-collapse:separate;margin-top:12px}
  .table th,.table td{padding:12px;border-bottom:1px solid #1f3f56}
  .table th{color:var(--muted);text-align:left;font-weight:600}
  .thumb{
    width:72px;height:72px;border-radius:12px;overflow:hidden;display:block;border:1px solid #274a63; background:#050b12;
  }
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  /* Lightbox */
  .lightbox{
    position:fixed;inset:0;background:rgba(0,0,0,.88);
    display:none;align-items:center;justify-content:center;z-index:9999;
  }
  .lightbox.open{display:flex}
  .lightbox img{max-width:100vw;max-height:100vh;object-fit:contain;border-radius:6px}
  .lightbox .close{position:fixed;top:14px;right:14px;background:rgba(0,0,0,.5);border:1px solid #3c6b8c;border-radius:10px;padding:8px 10px;color:#d7f0ff}

  /* Mobile tweaks */
  @media (max-width:680px){
    h1{font-size:36px}
    .status{padding:12px}
    .status .pill{width:52px;height:52px;border-radius:16px;margin-right:10px}
    .titleLine{font-size:19px}
    .chips{gap:8px}
    .chip{padding:7px 11px}
    .grid4{gap:10px}
    .tile{padding:12px;border-radius:14px}
    .v{font-size:24px}
    .chev{width:34px;height:34px;border-radius:10px}
    .sectionHdr{font-size:24px}
    /* shorten Updated chip on small screens */
    .chip.time[data-timeonly]{white-space:nowrap}
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Nightly<br/>Go/No-Go</h1>
    <div class="ver">v26.5</div>

    <!-- STATUS -->
    <section class="card status" id="statusCard">
      <div class="collapser"><button class="chev" data-toggle="status">&#x25BC;</button></div>
      <div class="hdr">
        <div class="pill" id="goBadge">GO</div>
        <div>
          <div class="titleLine" id="statusLine">GO · Clouds ~8% · Vis 18 km · Astro dark</div>
          <div class="subtitle">Observing recommendation</div>
        </div>
      </div>
      <div class="chips" id="statusChips">
        <div class="chip time" id="updatedChip">Updated 3:09:44 AM</div>
        <div class="chip" id="sunChip">Sun alt -44°</div>
        <div class="chip" id="moonChip">Moon 7%</div>
        <div class="chip" id="altChip">Alt -29°</div>
      </div>
    </section>

    <!-- SKY -->
    <section class="card" id="skyCard" style="margin-top:18px; position:relative;">
      <div class="collapser"><button class="chev" data-toggle="sky">&#x25BC;</button></div>
      <div class="sectionHdr">Sky</div>
      <div class="grid4" id="skyGrid">
        <div class="tile" id="tile-dark">
          <div class="k">Astronomical dark</div>
          <div class="v" id="darkV">Yes</div>
          <div class="minor" id="darkMinor">Sun alt -44°</div>
        </div>
        <div class="tile" id="tile-moon">
          <div class="k">Moon illum</div>
          <div class="v" id="moonV">7%</div>
          <div class="minor" id="moonMinor">Alt -29°</div>
        </div>
        <div class="tile" id="tile-hum">
          <div class="k">Humidity</div>
          <div class="v" id="humV">91%</div>
        </div>
        <div class="tile ok" id="tile-transp">
          <div class="k">Transparency</div>
          <div class="v" id="transpV">Bad</div>
        </div>
      </div>
    </section>

    <!-- CLOUDS -->
    <section class="card" id="cloudCard" style="margin-top:14px; position:relative;">
      <div class="collapser"><button class="chev" data-toggle="clouds">&#x25BC;</button></div>
      <div class="sectionHdr">Clouds (avg)</div>
      <div id="cloudsBody">
        <div class="sliderRow">
          <input type="range" min="0" max="100" value="8" id="cloudSlider" />
          <span id="cloudPct" style="font-weight:800;min-width:52px;display:inline-block;text-align:right">8%</span>
        </div>
        <div class="actions">
          <button class="btn" id="btnUse">Use</button>
          <button class="btn" id="btnCalc">Calculate</button>
        </div>
        <div class="subtle" id="cloudSource">From Open-Meteo (hourly) • slider overrides</div>
      </div>
    </section>

    <!-- QUICK SETUP (minimal for this build) -->
    <section class="card" id="qsCard" style="margin-top:14px; position:relative;">
      <div class="collapser"><button class="chev" data-toggle="qs">&#x25BC;</button></div>
      <div class="sectionHdr">Quick setup</div>
      <div class="row">
        <div class="tile" style="flex:1 1 180px">
          <div class="k">Latitude (°)</div>
          <input id="lat" class="btn" style="width:100%;text-align:left" value="37.16557" />
        </div>
        <div class="tile" style="flex:1 1 180px">
          <div class="k">Longitude (°)</div>
          <input id="lon" class="btn" style="width:100%;text-align:left" value="-76.5684" />
        </div>
        <div class="tile" style="flex:0 0 180px">
          <div class="k">&nbsp;</div>
          <div class="actions">
            <button class="btn" id="btnGPS">Use GPS</button>
            <button class="btn" id="btnNow">Calculate Now</button>
          </div>
        </div>
      </div>
    </section>

    <!-- TOP 5 -->
    <section class="card" id="top5Card" style="margin-top:14px; position:relative;">
      <div class="collapser"><button class="chev" data-toggle="top5">&#x25BC;</button></div>
      <div class="sectionHdr">Top 5 Recommendations</div>
      <div id="top5List" class="tile">
        <ol id="top5">
          <li><b>M27</b> — Dumbbell Nebula — alt 82° — 142° from Moon — 196%</li>
          <li><b>M31</b> — Andromeda Galaxy — alt 45° — 140° from Moon — 183%</li>
          <li><b>M33</b> — Triangulum Galaxy — alt 46° — 145° from Moon — 175%</li>
          <li><b>M57</b> — Ring Nebula — alt 44° — 115° from Moon — 155%</li>
          <li><b>M13</b> — Hercules Globular — alt 24° — 90° from Moon — 120%</li>
        </ol>
      </div>
    </section>

    <!-- CATALOG (subset) -->
    <section class="card" id="catCard" style="margin-top:14px; position:relative;">
      <div class="collapser"><button class="chev" data-toggle="cat">&#x25BC;</button></div>
      <div class="sectionHdr">Catalog (subset)</div>
      <table class="table" id="catTable">
        <thead>
          <tr>
            <th style="width:95px">ID</th>
            <th>Name</th>
            <th style="width:70px">Type</th>
            <th style="width:80px">RA</th>
            <th style="width:80px">Dec</th>
            <th style="width:90px">Image</th>
          </tr>
        </thead>
        <tbody id="catBody"><!-- rows injected --></tbody>
      </table>
    </section>

    <div style="height:46px"></div>
  </div>

  <!-- LIGHTBOX -->
  <div class="lightbox" id="lightbox">
    <button class="close" id="closeLb">Close ×</button>
    <img id="lbImg" alt="preview"/>
  </div>

<script>
(function(){
  const $ = (sel, p=document) => p.querySelector(sel);
  const $$ = (sel, p=document) => [...p.querySelectorAll(sel)];

  // --- Status "Updated" chip -> shorten on mobile ---
  function setUpdated(){
    const chip = $('#updatedChip');
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    const time = `${((d.getHours()+11)%12)+1}:${pad(d.getMinutes())}:${pad(d.getSeconds())} ${d.getHours()<12?'AM':'PM'}`;
    if (window.matchMedia('(max-width:680px)').matches){
      chip.textContent = time;
      chip.dataset.timeonly = "1";
    } else {
      chip.textContent = `Updated ${time}`;
      delete chip.dataset.timeonly;
    }
  }
  setUpdated(); window.addEventListener('resize', setUpdated);

  // --- Collapsers ---
  const sections = {
    status: $('#statusCard'),
    sky: $('#skyCard'),
    clouds: $('#cloudCard'),
    qs: $('#qsCard'),
    top5: $('#top5Card'),
    cat: $('#catCard'),
  };
  $$('[data-toggle]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const k = btn.getAttribute('data-toggle');
      sections[k].classList.toggle('collapsed');
      // simple collapse: toggle display of the section body except header
      if(k==='status'){
        const chips = $('#statusChips');
        chips.style.display = chips.style.display==='none' ? '' : 'none';
      }else if(k==='sky'){
        const g = $('#skyGrid');
        g.style.display = g.style.display==='none' ? '' : 'grid';
      }else if(k==='clouds'){
        const b = $('#cloudsBody');
        b.style.display = b.style.display==='none' ? '' : '';
      }else if(k==='qs'){
        const tiles = $('#qsCard .row');
        tiles.style.display = tiles.style.display==='none' ? '' : 'none';
      }else if(k==='top5'){
        const tl = $('#top5List');
        tl.style.display = tl.style.display==='none' ? '' : 'none';
      }else if(k==='cat'){
        const t = $('#catTable');
        t.style.display = t.style.display==='none' ? '' : 'table';
      }
      btn.innerHTML = (btn.innerHTML==='&#x25BC;') ? '&#x25B2;' : '&#x25BC;';
    });
  });

  // --- Cloud slider + Use / Calculate ---
  const slider = $('#cloudSlider');
  const pct = $('#cloudPct');
  slider.addEventListener('input', ()=>{ pct.textContent = slider.value + '%'; });
  $('#btnUse').addEventListener('click', ()=>{
    toast(`Targets updated · clouds ${slider.value}%`);
  });
  $('#btnCalc').addEventListener('click', async ()=>{
    const lat = parseFloat($('#lat').value), lon = parseFloat($('#lon').value);
    try{
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=cloud_cover&forecast_days=1&timezone=auto`;
      const res = await fetch(url); const data = await res.json();
      const now = new Date();
      // Pick nearest hour
      const i = data.hourly.time.findIndex(t => t.startsWith(now.toISOString().slice(0,13)));
      let val = (i>=0 ? data.hourly.cloud_cover[i] : data.hourly.cloud_cover[0])|0;
      slider.value = val; pct.textContent = val + '%';
      $('#cloudSource').textContent = 'From Open-Meteo (hourly) • slider overrides';
      toast(`Targets updated · clouds ${val}%`);
    }catch(e){
      toast('Weather fetch failed');
    }
  });

  // --- GPS quick set (best-effort) ---
  $('#btnGPS').addEventListener('click', ()=>{
    if (!navigator.geolocation){ return toast('GPS not available'); }
    navigator.geolocation.getCurrentPosition(p=>{
      $('#lat').value = p.coords.latitude.toFixed(5);
      $('#lon').value = p.coords.longitude.toFixed(5);
      toast('Location set from GPS');
    }, _=>toast('GPS denied'));
  });
  $('#btnNow').addEventListener('click', ()=>toast('Targets updated'));

  // --- Tiny toast ---
  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.cssText = `
      position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
      background:#10283b;border:1px solid #2b5a78;color:#d9f0ff;
      padding:10px 14px;border-radius:12px;box-shadow:${getComputedStyle(document.documentElement).getPropertyValue('--shadow')};
      z-index:9999;opacity:0;transition:opacity .2s, transform .2s;`;
    document.body.appendChild(t);
    requestAnimationFrame(()=>{ t.style.opacity='1'; t.style.transform='translateX(-50%) translateY(-4px)'; });
    setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateX(-50%) translateY(0)'; }, 1500);
    setTimeout(()=>t.remove(), 1900);
  }

  // --- Catalog subset with full-res viewer ---
  const GH_FULL = 'https://raw.githubusercontent.com/jlevick82/Astrotarget/main/images/full/';
  const rows = [
    {id:'M31', name:'Andromeda Galaxy', type:'GX', ra:'0.71h', dec:'41.3°', file:'m31.jpg'},
    {id:'M33', name:'Triangulum Galaxy', type:'GX', ra:'1.55h', dec:'30.7°', file:'m33.jpg'},
    {id:'M27', name:'Dumbbell Nebula', type:'PN', ra:'19.89h', dec:'22.7°', file:'m27.jpg'},
    {id:'M57', name:'Ring Nebula', type:'PN', ra:'18.89h', dec:'33.0°', file:'m57.jpg'},
    {id:'M13', name:'Hercules Globular', type:'GC', ra:'16.70h', dec:'36.5°', file:'m13.jpg'},
    {id:'M45', name:'Pleiades', type:'OC', ra:'3.79h', dec:'24.1°', file:'m45.jpg'},
  ];
  const body = $('#catBody');
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><b>${r.id}</b></td>
      <td>${r.name}</td>
      <td>${r.type}</td>
      <td>${r.ra}</td>
      <td>${r.dec}</td>
      <td>
        <a class="thumb" href="#" data-full="${GH_FULL}${r.file}" title="Open full image">
          <img loading="lazy" src="${GH_FULL}${r.file}" alt="${r.id}">
        </a>
      </td>`;
    body.appendChild(tr);
  });

  // Lightbox logic
  const lb = $('#lightbox'), lbImg = $('#lbImg');
  body.addEventListener('click', e=>{
    const a = e.target.closest('a.thumb');
    if(!a) return;
    e.preventDefault();
    const full = a.getAttribute('data-full') || a.querySelector('img').src;
    lbImg.src = full;
    lb.classList.add('open');
  });
  function closeLb(){ lb.classList.remove('open'); lbImg.removeAttribute('src'); }
  $('#closeLb').addEventListener('click', closeLb);
  lb.addEventListener('click', (e)=>{ if(e.target===lb) closeLb(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeLb(); });

})();
</script>
</body>
</html>
